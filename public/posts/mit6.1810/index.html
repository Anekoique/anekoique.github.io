<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>MIT6.1810 Labç®€è®° | Anekoique&#39;s Blog</title>
<meta name="keywords" content="OS">
<meta name="description" content="the course is the new version of 6.828 and 6.s081ï¼ˆ24 fallï¼‰

  
    
    IMPORTANT
  
  
    æˆ‘ä»¬å·²ç»åœ¨ä½ å­¦é•¿å­¦å§çš„å®éªŒæŠ¥å‘Šä¸­å¤šæ¬¡çœ‹åˆ°ç±»ä¼¼çš„æ‚”æ¨: å› ä¸ºæ²¡æœ‰åŠæ—¶è®°å½•å®éªŒå¿ƒå¾—è€Œåœ¨ç¼–å†™å®éªŒæŠ¥å‘Šçš„æ—¶å€™å¿˜è®°äº†è‡ªå·±ç»å†è¶£äº‹çš„ç»†èŠ‚. ä¸ºäº†å’ŒåŠ©æ•™ä»¬åˆ†äº«ä½ çš„å„ç§å®éªŒç»å†, æˆ‘ä»¬å»ºè®®ä½ åœ¨å®éªŒè¿‡ç¨‹ä¸­éšæ—¶è®°å½•å®éªŒå¿ƒå¾—, æ¯”å¦‚è‡ªå·±è¸©è¿‡çš„å¤§å‘, æˆ–è€…æ˜¯è°ƒäº†ä¸€å‘¨ä¹‹åæ‰å‘ç°çš„ä¸€ä¸ªå¼±æ™ºbug, ç­‰ç­‰.">
<meta name="author" content="Anekoique">
<link rel="canonical" href="http://localhost:1313/posts/mit6.1810/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/img/head.jpg">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/img/head.jpg">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/img/head.jpg">
<link rel="apple-touch-icon" href="http://localhost:1313/img/head.jpg">
<link rel="mask-icon" href="http://localhost:1313/img/head.jpg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/mit6.1810/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><script src="http://localhost:1313/js/toc-sidebar.js" defer></script><meta property="og:url" content="http://localhost:1313/posts/mit6.1810/">
  <meta property="og:site_name" content="Anekoique&#39;s Blog">
  <meta property="og:title" content="MIT6.1810 Labç®€è®°">
  <meta property="og:description" content="the course is the new version of 6.828 and 6.s081ï¼ˆ24 fallï¼‰
IMPORTANT æˆ‘ä»¬å·²ç»åœ¨ä½ å­¦é•¿å­¦å§çš„å®éªŒæŠ¥å‘Šä¸­å¤šæ¬¡çœ‹åˆ°ç±»ä¼¼çš„æ‚”æ¨: å› ä¸ºæ²¡æœ‰åŠæ—¶è®°å½•å®éªŒå¿ƒå¾—è€Œåœ¨ç¼–å†™å®éªŒæŠ¥å‘Šçš„æ—¶å€™å¿˜è®°äº†è‡ªå·±ç»å†è¶£äº‹çš„ç»†èŠ‚. ä¸ºäº†å’ŒåŠ©æ•™ä»¬åˆ†äº«ä½ çš„å„ç§å®éªŒç»å†, æˆ‘ä»¬å»ºè®®ä½ åœ¨å®éªŒè¿‡ç¨‹ä¸­éšæ—¶è®°å½•å®éªŒå¿ƒå¾—, æ¯”å¦‚è‡ªå·±è¸©è¿‡çš„å¤§å‘, æˆ–è€…æ˜¯è°ƒäº†ä¸€å‘¨ä¹‹åæ‰å‘ç°çš„ä¸€ä¸ªå¼±æ™ºbug, ç­‰ç­‰.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-08-27T11:00:00+08:00">
    <meta property="article:modified_time" content="2025-08-27T11:00:00+08:00">
    <meta property="article:tag" content="OS">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MIT6.1810 Labç®€è®°">
<meta name="twitter:description" content="the course is the new version of 6.828 and 6.s081ï¼ˆ24 fallï¼‰

  
    
    IMPORTANT
  
  
    æˆ‘ä»¬å·²ç»åœ¨ä½ å­¦é•¿å­¦å§çš„å®éªŒæŠ¥å‘Šä¸­å¤šæ¬¡çœ‹åˆ°ç±»ä¼¼çš„æ‚”æ¨: å› ä¸ºæ²¡æœ‰åŠæ—¶è®°å½•å®éªŒå¿ƒå¾—è€Œåœ¨ç¼–å†™å®éªŒæŠ¥å‘Šçš„æ—¶å€™å¿˜è®°äº†è‡ªå·±ç»å†è¶£äº‹çš„ç»†èŠ‚. ä¸ºäº†å’ŒåŠ©æ•™ä»¬åˆ†äº«ä½ çš„å„ç§å®éªŒç»å†, æˆ‘ä»¬å»ºè®®ä½ åœ¨å®éªŒè¿‡ç¨‹ä¸­éšæ—¶è®°å½•å®éªŒå¿ƒå¾—, æ¯”å¦‚è‡ªå·±è¸©è¿‡çš„å¤§å‘, æˆ–è€…æ˜¯è°ƒäº†ä¸€å‘¨ä¹‹åæ‰å‘ç°çš„ä¸€ä¸ªå¼±æ™ºbug, ç­‰ç­‰.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "MIT6.1810 Labç®€è®°",
      "item": "http://localhost:1313/posts/mit6.1810/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "MIT6.1810 Labç®€è®°",
  "name": "MIT6.1810 Labç®€è®°",
  "description": "the course is the new version of 6.828 and 6.s081ï¼ˆ24 fallï¼‰\nIMPORTANT æˆ‘ä»¬å·²ç»åœ¨ä½ å­¦é•¿å­¦å§çš„å®éªŒæŠ¥å‘Šä¸­å¤šæ¬¡çœ‹åˆ°ç±»ä¼¼çš„æ‚”æ¨: å› ä¸ºæ²¡æœ‰åŠæ—¶è®°å½•å®éªŒå¿ƒå¾—è€Œåœ¨ç¼–å†™å®éªŒæŠ¥å‘Šçš„æ—¶å€™å¿˜è®°äº†è‡ªå·±ç»å†è¶£äº‹çš„ç»†èŠ‚. ä¸ºäº†å’ŒåŠ©æ•™ä»¬åˆ†äº«ä½ çš„å„ç§å®éªŒç»å†, æˆ‘ä»¬å»ºè®®ä½ åœ¨å®éªŒè¿‡ç¨‹ä¸­éšæ—¶è®°å½•å®éªŒå¿ƒå¾—, æ¯”å¦‚è‡ªå·±è¸©è¿‡çš„å¤§å‘, æˆ–è€…æ˜¯è°ƒäº†ä¸€å‘¨ä¹‹åæ‰å‘ç°çš„ä¸€ä¸ªå¼±æ™ºbug, ç­‰ç­‰.\n",
  "keywords": [
    "OS"
  ],
  "articleBody": "the course is the new version of 6.828 and 6.s081ï¼ˆ24 fallï¼‰\nIMPORTANT æˆ‘ä»¬å·²ç»åœ¨ä½ å­¦é•¿å­¦å§çš„å®éªŒæŠ¥å‘Šä¸­å¤šæ¬¡çœ‹åˆ°ç±»ä¼¼çš„æ‚”æ¨: å› ä¸ºæ²¡æœ‰åŠæ—¶è®°å½•å®éªŒå¿ƒå¾—è€Œåœ¨ç¼–å†™å®éªŒæŠ¥å‘Šçš„æ—¶å€™å¿˜è®°äº†è‡ªå·±ç»å†è¶£äº‹çš„ç»†èŠ‚. ä¸ºäº†å’ŒåŠ©æ•™ä»¬åˆ†äº«ä½ çš„å„ç§å®éªŒç»å†, æˆ‘ä»¬å»ºè®®ä½ åœ¨å®éªŒè¿‡ç¨‹ä¸­éšæ—¶è®°å½•å®éªŒå¿ƒå¾—, æ¯”å¦‚è‡ªå·±è¸©è¿‡çš„å¤§å‘, æˆ–è€…æ˜¯è°ƒäº†ä¸€å‘¨ä¹‹åæ‰å‘ç°çš„ä¸€ä¸ªå¼±æ™ºbug, ç­‰ç­‰.\næˆ‘ä»¬ç›¸ä¿¡, å½“ä½ åšå®ŒPAå›è¿‡å¤´æ¥é˜…è¯»è¿™äº›å¿ƒå¾—çš„æ—¶å€™, å°±ä¼šå‘ç°è¿™å¯¹ä½ æ¥è¯´æ˜¯ä¸€ç¬”å®è´µçš„è´¢å¯Œ.\nåœ¨åšPAçš„æ—¶å€™å¿½ç•¥äº†è¿™ä¸€æé†’ï¼Œå› ä¸ºæ²¡æœ‰åŠæ—¶è®°å½•å®éªŒå¿ƒå¾—è€Œå¿˜è®°äº†è‡ªå·±ç»å†è¶£äº‹çš„ç»†èŠ‚ ğŸ˜­æ‰€ä»¥ç‰¢è®°æ•™è®­ç®€å•è®°å½•Labçš„å®Œæˆè¿‡ç¨‹\nLab1. Util Lab2. Syscall 1. debug \u0026 gdb some useful debugging tips and tools\nbacktrace(bt)\nframe [num/up/down] info locals/args kernel/kernel.asm\naddr2line\nscript\nqemu monitor [ctrl-a-c]\n2. strace The entire system call process\n3. attack ç›®å‰æœ€éš¾çš„éƒ¨åˆ†ï¼Œä¸åˆç†çš„æ˜¯å®ƒæŠŠè¿™ä¸ªlabæ”¾åœ¨é¡µè¡¨ä¹‹å‰ï¼Œå¦‚æœæ²¡çœ‹è¿‡é¡µè¡¨è¿™é‡Œè‚¯å®šåšä¸å‡ºæ¥ï¼›ä½†åˆç†çš„æ˜¯é¡µè¡¨åªæ¶‰åŠæœ€åŸºæœ¬çš„ï¼Œæ›´ä¸»è¦çš„éƒ¨åˆ†æ˜¯system callå’Œé¡µè¡¨çš„ç»“åˆã€‚\nè¿™ä¸ªlabçš„ç²¾å·§ä¹‹å¤„åœ¨äºå°†attack xv6ä½œä¸ºå¼•å­ï¼Œé€šè¿‡ä¸è™šæ‹Ÿå†…å­˜ç›¸å…³çŸ¥è¯†ä¸²èµ·äº†fork exec sbrkç­‰sysctem callï¼Œå¯ä»¥åŸºæœ¬äº†è§£xv6çš„è™šæ‹Ÿå†…å­˜ç®¡ç†ã€ç”¨æˆ·è¿›ç¨‹å†…å­˜çš„æ’å¸ƒä»¥åŠå’Œkernelçš„äº¤äº’ã€‚\nç”¨æˆ·è¿›ç¨‹å¤„æ¶‰åŠåˆ°äº†ä¸»è¦ä¸‰ä¸ªæ–‡ä»¶attacktest.c,attack.c,secret.c\nattacktest.c å…ˆä½¿ç”¨forkåˆ›å»ºæ–°è¿›ç¨‹ï¼Œå¹¶é€šè¿‡execç³»ç»Ÿè°ƒç”¨æ‰§è¡Œsecret.cå†™å…¥ç§˜å¯†\nå…ˆä½¿ç”¨forkåˆ›å»ºæ–°è¿›ç¨‹ï¼Œå¹¶é€šè¿‡execç³»ç»Ÿè°ƒç”¨æ‰§è¡Œsecret.cå†™å…¥ç§˜å¯† å†ä½¿ç”¨forkåˆ›å»ºæ–°è¿›ç¨‹ï¼Œå¹¶é€šè¿‡execç³»ç»Ÿè°ƒç”¨æ‰§è¡Œattack.cæ‰¾åˆ°å…ˆå‰åœ¨å†…å­˜å†™å…¥çš„ç§˜å¯†\nå†ä½¿ç”¨forkåˆ›å»ºæ–°è¿›ç¨‹ï¼Œå¹¶é€šè¿‡execç³»ç»Ÿè°ƒç”¨æ‰§è¡Œattack.cæ‰¾åˆ°å…ˆå‰åœ¨å†…å­˜å†™å…¥çš„ç§˜å¯† secret.c ä½¿ç”¨sbrkç³»ç»Ÿè°ƒç”¨ç”³è¯·å†…å­˜ç©ºé—´åï¼Œé€šè¿‡endåœ¨å†…å­˜å†™å…¥ç§˜å¯†ï¼Œå†™å…¥çš„ä½ç½®åœ¨ç”³è¯·çš„ä½ç½®ä¹‹å PGSIZE*9+32 å¤„\nä½¿ç”¨sbrkç³»ç»Ÿè°ƒç”¨ç”³è¯·å†…å­˜ç©ºé—´åï¼Œé€šè¿‡endåœ¨å†…å­˜å†™å…¥ç§˜å¯† attack.c éœ€è¦åœ¨attack.cæ‰¾åˆ°ä¹‹å‰å†™å…¥çš„ç§˜å¯†è¿›è¡Œattackï¼Œå…³é”®åœ¨ç†æ¸…xv6å¯¹è™šæ‹Ÿå†…å­˜çš„ç®¡ç†åˆ†é…å¹¶åœ¨è¿™ä¸ªæ–°è¿›ç¨‹æ‰¾åˆ°ä¹‹å‰å†™å…¥çš„ç‰©ç†å†…å­˜é¡µ\néœ€è¦åœ¨attack.cæ‰¾åˆ°ä¹‹å‰å†™å…¥çš„ç§˜å¯†è¿›è¡Œattack xv6å†…å­˜ç®¡ç† attacktest.cè¿è¡Œsecret.cå’Œsh.cè¿è¡Œattacktest.cä¸€æ ·éƒ½æ˜¯é€šè¿‡forkå’Œexecæ¥æ‰§è¡Œä¸€ä¸ªæ–°çš„ç¨‹åº\nè¿™é‡Œä»¥å»ºç«‹secret.cä¸ºä¾‹ï¼Œä»ç³»ç»Ÿè°ƒç”¨æ¥çœ‹xv6çš„å†…å­˜ç®¡ç†\nfork forkæ¶‰åŠåˆ°çš„å†…å­˜åˆ†é…ä¸»è¦æ˜¯allocprocå’Œuvmcopy\nallocprocä¸ºè¿›ç¨‹åˆ†é…ç‰©ç†å†…å­˜å¹¶å»ºç«‹é¡µè¡¨æ˜ å°„ allocprocä¸ºå…ˆä¸ºè¿›ç¨‹åˆ†é…ç‰©ç†å†…å­˜å¹¶å»ºç«‹é¡µè¡¨æ˜ å°„ï¼Œä¸€å…±åˆ†é…äº†å››é¡µï¼Œallocprocåå®ç°äº†æ“ä½œç³»ç»Ÿç®¡ç†è¿›ç¨‹çš„ä¸€ä¸ªé¡µè¡¨ï¼Œé¡µè¡¨ç®¡ç†äº†è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜æ˜ å°„\nï¼ˆç›®å‰æ˜ å°„äº†trapolineï¼ˆè™šæ‹Ÿå†…å­˜åœ°å€æœ€å¤§å¤„ï¼‰å’Œtrapframeï¼ˆtraponineä¹‹ä¸‹ï¼‰ï¼‰\ntrapframeä¸€é¡µ pagetableä¸€é¡µ ï¼ˆproc_pagetableä¸­uvmcreateå‡½æ•°åˆ†é…ï¼‰ å®¹æ˜“é—å¿˜çš„æ˜¯xv6è¿è¡Œåœ¨Sv39 RISC-Vä¸Š,ä½¿ç”¨ä¸‰çº§é¡µè¡¨ï¼Œåœ¨å»ºç«‹trapolineå’Œtrapframeçš„è™šæ‹Ÿå†…å­˜æ˜ å°„æ—¶éœ€è¦åˆ†é…ä¸¤ä¸ªç‰©ç†å†…å­˜é¡µç”¨ä½œé¡µç›®å½• xv6è¿è¡Œåœ¨Sv39 RISC-Vä¸Šï¼Œä½¿ç”¨ä¸‰çº§é¡µè¡¨ uvmcopyç»™å®šçˆ¶è¿›ç¨‹çš„é¡µè¡¨ï¼Œå°†å…¶å†…å­˜å¤åˆ¶åˆ°å­è¿›ç¨‹çš„é¡µè¡¨ä¸­ã€‚ï¼ˆçˆ¶è¿›ç¨‹åˆ†é…äº†å¤šå°‘ç‰©ç†é¡µï¼Œå­è¿›ç¨‹ä¹Ÿåˆ†é…åŒæ ·å¤§å°å¹¶å¤åˆ¶ï¼Œå¹¶åœ¨è™šæ‹Ÿå†…å­˜æœ€ä½å¤„å»ºç«‹æ˜ å°„ï¼‰è¿™é‡Œåˆ†é…äº†6é¡µï¼ˆå››é¡µç‰©ç†å†…å­˜å¤åˆ¶ï¼Œä¸¤é¡µç”¨ä½œé¡µç›®å½•ï¼‰\nuvmcopyç»™å®šçˆ¶è¿›ç¨‹çš„é¡µè¡¨ï¼Œå°†å…¶å†…å­˜å¤åˆ¶åˆ°å­è¿›ç¨‹ exec execè¦åšçš„å°±æ˜¯è½½å…¥elfæ–‡ä»¶å¹¶æ‰§è¡Œ\nåœ¨execçš„å®ç°ä¸­ï¼Œä¼šä½¿ç”¨proc_pagetableåˆ›å»ºæ–°çš„é¡µè¡¨æ¥æ›¿æ¢æ—§é¡µè¡¨ï¼ˆexecä½œç”¨å°±æ˜¯æ›¿æ¢æ•´ä¸ªç¨‹åºé•œåƒï¼Œç›¸å½“äºä»å¤´å¼€å§‹æ‰§è¡Œä¸€ä¸ªæ–°çš„ç¨‹åºï¼Œä¹‹å‰ç¨‹åºçš„ç›¸å…³å†…å®¹å…¨éƒ¨ä¸¢å¼ƒï¼‰proc_pagetableä¼šåˆ†é…3é¡µ\næ¥ç€ï¼Œexecéå†elfæ–‡ä»¶çš„program headerï¼Œå°†LOADæ®µåŠ è½½è¿›å†…å­˜ä¸­ã€‚å…·ä½“æ˜¯é€šè¿‡uvmallocåˆ†é…ç‰©ç†å†…å­˜ï¼Œloadsegå°†æ®µåŠ è½½è¿›å†…å­˜ã€‚xv6ç¨‹åºçš„elfæ–‡ä»¶åŒ…å«ä¸¤ä¸ªLOADæ®µï¼Œdataæ®µå’Œtextæ®µï¼Œå¯ä»¥é€šè¿‡readelfçœ‹ä¸€ä¸‹.è¿™ä¸¤ä¸ªæ®µåˆ†åˆ«åŠ è½½åˆ°è™šæ‹Ÿå†…å­˜çš„ç¬¬0é¡µå’Œç¬¬1é¡µä¸­ã€‚åŒç†ï¼Œè¿™ä¸¤é¡µå±äºä½åœ°å€çš„ç”¨æˆ·å†…å­˜ï¼Œéœ€è¦4é¡µï¼ˆ2é¡µç›®å½•+2é¡µç‰©ç†é¡µï¼‰æ¥åˆ†åˆ«å­˜æ”¾è¿™ä¸¤ä¸ªæ®µ\nexecéå†elfæ–‡ä»¶çš„program headerï¼Œå°†LOADæ®µåŠ è½½è¿›å†…å­˜ å¦å¤–è¿˜ç”¨ä¸ºç”¨æˆ·å †æ ˆåˆ†é…å†…å­˜ï¼Œç¬¬ä¸€ä¸ªé¡µé¢ä½œä¸ºå †æ ˆä¿æŠ¤è€Œä¸å¯è®¿é—®ï¼Œå…¶ä½™é¡µé¢ç”¨ä½œç”¨æˆ·å †æ ˆ.è¿™é‡Œåˆ†é…2é¡µ\nä¸ºç”¨æˆ·å †æ ˆåˆ†é…å†…å­˜ï¼Œç¬¬ä¸€ä¸ªé¡µé¢ä½œä¸ºå †æ ˆä¿æŠ¤ execç»“æŸåéœ€è¦é‡Šæ”¾æ—§é¡µè¡¨å’Œæ—§ç”¨æˆ·å†…å­˜ï¼Œå…¶ä¸­çš„ä¸¤ä¸ªuvmunmapé‡Šæ”¾pteæ˜ å°„ï¼ˆé¿å…åç»­uvmfreeçš„æ—¶å€™æ„å¤–é‡Šæ”¾trampolineå’Œtrapframeçš„ç‰©ç†å†…å­˜ï¼‰ï¼Œå¹¶ä¸é‡Šæ”¾ç‰©ç†é¡µï¼Œå› ä¸ºtrampolineæ˜¯æ•´ä¸ªæ“ä½œç³»ç»Ÿå…±äº«çš„ä¸éœ€è¦é‡Šæ”¾ï¼Œè€Œtrapframeæ˜¯ç”¨æˆ·æ€å’Œå†…æ ¸æ€è½¬æ¢æ—¶çš„ç”¨åˆ°çš„å­˜å‚¨åŒºåŸŸï¼Œååˆ†é‡è¦ï¼ŒåŒæ ·ä¸ä¼šé‡Šæ”¾ï¼ˆå…³äºtrapframeå’Œtrampolineçš„è¯¦ç»†è¯´æ˜å¯ä»¥æŸ¥é˜…book-riscvï¼‰ã€‚æœ€åçš„uvmfreeåˆ™æ˜¯é‡Šæ”¾æ—§é¡µè¡¨å ç”¨çš„å†…å­˜ï¼ˆ5é¡µï¼‰ä»¥åŠç”¨æˆ·å†…å­˜ï¼ˆ4é¡µï¼‰ï¼Œå…±9é¡µã€‚\nexecç»“æŸåé‡Šæ”¾æ—§é¡µè¡¨å’Œæ—§ç”¨æˆ·å†…å­˜ ç»¼ä¸Šï¼Œexecä¸€å…±åˆ†é…äº†3+4+2=9é¡µï¼Œç„¶ååˆé‡Šæ”¾äº†9é¡µã€‚\nsbrk sbrké€šè¿‡growprocåˆ†é…ç‰©ç†é¡µå¹¶å»ºç«‹æ˜ å°„ï¼Œåˆ†é…çš„æ˜¯å †ï¼Œä»ä½åœ°å€å‘ä¸Šå¢é•¿\nsbrké€šè¿‡growprocåˆ†é…ç‰©ç†é¡µå¹¶å»ºç«‹æ˜ å°„ wait è¿›ç¨‹å†…å­˜çš„é‡Šæ”¾ä¸åœ¨exitä¸­è€Œåœ¨waitï¼Œç”±çˆ¶è¿›ç¨‹å‘èµ·ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„freeçš„é¡ºåºï¼Œå› ä¸ºxv6çš„ç©ºé—²å†…å­˜ç”±freelistç®¡ç†ï¼Œé€šè¿‡kallocåˆ†é…ç‰©ç†é¡µï¼Œkfreeé‡Šæ”¾ç‰©ç†é¡µï¼Œå¹¶å°†é‡Šæ”¾çš„ç‰©ç†é¡µæŒ‡å‘å½“å‰çš„freelistï¼Œå®ç°ç±»ä¼¼æ ˆçš„åè¿›å…ˆå‡ºæ¥åˆ†é…ç‰©ç†é¡µ\nè¿›ç¨‹å†…å­˜çš„é‡Šæ”¾ä¸åœ¨exitä¸­è€Œåœ¨waitï¼Œç”±çˆ¶è¿›ç¨‹å‘èµ· å…ˆè°ƒç”¨uvmunmapä»ä½åˆ°é«˜åœ°å€é‡Šæ”¾ç”¨æˆ·å†…å­˜ï¼Œæ ¹æ®ä¹‹å‰å†…å­˜åˆ†é…çš„åˆ†æï¼Œé‡Šæ”¾é¡ºåºä¸ºdataæ®µ+textæ®µã€ç”¨æˆ·æ ˆ+page guardã€32é¡µå †å†…å­˜ï¼ˆæ¯é¡µä»ä½åœ°å€é¡µåˆ°é«˜åœ°å€é¡µä¾æ¬¡é‡Šæ”¾/å…¥æ ˆï¼‰ï¼Œå…±36é¡µ\næœ€åé‡Šæ”¾é¡µè¡¨ï¼Œå…±5é¡µï¼ˆ5ä¸ªé¡µç›®å½•ï¼‰\næ­¤æ—¶æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œkmemç»´æŠ¤çš„ç©ºé—²é“¾è¡¨æ ˆï¼Œä»æ ˆé¡¶å¼€å§‹çš„é¡µä¾æ¬¡ä¸ºï¼š5é¡µé¡µè¡¨ã€ç¬¬32é¡µå †å†…å­˜ã€ç¬¬31é¡µå †å†…å­˜ã€â€¦ã€ç¬¬10é¡µå †å†…å­˜ï¼ˆå¯†ç æ‰€åœ¨çš„é¡µï¼‰ã€â€¦ã€ç¬¬1é¡µå †å†…å­˜ã€page guardâ€¦..trapframe\nkmemç»´æŠ¤çš„ç©ºé—²é“¾è¡¨æ ˆï¼Œä»æ ˆé¡¶å¼€å§‹çš„é¡µä¾æ¬¡ Answer attacktestè¿è¡Œattackçš„æ–¹å¼å’Œè¿è¡Œsecretçš„ä¸€æ ·ï¼Œéƒ½æ˜¯é€šè¿‡fork+execï¼Œç›´æ¥æ‹¿å‰é¢çš„åˆ†æç»“æœï¼Œæˆ‘ä»¬çŸ¥é“åœ¨å¼€å§‹æ‰§è¡Œattackç¨‹åºä¹‹å‰ï¼Œforkåˆ†é…äº†10é¡µï¼Œexecåˆ†é…9é¡µåˆé‡Šæ”¾äº†9é¡µï¼Œå…¶ä¸­forkåˆ†é…çš„10é¡µæ¥è‡ªäº5é¡µé¡µè¡¨ã€ç¬¬32 ~ 28é¡µå †å†…å­˜ï¼Œexecåˆ†é…çš„9é¡µæ¥è‡ªç¬¬27 ~ 18é¡µå †å†…å­˜ï¼Œåé¢åˆé‡Šæ”¾äº†9é¡µå›æ ˆé¡¶ï¼Œæ­¤æ—¶æ ˆé¡¶å¼€å§‹çš„é¡µä¾æ¬¡ä¸ºï¼š9é¡µã€ç¬¬17é¡µå †å†…å­˜ã€â€¦ã€ç¬¬10é¡µå †å†…å­˜,ç§˜å¯†å°±åœ¨ç¬¬17é¡µä¸­ï¼ˆç§˜å¯†åœ¨ç¬¬10é¡µå †å†…å­˜å¤„ï¼‰ã€‚\nå¦å¤–ä¸€ä¸ª Questionï¼šuser/secret.c copies the secret bytes to memory whose address is 32 bytes after the start of a page. Change the 32 to 0 and you should see that your attack doesnâ€™t work anymore; why not?\nä¸ºä»€ä¹ˆå°†ç§˜å¯†çš„é¡µå†…offsetæ”¹æˆ0å°±ä¸è¡Œäº†åªæœ‰\u003e=32çš„å€¼æ‰è¡Œï¼Œæ˜¯å› ä¸ºç³»ç»ŸæŠŠç©ºé—²é¡µå‰4ä¸ªå­—èŠ‚ä½œä¸ºé“¾å¼æ ˆçš„æŒ‡é’ˆäº†ï¼Œæ‰€ä»¥è¦†ç›–æ‰äº†ç§˜å¯†çš„å€¼\nSome concepts stack frame æ ˆå¸§ï¼ˆStack Frameï¼‰æ˜¯ç¨‹åºè¿è¡Œæ—¶åœ¨è°ƒç”¨æ ˆï¼ˆCall Stackï¼‰ä¸Šåˆ†é…çš„ä¸€æ®µå†…å­˜åŒºåŸŸï¼Œç”¨äºç®¡ç†å‡½æ•°è°ƒç”¨çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚å®ƒæ˜¯å‡½æ•°æ‰§è¡ŒæœŸé—´ä¸´æ—¶æ•°æ®çš„å­˜å‚¨ç©ºé—´ï¼Œä¹Ÿæ˜¯å®ç°å‡½æ•°åµŒå¥—è°ƒç”¨ã€è¿”å›å’Œå±€éƒ¨å˜é‡ç®¡ç†çš„æ ¸å¿ƒæœºåˆ¶ã€‚\n1 2 3 é«˜åœ°å€ -\u003e | è°ƒç”¨è€…æ ˆå¸§ | | å½“å‰æ ˆå¸§ | \u003c- æ ˆé¡¶ï¼ˆesp/spï¼‰ ä½åœ°å€ ecall 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 User Program Kernel/Handler â†“ 1. å‡†å¤‡å‚æ•°ï¼š - ç³»ç»Ÿè°ƒç”¨å·å†™å…¥ a7 - å‚æ•°å†™å…¥ a0, a1, ... 2. æ‰§è¡Œ ecall â†“ â†’ 3. CPU åˆ‡æ¢åˆ°æ›´é«˜ç‰¹æƒçº§ â†“ â†’ 4. ä¿å­˜ä¸Šä¸‹æ–‡ï¼š - PCï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰å­˜å…¥ sepc - å¼‚å¸¸åŸå› å­˜å…¥ scause - å½“å‰çŠ¶æ€å­˜å…¥ sstatus â†“ â†’ 5. è·³è½¬åˆ° stvec å¯„å­˜å™¨æŒ‡å‘çš„é™·é˜±å¤„ç†ç¨‹åº â†“ 6. å†…æ ¸å¤„ç†ç³»ç»Ÿè°ƒç”¨ â†“ 7. æ‰§è¡Œ sret è¿”å›ç”¨æˆ·ç¨‹åº register a7 ç›´æ¥é€šè¿‡æ±‡ç¼–æŒ‡ä»¤å†™å…¥\né€šè¿‡é«˜çº§è¯­è¨€å°è£…å‡½æ•°å†™å…¥\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 #include int main() { char msg[] = \"Hello\\n\"; // ç­‰ä»·äºæ±‡ç¼–ä¸­çš„ li a7, 64 syscall(SYS_write, 1, msg, 6); // SYS_write=64 return 0; } long syscall(long num, ...) { register long a7 asm(\"a7\") = num; // å¼ºåˆ¶å°† num å­˜å…¥ a7 register long a0 asm(\"a0\"); // è¿”å›å€¼é€šè¿‡ a0 æ¥æ”¶ asm volatile ( \"ecall\" : \"=r\"(a0) : \"r\"(a7), \"r\"(a0), \"r\"(a1), \"r\"(a2) // å‚æ•°ä¾æ¬¡å­˜å…¥ a0-a2 : \"memory\" ); return a0; } addrline 1 2 $ addr2line -e my_program 0x401152 \u003e /path/to/my_program.c:123 é€‰é¡¹ ä½œç”¨ -f æ˜¾ç¤ºå‡½æ•°åï¼ˆä¸ä»…æ˜¾ç¤ºæ–‡ä»¶åå’Œè¡Œå·ï¼‰ã€‚ -C è§£ç  C++ ç¬¦å·ï¼ˆdemangleï¼Œå°†ç¼–è¯‘å™¨ç”Ÿæˆçš„ç¬¦å·è½¬ä¸ºå¯è¯»åç§°ï¼‰ã€‚ -p ä»¥å¯è¯»æ ¼å¼è¾“å‡ºï¼ˆåŒ…å«æ–‡ä»¶åã€è¡Œå·å’Œå‡½æ•°åï¼‰ã€‚ -a æ˜¾ç¤ºåŸå§‹åœ°å€ï¼ˆåœ¨è¾“å‡ºä¸­æ·»åŠ åœ°å€ä¿¡æ¯ï¼‰ã€‚ -i æ˜¾ç¤ºå†…è”å‡½æ•°ï¼ˆå¦‚æœå­˜åœ¨å†…è”å±•å¼€ï¼‰ã€‚ script 1 2 3 $ script qemu_output.log # æŒ‡å®šæ—¥å¿—æ–‡ä»¶åï¼ˆé»˜è®¤æ˜¯ typescriptï¼‰ $ make qemu æ‰€æœ‰è¾“å‡ºï¼ˆåŒ…æ‹¬å†…æ ¸æ—¥å¿—ã€è°ƒè¯•ä¿¡æ¯ï¼‰å°†è¢«å®æ—¶è®°å½•åˆ° qemu_output.log $ exit trapframe trapframe æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œç”¨æ¥ä¿å­˜å¤„ç†å™¨çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯åœ¨å‘ç”Ÿä¸­æ–­æˆ–é™·é˜±ï¼ˆtrapï¼‰æ—¶ã€‚å½“CPUè¢«ä¸­æ–­æˆ–é™·å…¥æŸä¸ªå¼‚å¸¸ï¼ˆä¾‹å¦‚ç³»ç»Ÿè°ƒç”¨ã€é¡µé”™è¯¯ç­‰ï¼‰æ—¶ï¼Œæ“ä½œç³»ç»Ÿéœ€è¦ä¿å­˜å½“å‰æ‰§è¡Œçš„çŠ¶æ€ï¼Œä»¥ä¾¿åç»­æ¢å¤ç¨‹åºçš„æ‰§è¡Œã€‚\nåœ¨xv6ä¸­ï¼Œtrapframe ä¸»è¦ç”¨äºä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š\nä¸­æ–­å¤„ç†ï¼šå½“å‘ç”Ÿç¡¬ä»¶ä¸­æ–­ï¼ˆä¾‹å¦‚æ—¶é’Ÿä¸­æ–­æˆ–å¤–éƒ¨è®¾å¤‡ä¸­æ–­ï¼‰æ—¶ï¼Œå½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡éœ€è¦è¢«ä¿å­˜åˆ° trapframe ä¸­ï¼Œä»¥ä¾¿åœ¨ä¸­æ–­å¤„ç†å®Œæ¯•åèƒ½å¤Ÿæ¢å¤åˆ°ä¸­æ–­å‘ç”Ÿå‰çš„çŠ¶æ€ã€‚ ç³»ç»Ÿè°ƒç”¨å¤„ç†ï¼šåœ¨ç³»ç»Ÿè°ƒç”¨è¿‡ç¨‹ä¸­ï¼ŒCPUä¼šäº§ç”Ÿä¸€ä¸ªé™·é˜±ï¼ˆtrapï¼‰ï¼Œè¿™æ—¶ä¹Ÿéœ€è¦ä¿å­˜å½“å‰ç”¨æˆ·ç¨‹åºçš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œç­‰ç³»ç»Ÿè°ƒç”¨å¤„ç†å®Œæ¯•åï¼Œå†æ¢å¤åˆ°ç”¨æˆ·ç¨‹åºç»§ç»­æ‰§è¡Œã€‚ trapframe çš„ç»“æ„é€šå¸¸åŒ…å«äº†ä»¥ä¸‹å‡ ä¸ªå…³é”®éƒ¨åˆ†ï¼š\nå¯„å­˜å™¨çŠ¶æ€ï¼šåŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰ã€æ ˆæŒ‡é’ˆï¼ˆSPï¼‰ä»¥åŠå…¶ä»–é€šç”¨å¯„å­˜å™¨çš„å€¼ã€‚ ä¸­æ–­ç›¸å…³æ ‡å¿—ï¼šå¦‚ä¸­æ–­å·ã€å¼‚å¸¸å·ç­‰ã€‚ ç”¨æˆ·æ ˆä¿¡æ¯ï¼šåœ¨å‘ç”Ÿç³»ç»Ÿè°ƒç”¨æˆ–ä¸­æ–­æ—¶ï¼Œæ ˆçš„çŠ¶æ€ä¿¡æ¯ä¹Ÿä¼šè¢«ä¿å­˜ã€‚ Lab3. Pgtbl 1. Inspect pgtbl å¯ä»¥ç”¨Lab2ä¸­execç³»ç»Ÿè°ƒç”¨åšäº†ä»€ä¹ˆæ¥è§£é‡Šé¡µè¡¨\n2. speed syscall åƒtrapolineå’Œtrapframeä¸€æ ·åˆ†é…ç‰©ç†é¡µå¹¶åœ¨é¡µè¡¨è¿›è¡Œæ˜ å°„ï¼Œæ³¨æ„éœ€è¦åœ¨execå’Œforkå®ç°ä¸­ç»™pidèµ‹å€¼å¹¶ä¸”åœ¨proc_freepagetableå¤„è°ƒç”¨uvmunmap\næˆ‘è¿˜ä¿®æ”¹äº†struc procçš„å®šä¹‰ï¼Œå¢åŠ usyscallä¸trapframeçš„é£æ ¼ä¸€è‡´\nä¿®æ”¹struct procçš„å®šä¹‰ï¼Œå¢åŠ usyscall å°±ä¸è¯¥è®©æˆ‘ç®¡ç†å†…å­˜ğŸ˜­æœ€åçš„usertestä¸€ç›´è¿‡ä¸å»ç»“æœå‘ç°æ˜¯ç¬¬äºŒéƒ¨åˆ†çš„usyscallçš„pageæ²¡æœ‰é‡Šæ”¾\nusyscallçš„pageæ²¡æœ‰é‡Šæ”¾å¯¼è‡´usertestä¸è¿‡ ä¿®æ­£åä»ç„¶å°‘ä¸¤ä¸ªpageï¼Œéœ€è¦åœ¨allocprocä¸­åˆ†é… è¿™æ ·ä¹‹åusertestä¹Ÿæ²¡è¿‡ï¼Œè¿˜å°‘ä¸¤ä¸ªpageï¼Œusyscallçš„å†…å­˜ä¸èƒ½åœ¨proc_pagetableåˆ†é…ï¼Œåªèƒ½åœ¨alloc_procåˆ†é…ï¼Œå¯èƒ½ä¸é”æœ‰å…³ï¼Œç›®å‰æˆ‘è¿˜ä¸çŸ¥é“åŸå› \nä¿®æ­£åçš„å†…å­˜ç®¡ç†é—®é¢˜ 3. print pgtbl è¿™ä¸ªé¢˜ç›®MITå°†å…¶è®¾ä¸ºeasyï¼Œä½†æ˜¯è¯¾ç¨‹å®˜ç½‘ä¸Šç»™å‡ºçš„ç­”æ¡ˆä¸­çš„vaå´æ˜¯é”™è¯¯çš„ï¼Œå¹¶ä¸”æˆ‘ä¹Ÿæ¨¡æ‹Ÿå‡ºäº†é”™è¯¯çš„åŸå› (å¾€å¹´çš„labæ²¡æœ‰è¦æ±‚æ‰“å°va)\nè¿™æ˜¯å¾—åˆ°å®˜ç½‘ç­”æ¡ˆçš„ä»£ç ï¼š(ä½ èƒ½ä¸èƒ½å‘ç°é—®é¢˜æ‰€åœ¨..\nMITå®˜æ–¹ç­”æ¡ˆä¸­çš„é”™è¯¯ä»£ç ï¼ˆiæº¢å‡ºé—®é¢˜ï¼‰ è¿™æ˜¯å¾—åˆ°æ­£ç¡®ç­”æ¡ˆçš„ä»£ç ï¼šï¼ˆæ²¡é”™ï¼Œiæº¢å‡ºäº†ï¼Œoffsetä¼šåœ¨å‡ ä¸ªæ•°ä¹‹é—´å¾ªç¯\nä¿®æ­£åçš„æ­£ç¡®ä»£ç ï¼Œè§£å†³äº†iæº¢å‡ºé—®é¢˜ è¿™æ˜¯æˆ‘å¾—åˆ°çš„ç­”æ¡ˆï¼Œæˆ‘ç”¨MAXVAéªŒè¯äº†å®ƒçš„æ­£ç¡®æ€§\næ­£ç¡®çš„é¡µè¡¨è¾“å‡ºç»“æœï¼Œç”¨MAXVAéªŒè¯æ­£ç¡®æ€§ 4. superpages è¿™ä¸ªéƒ¨åˆ†éœ€è¦è®©xv6æ”¯æŒè¶…é¡µé¢ï¼Œæ”¹åŠ¨çš„åœ°æ–¹è¾ƒå¤šï¼Œå®¹æ˜“å‡ºç°å°é”™è¯¯ï¼Œç»“æœè¾“å‡ºå¯¹äº†usertestä¹Ÿä¸ä¸€å®šèƒ½è¿‡\né¦–å…ˆéœ€è¦è®©xv6èƒ½å¤Ÿåˆ†é…è¶…é¡µé¢ç‰©ç†å†…å­˜ï¼Œä¸ºäº†ä¾¿äºç®¡ç†ï¼Œæˆ‘åœ¨kmemä¸­å¢åŠ äº†superfreelist,å¹¶åœ¨initæ—¶åˆå§‹åŒ–ï¼ˆéœ€è¦æ³¨æ„å­—èŠ‚å¯¹é½\nä½¿ç”¨referencesç»Ÿè®¡cpuidçš„freelistå¤§å° ç„¶åéœ€è¦è®©sbrkæ”¯æŒè¶…é¡µé¢çš„åˆ†é…ï¼Œè¿™éƒ¨åˆ†å¾ˆå®¹æ˜“å‡ºé—®é¢˜\nå› ä¸ºéœ€è¦å­—èŠ‚å¯¹é½ï¼Œå¯èƒ½å¯¼è‡´åˆ†é…è¶…é¡µé¢çš„èµ·å§‹åœ°å€è¾ƒå¤§ï¼Œä¸ä¹‹å‰çš„szä¸­é—´éœ€è¦åˆ†é…è™šæ‹Ÿåœ°å€ åªè®¾å®šäº†å°‘é‡çš„è¶…é¡µé¢ï¼Œå¦‚æœç”³è¯·ç‰©ç†å†…å­˜è¾ƒå¤§ï¼Œåªèƒ½ä½¿ç”¨æ™®é€šé¡µé¢ å¦‚æœç”³è¯·çš„ç‰©ç†å†…å­˜è¿‡å¤§ï¼Œéœ€è¦deallocä¹‹å‰allocè¿‡çš„å†…å­˜å¹¶unmap sbrkæ”¯æŒè¶…é¡µé¢çš„åˆ†é…å®ç° ä¹‹åå’Œuvmallocä¸€æ ·åˆ†é…è¶…é¡µé¢ï¼Œå¼€å§‹æˆ‘æƒ³æŠŠä¸¤è€…å°è£…åœ¨ä¸€èµ·ï¼Œå‘ç°è¿˜æ˜¯ç‹¬ç«‹å‡½æ•°æ›´ä¸ºæ¸…æ™°\nuvmallocçš„è¶…é¡µé¢åˆ†é…å®ç° ä¹‹åæ¯”è¾ƒå…³é”®çš„æ˜¯é¡µè¡¨æ˜ å°„ï¼Œéœ€è¦è®©level1çš„pteç›´æ¥æ˜ å°„åˆ°ç‰©ç†å†…å­˜è€Œä¸æ˜¯ä¸‹ä¸€çº§çš„pteï¼Œç›¸å½“äºæ²¡æœ‰äº†L0ä½†å¤šäº†9ä½çš„offsetï¼Œè¿™é‡Œä¸»è¦æ”¹åŠ¨çš„æ˜¯walk\né¡µè¡¨æ˜ å°„ï¼Œéœ€è¦è®©level1çš„pteç›´æ¥æ˜ å°„åˆ°ç‰©ç†å†…å­˜ ä¿®æ”¹walkå‡½æ•°æ”¯æŒè¶…é¡µé¢æ˜ å°„ å¦å¤–è¿˜è¦è®©è¶…é¡µé¢æ”¯æŒforkå­è¿›ç¨‹æ—¶çš„é¡µè¡¨å¤åˆ¶å’Œé‡Šæ”¾ï¼Œè¿™é‡Œç›´æ¥å°è£…åˆ°ä¸€ä¸ªå‡½æ•°äº†\nè®©è¶…é¡µé¢æ”¯æŒforkå­è¿›ç¨‹æ—¶çš„é¡µè¡¨å¤åˆ¶ è¶…é¡µé¢çš„é‡Šæ”¾å‡½æ•°å°è£… Lab4. Traps 1. RISC-V asmma Which registers contain arguments to functions? For example, which register holds 13 in mainâ€™s call to printf?\na0-a7 Where is the call to function f in the assembly code for main? Where is the call to g? (Hint: the compiler may inline functions.)\n1 2 2e:\t45b1 li\ta1,12 1a:\t250d addiw\ta0,a0,3 Run the following code.\n1 2 unsigned int i = 0x00646c72; printf(\"H%x Wo%s\", 57616, (char *) \u0026i); What is the output?\nHe110 Worldï¼ŒRISC-V å’Œ x86 éƒ½æ˜¯å°ç«¯å­—èŠ‚åº In the following code, what is going to be printed after 'y='? (note: the answer is not a specific value.) Why does this happen?\n1 printf(\"x=%d y=%d\", 3)ï¼› ub 2. backtrace æ¨¡æ‹Ÿå®ç°backtraceï¼Œç†è§£æ ˆå¸§å°±å¾ˆå®¹æ˜“å®ç°\nbacktraceçš„å®ç°ï¼Œé€šè¿‡æ ˆå¸§æŒ‡é’ˆéå†è°ƒç”¨æ ˆ 3. alarm è¿™é¢˜éš¾åº¦ä¸ºhardï¼Œä½†å®ç°èµ·æ¥æ²¡æœ‰å¾ˆéš¾ï¼Œè€Œä¸”å®˜æ–¹ç»™äº†å¾ˆå¤šæç¤ºï¼Œå°±å·®ç›´æ¥è¯´ç­”æ¡ˆäº†\né¦–å…ˆè¦æ”¯æŒæ–°åŠ å…¥çš„syscallï¼Œè¿™éƒ¨åˆ†Lab1å°±æ¶‰åŠäº†\nç„¶åå°±æ˜¯å®ç°ä¸¤ä¸ªsyscallæ¥å®ç°alarmï¼Œalarmçš„åŠŸèƒ½ç±»ä¼¼ä¸è®¾å®šä¸€ä¸ªå›ºå®šæ—¶é•¿çš„æ—¶é’Ÿä¸­æ–­ï¼Œå¹¶ä¸”å®ƒçš„å®ç°ticksè®¡æ•°ä¹Ÿä»¥ç‰©ç†æ—¶é’Ÿä¸­æ–­ä¸ºåŸºæœ¬å•ä½\né¦–å…ˆéœ€è¦ä¸ºprocå¢åŠ ä¸€ä¸ªalarmç›¸å…³çš„ç»“æ„ä½“ï¼ˆenabled ä»£è¡¨æ˜¯å¦å¯ç”¨alarmï¼Œticks ä¸ºè®¡æ•°å€¼ï¼Œ usingä»£è¡¨æ˜¯å¦æ­£åœ¨å¤„ç†alarmä¸­æ–­ä¸èƒ½é‡å¤ä¸­æ–­ï¼Œcopyä¸ºä¸­æ–­å‰çš„å¯„å­˜å™¨ï¼Œhandlerä¸ºä¸­æ–­å¤„ç†å‡½æ•°ï¼Œisreturn éœ€è¦ä¸ºæ¢å¤a0æä¾›æ”¯æŒï¼‰\nä¸ºprocå¢åŠ alarmç›¸å…³çš„ç»“æ„ä½“ sys_sigalarmç³»ç»Ÿè°ƒç”¨çš„å®ç° sys_sigalarmç”¨äºå¯ç”¨alarmï¼Œä¸”åœ¨èµ‹å€¼ä¸º(0ï¼Œ0)æ—¶å…³é—­alarm\nsys_sigalarmç”¨äºå¯ç”¨alarmçš„å®ç° ç„¶åéœ€è¦åœ¨usertrapä¸­æä¾›alarmçš„æ”¯æŒï¼Œæ¯æ¬¡æ—¶é’Ÿä¸­æ–­å°†tickså€¼åŠ ä¸€ï¼Œåœ¨è¾¾åˆ°è®¡æ•°å€¼åè®¾ç½®epcå¯„å­˜å™¨è°ƒç”¨handlerï¼Œå¹¶ä¸”éœ€è¦ä¿å­˜å¯„å­˜å™¨ï¼Œåœ¨ç”¨æˆ·å¤„ç†å®Œalarmä¸­æ–­åæ¢å¤(åœ¨sigreturnä¸­å®ç°\nåœ¨usertrapä¸­æä¾›alarmçš„æ”¯æŒ åœ¨sigreturnä¸­æ¢å¤å¯„å­˜å™¨ï¼Œsigreturnçš„è¿”å›å€¼ä¼šè¢«ä¿å­˜åœ¨a0ä¸­ï¼Œéœ€è¦é‡æ–°èµ‹å€¼\nåœ¨sigreturnä¸­æ¢å¤å¯„å­˜å™¨ sigreturnçš„è¿”å›å€¼å¤„ç† Some concepts æ ˆå¸§ These lecture notes have a picture of the layout of stack frames. Note that the return address lives at a fixed offset (-8) from the frame pointer of a stackframe, and that the saved frame pointer lives at fixed offset (-16) from the frame pointer.\nhttps://decaf-lang.github.io/minidecaf-tutorial-deploy/docs/lab5/stackframe.html\nLab5. Cow è¿™ä¸ªlabéœ€è¦å®ç°copy-on-write forkï¼Œå…ˆé˜…è¯»Chapter4.6 çš„page-fault exceptions äº†è§£cowæœºåˆ¶ï¼Œç„¶åæ ¹æ®æç¤ºå®ç°åŠŸèƒ½çš„å„ä¸ªéƒ¨åˆ†ã€‚ä¸è¿‡å’Œsuperpageä¸€æ ·å¦‚æœå‘ç”Ÿäº†å°é”™è¯¯debugå¾ˆéº»çƒ¦ï¼Œå®¹æ˜“å‘ç”Ÿä»¤äººè´¹è§£çš„é”™è¯¯\ncowå·¥ä½œåŸç† è®¸å¤šå†…æ ¸ä½¿ç”¨é¡µé¢æ•…éšœæ¥å®ç°å†™æ—¶å¤åˆ¶ï¼ˆcopy-on-writeï¼Œcowï¼‰forkã€‚è¦è§£é‡Šå†™æ—¶å¤åˆ¶forkï¼Œå¯ä»¥æƒ³ä¸€æƒ³xv6çš„forkï¼Œåœ¨ç¬¬3ç« ä¸­ä»‹ç»è¿‡ã€‚forké€šè¿‡è°ƒç”¨uvmcopyï¼ˆkernel/vm.c:309ï¼‰ä¸ºå­è¿›ç¨‹åˆ†é…ç‰©ç†å†…å­˜ï¼Œå¹¶å°†çˆ¶è¿›ç¨‹çš„å†…å­˜å¤åˆ¶åˆ°å­ç¨‹åºä¸­ï¼Œä½¿å­è¿›ç¨‹æ‹¥æœ‰ä¸çˆ¶è¿›ç¨‹ç›¸åŒçš„å†…å­˜å†…å®¹ã€‚å¦‚æœå­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹èƒ½å¤Ÿå…±äº«çˆ¶è¿›ç¨‹çš„ç‰©ç†å†…å­˜ï¼Œæ•ˆç‡ä¼šæ›´é«˜ã€‚ç„¶è€Œï¼Œç›´æ¥å®ç°è¿™ç§æ–¹æ³•æ˜¯è¡Œä¸é€šçš„ï¼Œå› ä¸ºçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹å¯¹å…±äº«æ ˆå’Œå †çš„å†™å…¥ä¼šä¸­æ–­å½¼æ­¤çš„æ‰§è¡Œã€‚\né€šè¿‡ä½¿ç”¨å†™æ—¶å¤åˆ¶forkï¼Œå¯ä»¥è®©çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹å®‰å…¨åœ°å…±äº«ç‰©ç†å†…å­˜ï¼Œé€šè¿‡é¡µé¢æ•…éšœæ¥å®ç°ã€‚å½“CPUä¸èƒ½å°†è™šæ‹Ÿåœ°å€ç¿»è¯‘æˆç‰©ç†åœ°å€æ—¶ï¼ŒCPUä¼šäº§ç”Ÿä¸€ä¸ªé¡µé¢æ•…éšœå¼‚å¸¸ï¼ˆpage-fault exceptionï¼‰ã€‚ RISC-Væœ‰ä¸‰ç§ä¸åŒçš„é¡µæ•…éšœï¼šloadé¡µæ•…éšœï¼ˆå½“åŠ è½½æŒ‡ä»¤ä¸èƒ½ç¿»è¯‘å…¶è™šæ‹Ÿåœ°å€æ—¶ï¼‰ã€stoteé¡µæ•…éšœï¼ˆå½“å­˜å‚¨æŒ‡ä»¤ä¸èƒ½ç¿»è¯‘å…¶è™šæ‹Ÿåœ°å€æ—¶ï¼‰å’ŒæŒ‡ä»¤é¡µæ•…éšœï¼ˆå½“æŒ‡ä»¤çš„åœ°å€ä¸èƒ½ç¿»è¯‘æ—¶ï¼‰ã€‚scauseå¯„å­˜å™¨ä¸­çš„å€¼è¡¨ç¤ºé¡µé¢æ•…éšœçš„ç±»å‹ï¼Œstvalå¯„å­˜å™¨ä¸­åŒ…å«æ— æ³•ç¿»è¯‘çš„åœ°å€ã€‚\nCOW forkä¸­çš„åŸºæœ¬è®¾è®¡æ˜¯çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹æœ€åˆå…±äº«æ‰€æœ‰çš„ç‰©ç†é¡µé¢ï¼Œä½†å°†å®ƒä»¬æ˜ å°„è®¾ç½®ä¸ºåªè¯»ã€‚å› æ­¤ï¼Œå½“å­è¿›ç¨‹æˆ–çˆ¶è¿›ç¨‹æ‰§è¡ŒstoreæŒ‡ä»¤æ—¶ï¼ŒRISC-V CPUä¼šå¼•å‘ä¸€ä¸ªé¡µé¢æ•…éšœå¼‚å¸¸ã€‚ä½œä¸ºå¯¹è¿™ä¸ªå¼‚å¸¸çš„å“åº”ï¼Œå†…æ ¸ä¼šæ‹·è´ä¸€ä»½åŒ…å«æ•…éšœåœ°å€çš„é¡µã€‚ç„¶åå°†ä¸€ä¸ªå‰¯æœ¬çš„è¯»/å†™æ˜ å°„åœ¨å­è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œå¦ä¸€ä¸ªå‰¯æœ¬çš„è¯»/å†™æ˜ å°„åœ¨çˆ¶è¿›ç¨‹åœ°å€ç©ºé—´ã€‚æ›´æ–°é¡µè¡¨åï¼Œå†…æ ¸åœ¨å¼•èµ·æ•…éšœçš„æŒ‡ä»¤å¤„æ¢å¤æ•…éšœå¤„ç†ã€‚å› ä¸ºå†…æ ¸å·²ç»æ›´æ–°äº†ç›¸å…³çš„PTEï¼Œå…è®¸å†™å…¥ï¼Œæ‰€ä»¥ç°åœ¨æ•…éšœæŒ‡ä»¤å°†æ­£å¸¸æ‰§è¡Œã€‚\nè¿™ä¸ªCOWè®¾è®¡å¯¹forkå¾ˆæœ‰æ•ˆï¼Œå› ä¸ºå¾€å¾€å­ç¨‹åºåœ¨forkåç«‹å³è°ƒç”¨execï¼Œç”¨æ–°çš„åœ°å€ç©ºé—´æ›¿æ¢å…¶åœ°å€ç©ºé—´ã€‚åœ¨è¿™ç§å¸¸è§çš„æƒ…å†µä¸‹ï¼Œå­ç¨‹åºåªä¼šé‡åˆ°ä¸€äº›é¡µé¢æ•…éšœï¼Œè€Œå†…æ ¸å¯ä»¥é¿å…è¿›è¡Œå®Œæ•´çš„å¤åˆ¶ã€‚æ­¤å¤–ï¼ŒCOW forkæ˜¯é€æ˜çš„ï¼šä¸éœ€è¦å¯¹åº”ç”¨ç¨‹åºè¿›è¡Œä¿®æ”¹ï¼Œåº”ç”¨ç¨‹åºå°±èƒ½å—ç›Šã€‚\nè¿™æ®µæ¥è‡ªxv6 boot 4.6çš„ç¿»è¯‘ï¼ˆfrom xv6 book-cnï¼‰ï¼Œå¯¹äºcowå·²ç»å†™çš„å¾ˆæ¸…æ¥šäº†,å¦å¤–ï¼šRISC-Væœ‰ä¸‰ç§ä¸åŒçš„é¡µæ•…éšœå¯¹åº”scauseï¼Œå¯¹äºCowåªéœ€è¦å¤„ç†scause=15çš„page-fault\næŒ‡ä»¤Page Faultï¼ˆå–æŒ‡ï¼‰ï¼šscause = 12 åŠ è½½Page Faultï¼ˆè¯»æ•°æ®ï¼‰ï¼šscause = 13 å­˜å‚¨Page Faultï¼ˆå†™æ•°æ®ï¼‰ï¼šscause = 15 Answer é¦–å…ˆéœ€è¦å¢åŠ æ”¯æŒCowçš„ç‰©ç†å†…å­˜å¼•ç”¨è®¡æ•°ï¼Œä½¿å¾—ä¸ä¼šfreeå…±äº«çš„é¡µé¢ï¼Œå¢åŠ å‡å°‘éœ€è¦ä¸Šé”é˜²æ­¢å¤šä¸ªè¿›ç¨‹å…±åŒå†™å…¥ï¼ŒåŒæ—¶æˆ‘æŠŠsubreferenceå°è£…è¿›kfreeï¼Œå‡å°‘éœ€è¦ä¿®æ”¹çš„æ¡†æ¶ä»£ç \nCOWæ”¯æŒçš„ç‰©ç†å†…å­˜å¼•ç”¨è®¡æ•°åˆå§‹åŒ– COWç‰©ç†å†…å­˜å¼•ç”¨è®¡æ•°å®ç° kallocå’Œkfreeçš„å¼•ç”¨è®¡æ•°ç®¡ç† ç„¶åå®ç°Cow-forkä¿®æ”¹uvmcopyï¼Œä¸»è¦æœ‰å‡ ä¸ªå…³é”®ç‚¹ï¼š\nä¸åˆ†é…ç‰©ç†é¡µ\nä½¿ç”¨pteçš„RSWä¿ç•™ä½ï¼Œå¢åŠ PTE_COWç”¨äºæ ‡ç¤ºpage-faultæ—¶éœ€è¦å¤„ç†çš„é¡µè¡¨é¡¹\nå°†çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹çš„é¡µè¡¨éƒ½æ ‡è®°ä¸ºä¸å¯å†™\néœ€è¦åŠ å…¥*pte \u0026 PTE_COWé˜²æ­¢è¿˜æ²¡æœ‰å¤åˆ¶å¯å†™å­è¿›ç¨‹é¡µå°±è°ƒç”¨fork\nCOW forkçš„uvmcopyå®ç°ï¼Œä¸åˆ†é…ç‰©ç†é¡µ ç„¶åéœ€è¦usertrapå¤„ç†scauseä¸º15çš„pagefaultï¼ˆpsï¼šä¸è¦éšä¾¿åŠ çœ‹ä¸æ‡‚çš„å†…å®¹ï¼Œæˆ‘å¼€å§‹åœ¨è¿™é‡Œæ‰‹æ¬ åŠ å…¥äº†ä¸Šé¢å¤„ç†syscallçš„intr_onï¼Œåˆå¯¼è‡´äº†æ— æ³•ç†è§£çš„é”™è¯¯ï¼‰\né¡µé”™è¯¯å¤„ç†å™¨çš„å®ç° åœ¨usertrapä¸­å¤„ç†scauseä¸º15çš„page fault å¦å¤–éœ€è¦åœ¨copyoutä¸­åŠ å…¥åŒæ ·çš„æœºåˆ¶ï¼Œé˜²æ­¢è¯¯åˆ¤é¡µä¸å¯å†™å…¥\nåœ¨copyoutä¸­åŠ å…¥COWæœºåˆ¶æ”¯æŒ å…³äºè°ƒè¯• IMPORTANT The machine is always right. (æœºå™¨æ°¸è¿œæ˜¯å¯¹çš„) Corollary: If the program does not produce the desired output, it is the programmerâ€™s fault. Every line of untested code is always wrong. (æœªæµ‹è¯•ä»£ç æ°¸è¿œæ˜¯é”™çš„) Corollary: Mistakes are likely to appear in the â€œmust-be-correctâ€ code. è¿™ä¸¤æ¡å…¬ç†çš„æ„æ€æ˜¯: æŠ±æ€¨æ˜¯æ²¡æœ‰ç”¨çš„, æ¥å—ä»£ç æœ‰bugçš„ç°å®, è€å¿ƒè°ƒè¯•.\nè¿™ä¸ªbugå¡äº†æˆ‘å‡ ä¸ªå°æ—¶..\nè°ƒè¯•è¿‡ç¨‹ä¸­é‡åˆ°çš„é”™è¯¯ è°ƒè¯•è¿‡ç¨‹ä¸­çš„é”™è¯¯ç¤ºä¾‹ é¦–å…ˆéœ€è¦å®šä½å‘ç”Ÿusertrapçš„ä½ç½®ï¼Œè¿™é‡Œæˆ‘çŠ¯äº†ç¬¬ä¸€ä¸ªé”™è¯¯ï¼Œæƒ³å½“ç„¶è®¤ä¸ºcopyoutåªåœ¨pipeä¸­ä½¿ç”¨ï¼Œèµ·æ‰‹gdbb sys_pipeï¼Œå…¶å®é”™è¯¯å‘ç”Ÿåœ¨forkå‰çš„read\nç´§æ¥ç€æˆ‘çŠ¯äº†ç¬¬äºŒä¸ªé”™è¯¯ï¼Œæˆ‘ç»§ç»­èµ·æ‰‹gdb b sys_read,å…¶å®æˆ‘è¿˜æ²¡æœ‰çœ‹readç³»ç»Ÿè°ƒç”¨å…·ä½“åšäº†ä»€ä¹ˆï¼Œç„¶åè°ƒè¯•è¿‡ç¨‹ä¸­ç”šè‡³æ²¡å‘ç°readä¸­è°ƒç”¨çš„å‡½æ•°æœ‰ç”¨åˆ°copyout\nç´§æ¥ç€æˆ‘çŠ¯äº†ç¬¬ä¸‰ä¸ªé”™è¯¯ï¼Œå°è¯•ä»usertestsæ‰¾åˆ°é”™è¯¯åŸå› ï¼Œä¿®æ”¹addrsæ¥ç†è§£é”™è¯¯è€Œä¸æ˜¯ç†è§£readï¼Œäºæ˜¯å¯¼è‡´é—®é¢˜æ›´åŠ å¥‡æ€ªï¼ˆæˆ‘å°†aiä»1å¼€å§‹testsè¿‡äº†ï¼‰äºæ˜¯æˆ‘å‘ç°é”™è¯¯å‘ç”Ÿåœ¨å°è¯•å†™å…¥ç¬¬ä¸€ä¸ªé¡µè¡¨ï¼Œä¸”ç¬¬ä¸€ä¸ªé¡µè¡¨çš„å†…å®¹è¢«ä¿®æ”¹äº†ï¼Œå†…å­˜ä¿®æ”¹å¯¼è‡´äº†ä¸å¯ç†è§£çš„é”™è¯¯ï¼Œå¯¼è‡´æˆ‘åœ¨ä¿®æ”¹addrsçš„ç¬¬ä¸€ä¸ªå€¼æ—¶å‘ç”Ÿusertrapçš„scauseå€¼éƒ½ä¸åŒ\næœ€åæˆ‘æ‰å»é˜…è¯»äº†sys_readçš„æºç ï¼Œå‘ç°è°ƒç”¨äº†copyoutï¼Œé”™è¯¯åœ¨äºæˆ‘æ²¡æœ‰åœ¨if (*pte \u0026 PTE_COW)ä¸æˆç«‹åreturn -1 å¯¼è‡´ä¸å¯å†™å…¥çš„å†…å­˜è¢«ä¿®æ”¹ï¼Œæ‰€ä»¥ä¿®æ”¹æ¡†æ¶ä»£ç æ˜¯å±é™©çš„ï¼Œbugæ˜¯æ— æ³•é¿å…çš„ï¼Œæµ‹è¯•æ˜¯é‡è¦çš„ã€‚\nåœ¨copyoutä¸­åŠ å…¥COWæœºåˆ¶æ”¯æŒ å¯¹äºè°ƒè¯•ï¼Œå†æ¬¡å¼•ç”¨PA\nCAUTION ä¸è¦ä½¿ç”¨\"ç›®å…‰è°ƒè¯•æ³•\", è¦æ€è€ƒå¦‚ä½•ç”¨æ­£ç¡®çš„å·¥å…·å’Œæ–¹æ³•å¸®åŠ©è°ƒè¯•\nç¨‹åºè®¾è®¡è¯¾ä¸Šç›¯ç€å‡ åè¡Œçš„ç¨‹åº, ä½ æˆ–è®¸è¿˜èƒ½åœ¨å¤§è„‘ä¸­åƒNEMUé‚£æ ·æ¨¡æ‹Ÿç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹; ä½†ç¨‹åºè§„æ¨¡å¤§äº†ä¹‹å, å¾ˆå¿«ä½ å°±ä¼šæ”¾å¼ƒçš„: ä½ çš„å¤§è„‘ä¸å¯èƒ½æ¨¡æ‹Ÿå¾—äº†ä¸€ä¸ªå·¨å¤§çš„çŠ¶æ€æœº æˆ‘ä»¬å­¦ä¹ è®¡ç®—æœºæ˜¯ä¸ºäº†å­¦ä¹ è®¡ç®—æœºçš„å·¥ä½œåŸç†, è€Œä¸æ˜¯å­¦ä¹ å¦‚ä½•åƒè®¡ç®—æœºé‚£æ ·æœºæ¢°åœ°å·¥ä½œ ä½¿ç”¨\n1 assert() è®¾ç½®æ£€æŸ¥ç‚¹, æ‹¦æˆªéé¢„æœŸæƒ…å†µ\nä¾‹å¦‚assert(p != NULL)å°±å¯ä»¥æ‹¦æˆªç”±ç©ºæŒ‡é’ˆè§£å¼•ç”¨å¼•èµ·çš„æ®µé”™è¯¯ ç»“åˆå¯¹ç¨‹åºæ‰§è¡Œè¡Œä¸ºçš„ç†è§£, ä½¿ç”¨\n1 printf() æŸ¥çœ‹ç¨‹åºæ‰§è¡Œçš„æƒ…å†µ(æ³¨æ„å­—ç¬¦ä¸²è¦æ¢è¡Œ)\nprintf()è¾“å‡ºä»»æ„ä¿¡æ¯å¯ä»¥æ£€æŸ¥ä»£ç å¯è¾¾æ€§: è¾“å‡ºäº†ç›¸åº”ä¿¡æ¯, å½“ä¸”ä»…å½“ç›¸åº”çš„ä»£ç å—è¢«æ‰§è¡Œ printf()è¾“å‡ºå˜é‡çš„å€¼, å¯ä»¥æ£€æŸ¥å…¶å˜åŒ–è¿‡ç¨‹ä¸åŸå›  ä½¿ç”¨GDBè§‚å¯Ÿç¨‹åºçš„ä»»æ„çŠ¶æ€å’Œè¡Œä¸º\næ‰“å°å˜é‡, æ–­ç‚¹, ç›‘è§†ç‚¹, å‡½æ•°è°ƒç”¨æ ˆâ€¦ å¦‚æœä½ çªç„¶è§‰å¾—ä¸Šè¿°æ–¹æ³•å¾ˆæœ‰é“ç†, è¯´æ˜ä½ åœ¨ç¨‹åºè®¾è®¡è¯¾ä¸Šæ²¡æœ‰å—åˆ°è¯¥æœ‰çš„è®­ç»ƒ.\nSome concepts Intr_on 1 2 3 4 5 6 // enable device interrupts static inline void intr_on() { w_sstatus(r_sstatus() | SSTATUS_SIE); } åœ¨å¤„ç†æŸäº›å…³é”®çš„ä¸­æ–­ç›¸å…³æ“ä½œï¼ˆæ¯”å¦‚ä¿å­˜ä¸Šä¸‹æ–‡åˆ°æ ˆä¸­ï¼‰æ—¶ï¼Œä¸­æ–­æ˜¯è¢«ç¦æ­¢çš„ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿åœ¨å¤„ç†è¿™äº›å…³é”®æ•°æ®æ—¶ä¸ä¼šè¢«å…¶ä»–ä¸­æ–­æ‰“æ–­ã€‚ç­‰åˆ°è¿™äº›æ“ä½œå®Œæˆï¼Œå³æ³¨é‡Šä¸­è¯´çš„â€œdone with those registersâ€ä¹‹åï¼Œå†é€šè¿‡intr_on()å¼€å¯ä¸­æ–­ï¼Œå…è®¸åç»­çš„ä¸­æ–­å‘ç”Ÿã€‚è¿™æ ·æ—¢ä¿è¯äº†å…³é”®æ“ä½œçš„åŸå­æ€§ï¼Œåˆä¸ä¼šé•¿æ—¶é—´å…³é—­ä¸­æ–­ï¼Œå½±å“ç³»ç»Ÿçš„å“åº”èƒ½åŠ›ã€‚\nè¿™æ®µä»£ç çš„ä½œç”¨æ˜¯åœ¨ç¡®ä¿å…³é”®å¯„å­˜å™¨ï¼ˆå¦‚sepcã€scauseã€sstatusï¼‰å·²ç»è¢«å¤„ç†ä¹‹åï¼Œé€šè¿‡è®¾ç½®sstatuså¯„å­˜å™¨çš„SIEä½æ¥é‡æ–°å¼€å¯ç›‘ç®¡è€…æ¨¡å¼ä¸‹çš„ä¸­æ–­ï¼Œä»è€Œå…è®¸è®¾å¤‡ä¸­æ–­çš„å“åº”ï¼Œé¿å…åœ¨å¤„ç†è¿™äº›å¯„å­˜å™¨æ—¶è¢«ä¸­æ–­æ‰“æ–­å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚\né¡µæ•…éšœå¼‚å¸¸çš„å¤„ç†éœ€è¦ç²¾ç¡®åœ°ç®¡ç†å†…å­˜çš„æ˜ å°„å…³ç³»ï¼Œé€šå¸¸åŒ…æ‹¬é¡µé¢åˆ†é…ã€é¡µè¡¨æ›´æ–°ã€è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„ç­‰ã€‚æ­¤æ—¶å¦‚æœå¯ç”¨äº†ä¸­æ–­ï¼ˆé€šè¿‡ intr_on()ï¼‰ï¼Œå¯èƒ½ä¼šå¯¼è‡´å…¶ä»–ä¸­æ–­ï¼ˆå¦‚å®šæ—¶å™¨ä¸­æ–­ã€I/O ä¸­æ–­ç­‰ï¼‰å¹²æ‰°å½“å‰å†…å­˜ç®¡ç†çš„æ“ä½œï¼Œä»è€Œç ´åå†…å­˜çŠ¶æ€çš„ä¸€è‡´æ€§ã€‚ é¡µæ•…éšœé€šå¸¸æ˜¯ç”±ç”¨æˆ·ç¨‹åºè®¿é—®äº†ä¸åœ¨ç‰©ç†å†…å­˜ä¸­çš„è™šæ‹Ÿåœ°å€æ‰€å¼•èµ·çš„ï¼Œå› æ­¤æ“ä½œç³»ç»Ÿéœ€è¦åœ¨å†…æ ¸ä¸­ç›´æ¥å¤„ç†è¿™äº›å¼‚å¸¸ã€‚æ­¤æ—¶éœ€è¦ä¿è¯å½“å‰å¼‚å¸¸å¤„ç†æµç¨‹çš„å®Œæ•´æ€§ä¸åŸå­æ€§ï¼Œè€Œä¸è¢«å…¶ä»–ä¸­æ–­æ‰“æ–­ã€‚\nLab6. Net åœ¨MIT finalçš„ç»Ÿè®¡ä¸­è·å¾—äº†æœ€å¤šçš„unhelpfulï¼Œå®ç°ç½‘å¡é©±åŠ¨å’Œudp serverï¼Œæ–‡æ¡£å¥½å¤šä¸æƒ³çœ‹ï¼ˆ\nLab7. Lock 1. memory allocator è¿™ä¸€éƒ¨åˆ†éœ€è¦è§£å†³å†…å­˜åˆ†é…å‘ç”Ÿçš„é”äº‰ç”¨é—®é¢˜ï¼Œé”äº‰ç”¨çš„æ ¹æœ¬åŸå› æ˜¯ kallocåªæœ‰ä¸€ä¸ªç©ºé—²åˆ—è¡¨ï¼Œç”±ä¸€ä¸ªé”ä¿æŠ¤ã€‚è¦æ¶ˆé™¤é”äº‰ç”¨ï¼Œå¿…é¡»é‡æ–°è®¾è®¡å†…å­˜åˆ†é…å™¨ã€‚åŸºæœ¬æ€æƒ³æ˜¯ä¸ºæ¯ä¸ª CPU ç»´æŠ¤ä¸€ä¸ªç©ºé—²åˆ—è¡¨ï¼Œæ¯ä¸ªåˆ—è¡¨éƒ½æœ‰è‡ªå·±çš„é”ã€‚ä¸åŒ CPU ä¸Šçš„åˆ†é…å’Œé‡Šæ”¾å¯ä»¥å¹¶è¡Œè¿è¡Œï¼Œå› ä¸ºæ¯ä¸ª CPU å°†åœ¨ä¸åŒçš„freelistä¸Šæ“ä½œã€‚ä¸»è¦æŒ‘æˆ˜æ˜¯å¤„ç†ä¸€ä¸ª CPU çš„freelistä¸ºç©ºï¼Œä½†å¦ä¸€ä¸ª CPU çš„åˆ—è¡¨æœ‰freelistçš„æƒ…å†µï¼›åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸€ä¸ª CPU å¿…é¡»â€œçªƒå–â€å¦ä¸€ä¸ª CPU ç©ºé—²åˆ—è¡¨çš„ä¸€éƒ¨åˆ†ã€‚\nä½¿ç”¨referencesæ¥ç»Ÿè®¡cpuidçš„freelistå¤§å°ï¼Œå½“æŸä¸ªç©ºé—²åˆ—è¡¨å†…å­˜ä¸å¤Ÿæ—¶çªƒå–referencesæœ€å¤§çš„CPUfreelist\nä¸ºæ¯ä¸ªCPUç»´æŠ¤ä¸€ä¸ªç©ºé—²åˆ—è¡¨ï¼Œè§£å†³é”äº‰ç”¨é—®é¢˜ åˆå§‹åŒ–freelistå’Œreferences\nåˆå§‹åŒ–freelistå’Œreferences kfreeçš„æ–°å®ç° è®¾è®¡æ–°çš„kallocå’Œkfree\næ–°çš„kallocå®ç° æ–°çš„kfreeå®ç°ä»£ç  2. buffer cache è¿™ä¸€éƒ¨åˆ†éœ€è¦è§£å†³bufferç¼“å­˜è®¿é—®çš„é”äº‰ç”¨é—®é¢˜ï¼Œè¿™ä¸ªlabå®˜ç½‘å†™çš„æ¯”è¾ƒæ¨¡ç³Šï¼Œç†è§£èµ·æ¥æ¯”è¾ƒå›°éš¾ï¼Œè€Œä¸”bcachetestä¸å¤Ÿå¥å£®ï¼Œå¾ˆå¤šéšè—é—®é¢˜æ˜¯æµ‹è¯•ä¸å‡ºæ¥çš„ï¼Œç”šè‡³ä»£ç å®ç°å®Œå…¨æœ‰é—®é¢˜å’Œbugéƒ½å¯èƒ½è¿‡æµ‹è¯•ï¼Œå»ºè®®å®Œæˆåå‚è€ƒä¸€ä¸‹å¤§ä½¬çš„Blogï¼Œä¸‹é¢æœ‰å¾ˆå¤šå…³äºè¿™ä¸ªlabçš„è®¨è®ºï¼Œæ£€æŸ¥æœ‰æ²¡æœ‰æ²¡è€ƒè™‘çš„é”äº‰ç”¨/æ­»é”æƒ…å†µ\nåˆšçœ‹è¿™ä¸ªlabå’Œå®˜ç½‘çš„ä»‹ç»å®Œå…¨ä¸ç†è§£å¦‚ä½•åˆ©ç”¨å­˜å‚¨bucketã€å“ˆå¸Œè¡¨æ¥ä¼˜åŒ–é”äº‰ç”¨é—®é¢˜ï¼Œæˆ‘ç”¨aiå¸®åŠ©ç†è§£äº†ä¸€ä¸‹ï¼š\ndeepseek: å‰å®ç°å¯èƒ½ä½¿ç”¨äº†ä¸€ä¸ªå…¨å±€é”ï¼ˆæ¯”å¦‚bcache.lockï¼‰æ¥ä¿æŠ¤æ•´ä¸ªç¼“å­˜é“¾è¡¨ã€‚å½“å¤šä¸ªè¿›ç¨‹åŒæ—¶è®¿é—®ä¸åŒçš„å—æ—¶ï¼Œè¿™ä¸ªå…¨å±€é”ä¼šæˆä¸ºç“¶é¢ˆï¼Œå¯¼è‡´é”ç«äº‰ï¼Œä»è€Œå¢åŠ acquireçš„è¿­ä»£æ¬¡æ•°ã€‚\nç”¨æˆ·å»ºè®®ä½¿ç”¨å“ˆå¸Œæ¡¶å’Œæ¯ä¸ªæ¡¶çš„é”æ¥æ›¿ä»£åŸæ¥çš„å…¨å±€é”ã€‚è¿™æ ·ï¼Œä¸åŒçš„å—å¯èƒ½åˆ†å¸ƒåˆ°ä¸åŒçš„æ¡¶ä¸­ï¼Œæ¯ä¸ªæ¡¶æœ‰è‡ªå·±çš„é”ã€‚è¿™æ ·ï¼Œå½“è®¿é—®ä¸åŒæ¡¶ä¸­çš„å—æ—¶ï¼Œå°±ä¸ä¼šç«äº‰åŒä¸€æŠŠé”ï¼Œä»è€Œå‡å°‘å†²çªã€‚è¿™åº”è¯¥èƒ½æœ‰æ•ˆé™ä½é”çš„äº‰ç”¨ã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘éœ€è¦ä¿®æ”¹bgetå’Œbrelseå‡½æ•°ã€‚åŸæ¥çš„å®ç°å¯èƒ½æ˜¯åœ¨å…¨å±€é”çš„ä¿æŠ¤ä¸‹éå†æ•´ä¸ªé“¾è¡¨æŸ¥æ‰¾å—ã€‚ç°åœ¨åº”è¯¥æ›¿æ¢ä¸ºå“ˆå¸Œè¡¨æŸ¥æ‰¾ï¼Œæ¯ä¸ªæ¡¶æœ‰è‡ªå·±çš„é”ã€‚è¿™æ ·ï¼Œå½“æŸ¥æ‰¾ä¸€ä¸ªå—æ—¶ï¼Œåªéœ€è¦é”ä½å¯¹åº”çš„æ¡¶ï¼Œè€Œä¸æ˜¯æ•´ä¸ªç¼“å­˜ã€‚\néœ€è¦åšçš„ä¸»è¦æ­¥éª¤å¯èƒ½æœ‰ï¼š\nå®šä¹‰å“ˆå¸Œæ¡¶çš„æ•°é‡ï¼Œä¾‹å¦‚ä½¿ç”¨è´¨æ•°ï¼ˆå¦‚13ï¼‰ä½œä¸ºæ¡¶çš„æ•°é‡ï¼Œä»¥å‡å°‘å“ˆå¸Œå†²çªã€‚ ä¸ºæ¯ä¸ªå“ˆå¸Œæ¡¶åˆ†é…ä¸€ä¸ªé”ï¼Œåç§°ä»¥â€œbcacheâ€å¼€å¤´ï¼Œæ¯”å¦‚â€œbcache.bucket0â€ã€‚ åœ¨bgetå‡½æ•°ä¸­ï¼Œå…ˆæ ¹æ®å—å·è®¡ç®—å“ˆå¸Œå€¼ï¼Œæ‰¾åˆ°å¯¹åº”çš„æ¡¶ï¼Œå¹¶è·å–è¯¥æ¡¶çš„é”ã€‚ åœ¨è¯¥æ¡¶çš„é“¾è¡¨ä¸­æŸ¥æ‰¾å—æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™è·å–è¯¥bufçš„é”ï¼Œå¯èƒ½å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå¹¶é‡Šæ”¾æ¡¶é”ã€‚ å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™éœ€è¦æ‰¾åˆ°ä¸€ä¸ªæœªè¢«ä½¿ç”¨çš„ç¼“å†²åŒºï¼ˆrefcnt == 0ï¼‰ã€‚æ­¤æ—¶å¯èƒ½éœ€è¦éå†æ‰€æœ‰ç¼“å†²åŒºæˆ–è€…æœ‰å¦ä¸€ç§æ–¹å¼æŸ¥æ‰¾ã€‚ä½†è¿™é‡Œå¯èƒ½éœ€è¦å¤„ç†å¤šä¸ªæ¡¶çš„æƒ…å†µï¼Œæ¯”å¦‚éå†å…¶ä»–æ¡¶æ¥å¯»æ‰¾å¯æ›¿æ¢çš„å—ã€‚è¿™æ—¶å€™å¯èƒ½éœ€è¦è·å–å…¶ä»–æ¡¶çš„é”ï¼Œéœ€è¦æ³¨æ„æ­»é”é—®é¢˜ã€‚ å½“æ›¿æ¢å—æ—¶ï¼Œå¯èƒ½éœ€è¦å°†åŸæ¥çš„bufä»ä¸€ä¸ªæ¡¶ç§»åŠ¨åˆ°å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ¶‰åŠåˆ°ä¸¤ä¸ªæ¡¶çš„é”ï¼Œå¿…é¡»æŒ‰é¡ºåºè·å–ï¼Œé¿å…æ­»é”ã€‚ä¾‹å¦‚ï¼Œæ€»æ˜¯å…ˆè·å–æ—§æ¡¶çš„é”ï¼Œå†è·å–æ–°æ¡¶çš„é”ï¼Œæˆ–è€…æŒ‰ç…§ä¸€å®šçš„é¡ºåºè·å–ã€‚ åŸæ¥çš„LRUæœºåˆ¶éœ€è¦è¢«ç§»é™¤ï¼Œæ‰€ä»¥brelseä¸éœ€è¦å°†å—ç§»åŠ¨åˆ°LRUé“¾è¡¨ã€‚å› æ­¤ï¼Œbrelseå¯èƒ½åªéœ€è¦ä¿®æ”¹å¼•ç”¨è®¡æ•°ï¼Œå¹¶åœ¨é‡Šæ”¾æ—¶ä¸éœ€è¦è·å–å…¨å±€é”ï¼Œè€Œæ˜¯å¯èƒ½è·å–å¯¹åº”æ¡¶çš„é”æˆ–è€…bufçš„é”ã€‚\næ€»ç»“æ¥è¯´ï¼ŒåŸæ¥çš„ç¼“å­˜ä½¿ç”¨ä¸€ä¸ªåŒç«¯å¾ªç¯é“¾è¡¨æ¥ç»´æŠ¤ï¼Œå¯¼è‡´buffer cacheå¿…é¡»ä½¿ç”¨ä¸€ä¸ªå…¨å±€é”ï¼Œå¯¼è‡´å¤šè¿›ç¨‹è®¿é—®ç¼“å­˜å¾ˆå®¹æ˜“äº§ç”Ÿé”äº‰ç”¨ï¼Œç°åœ¨è¿›è¡Œä¼˜åŒ–ï¼Œå°†å¤§å°ä¸ºNBUFçš„ç¼“å­˜åˆ†å­˜å‚¨åˆ°Nä¸ªæ¡¶ï¼Œæ¯æ¬¡æŸ¥æ‰¾ç¼“å­˜åªä¼šæ‰¾å¯¹åº”çš„æ¡¶ï¼Œå¦‚ä½•æ‰¾å¯¹åº”çš„æ¡¶ï¼Ÿä½¿ç”¨å“ˆå¸Œè¡¨(æ•£åˆ—æ¡¶)å»ºç«‹æ˜ å°„ï¼Œæ¯ä¸ªå“ˆå¸Œè¡¨é¡¹å¯¹åº”ä¸€ä¸ªæ¡¶ï¼Œæ¡¶ä¸­å­˜å‚¨ä¸€ä¸ªé“¾è¡¨ï¼ˆå­˜å‚¨ç¼“å­˜ï¼‰ï¼Œæˆ‘ç®€å•åœ°å°†blocknoè½¬åŒ–ä¸ºå“ˆå¸Œå€¼è¿›è¡Œæ˜ å°„ã€‚å¦‚æœåœ¨è¯¥æ¡¶ä¸­æ²¡æœ‰æ‰¾åˆ°ç¼“å­˜ï¼Œè¯´æ˜åœ¨æ‰€æœ‰çš„æ¡¶ä¸­éƒ½ä¸åº”è¯¥å­˜åœ¨è¯¥ç¼“å­˜ï¼Œéœ€è¦åœ¨è¯¥æ¡¶ä¸­æ·»åŠ æ–°çš„ç¼“å­˜ï¼ˆå¦‚ä½•æ²¡æœ‰èƒ½å­˜å‚¨ï¼ˆrefcnt=0ï¼‰çš„bufï¼Œéœ€è¦ä»åˆ«çš„æ¡¶ä¸­move bufï¼‰ã€‚å¦å¤–éœ€è¦ä¸ºæ¯ä¸ªæ¡¶æ·»åŠ é”ï¼Œé˜²æ­¢åŒæ—¶å¯¹æ¡¶çš„å†™å…¥é€ æˆå¹¶å‘å†²çªï¼Œå¦å¤–éœ€è¦ä¸€ä¸ªå…¨å±€é”ç»´æŠ¤æ‰€æœ‰æ¡¶çš„é“¾è¡¨ç»“æ„ï¼Œé¿å…ä¸¤ä¸ªè¿›ç¨‹åŒæ—¶å‘èµ·move bufé€ æˆç¯è·¯æ­»é”\nå»ºç«‹å“ˆå¸Œå‡½æ•°\n1 2 #define BUCKETS_NUM 13 #define HASH_SEATCH(blockno) (blockno % BUCKETS_NUM) // find the bucket æ–°å»ºç«‹çš„ç¼“å­˜ç»“æ„ä½“\n1 2 3 4 5 6 7 8 struct { // new buffer cache struct spinlock lock; // global lock for move buf struct buf buf[NBUF]; // buffer cache less than NBUF struct buf buckets[BUCKETS_NUM]; // use buckets to store and get cache struct spinlock bucketlock[BUCKETS_NUM]; // bucket lock instead of the global lock } bcache; åˆå§‹åŒ–buffer cache\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 void binit(void) { struct buf *b; // init global lock initlock(\u0026bcache.lock, \"bcache\"); // Each bucket starts with a double-ended circular linked list // Set head'refcnt to 1 to indicate that it cannot be moved. for (int i = 0; i \u003c BUCKETS_NUM; i++) { initlock(\u0026bcache.bucketlock[i], \"bcachelock\"); bcache.buckets[i].next = \u0026bcache.buckets[i]; bcache.buckets[i].prev = \u0026bcache.buckets[i]; bcache.buckets[i].refcnt = 1; } // Initialize each buffer cache and store in buckets for (b = bcache.buf; b \u003c bcache.buf + NBUF; b++) { initsleeplock(\u0026b-\u003elock, \"buffer\"); b-\u003enext = bcache.buckets[0].next; b-\u003eprev = \u0026bcache.buckets[0]; bcache.buckets[0].next-\u003eprev = b; bcache.buckets[0].next = b; } } æ–°çš„bget\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 static struct buf* bget(uint dev, uint blockno) { struct buf *b; // search the bucket without global lock if ((b = bucketsearch(dev, blockno)) != 0) return b; acquire(\u0026bcache.lock); // search the bucket with global lock if ((b = bucketsearch(dev, blockno)) != 0) { release(\u0026bcache.lock); return b; } // find a buffer to move int new = HASH_SEATCH(blockno); for (int i = 0; i \u003c BUCKETS_NUM; i++) { // start from the key int old = (new + i) % BUCKETS_NUM; b = bcache.buckets[old].prev; // search current bucket for buf while (b != \u0026bcache.buckets[old]) { if (b-\u003erefcnt == 0) { // get both the old and the new bucket lock to move acquire(\u0026bcache.bucketlock[old]); if (old != new) acquire(\u0026bcache.bucketlock[new]); if ((b = bufmove(b, old, new)) != 0) { b-\u003edev = dev; b-\u003eblockno = blockno; b-\u003evalid = 0; b-\u003erefcnt = 1; if (old != new) release(\u0026bcache.bucketlock[new]); acquiresleep(\u0026b-\u003elock); release(\u0026bcache.bucketlock[old]); release(\u0026bcache.lock); return b; } // can't reach here if (old != new) release(\u0026bcache.bucketlock[new]); release(\u0026bcache.bucketlock[old]); release(\u0026bcache.lock); panic(\"bget error\"); } b = b-\u003eprev; } } // can't reach here release(\u0026bcache.lock); panic(\"bget: no buffers\"); } åœ¨å¯¹åº”æ¡¶ä¸­å¯»æ‰¾buffer cache\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // Find the cache in the bucket corresponding to blockno static struct buf* bucketsearch(uint dev, uint blockno) { struct buf *b; int key = HASH_SEATCH(blockno); // Accessing the bucket requires the corresponding lock acquire(\u0026bcache.bucketlock[key]); for (b = bcache.buckets[key].next; b != \u0026bcache.buckets[key]; b = b-\u003enext) { if (b-\u003edev == dev \u0026\u0026 b-\u003eblockno == blockno) { b-\u003erefcnt++; release(\u0026bcache.bucketlock[key]); acquiresleep(\u0026b-\u003elock); return b; } } release(\u0026bcache.bucketlock[key]); return 0; } å®ç°buffer move\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // move the buf from the old bucket to the new bucket static struct buf* bufmove(struct buf *b, int old, int new) { if (old == new) return b; // Put the buffer in the prev of new bucket head b-\u003eprev-\u003enext = b-\u003enext; b-\u003enext-\u003eprev = b-\u003eprev; b-\u003enext = \u0026bcache.buckets[new]; b-\u003eprev = bcache.buckets[new].prev; bcache.buckets[new].prev-\u003enext = b; bcache.buckets[new].prev = b; return b; } æ–°çš„brelseï¼Œå°†æ–°çš„buffer cacheæ”¾åœ¨bucket head\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 void brelse(struct buf *b) { if(!holdingsleep(\u0026b-\u003elock)) panic(\"brelse\"); releasesleep(\u0026b-\u003elock); int key = HASH_SEATCH(b-\u003eblockno); acquire(\u0026bcache.bucketlock[key]); b-\u003erefcnt--; if (b-\u003erefcnt == 0) { // Put the buffer in the next of new bucket head for quicker search struct buf *head = \u0026bcache.buckets[key]; b-\u003eprev-\u003enext = b-\u003enext; b-\u003enext-\u003eprev = b-\u003eprev; b-\u003enext = head-\u003enext; head-\u003enext-\u003eprev = b; head-\u003enext = b; b-\u003eprev = head; } release(\u0026bcache.bucketlock[key]); } ä¿®æ”¹bpinå’Œbupinçš„lock\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 void bpin(struct buf *b) { int key = HASH_SEATCH(b-\u003eblockno); acquire(\u0026bcache.bucketlock[key]); b-\u003erefcnt++; release(\u0026bcache.bucketlock[key]); } void bunpin(struct buf *b) { int key = HASH_SEATCH(b-\u003eblockno); acquire(\u0026bcache.bucketlock[key]); b-\u003erefcnt--; release(\u0026bcache.bucketlock[key]); } Lab8. Fs 1. large files è¿™ä¸ªéƒ¨åˆ†éœ€è¦ä¿®æ”¹bmapæ¥æ”¯æŒå¤§æ–‡ä»¶ï¼Œbmapåœ¨readiå’Œwriteiä¸­è°ƒç”¨ï¼Œè¿”å›è¯»å–æˆ–å†™å…¥çš„æ•°æ®å—ï¼Œå¦‚æœæ²¡æœ‰åˆ†é…åˆ™éœ€è¦åœ¨inodeçš„addrä¸­åŠ å…¥æŒ‡é’ˆæŒ‡å‘æ•°æ®å—ã€‚\nåŸæ¥inodeæœ‰13ä¸ªåœ°å€æŒ‡é’ˆï¼Œå…¶ä¸­12ä¸ªç›´æ¥æŒ‡å‘æ•°æ®å—ï¼Œç¬¬13ä¸ªä¸ªæŒ‡å‘blockï¼Œå¹¶è¿›è¡Œä¸€æ¬¡æ˜ å°„BSIZE / sizeof(uint)ä¸ªæŒ‡é’ˆã€‚ç°åœ¨éœ€è¦æ”¯æŒlarge fileï¼Œå°†åŸæ¥çš„ä¸€ä¸ªç›´æ¥æ˜ å°„æŒ‡é’ˆè½¬å˜ä¸ºäºŒæ¬¡æ˜ å°„æŒ‡é’ˆã€‚\nä¿®æ”¹NDIRECTçš„å®šä¹‰ï¼Œå¢åŠ NDBDIRECTçš„å®šä¹‰ï¼Œå¯¹åº”ä¿®æ”¹inodeçš„ç»“æ„ä½“\n1 2 3 4 5 6 7 8 9 10 11 12 13 #define NDIRECT 11 #define NINDIRECT (BSIZE / sizeof(uint)) #define NDBINDIRECT ((BSIZE / sizeof(uint)) * (BSIZE / sizeof(uint))) #define MAXFILE (NDIRECT + NINDIRECT + NDBINDIRECT) // On-disk inode structure struct dinode { short type; // File type short major; // Major device number (T_DEVICE only) short minor; // Minor device number (T_DEVICE only) short nlink; // Number of links to inode in file system uint size; // Size of file (bytes) uint addrs[NDIRECT+2]; // Data block addresses }; ä¿®æ”¹bmapçš„å®ç°ï¼Œå¢åŠ äºŒæ¬¡æ˜ å°„çš„éƒ¨åˆ†\naddrs[NDIRECT+1]æŒ‡å‘ç¬¬ä¸€ä¸ªblockï¼Œä¸åŒäºaddrs[NDIRECT]blockçš„æŒ‡é’ˆç›´æ¥æŒ‡å‘æ•°æ®å—ï¼Œè¿™é‡Œçš„blockéœ€è¦ç»§ç»­åˆ†é…æŒ‡é’ˆæŒ‡å‘æ–°çš„blockï¼Œä¸€å…±åˆ†é…256 x 256çš„æ•°æ®å—\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 bn -= NINDIRECT; if (bn \u003c NDBINDIRECT) { if ((addr = ip-\u003eaddrs[NDIRECT+1]) == 0) { addr = balloc(ip-\u003edev); if (addr == 0) return 0; ip-\u003eaddrs[NDIRECT+1] = addr; } for (int level = 2; level \u003e 0; level--) { int n = (level == 2 ? bn / NINDIRECT : bn % NINDIRECT); bp = bread(ip-\u003edev, addr); a = (uint *)bp-\u003edata; if ((addr = a[n]) == 0) { addr = balloc(ip-\u003edev); if (addr) { a[n] = addr; log_write(bp); } else return 0; } brelse(bp); } return addr; } panic(\"bmap: out of range\"); 2. symbolic links è¿™ä¸€éƒ¨åˆ†éœ€è¦å®ç°sys_symlinkç³»ç»Ÿè°ƒç”¨å®ç°è½¯é“¾æ¥ï¼Œç±»ä¼¼äºln -s\né¦–å…ˆå°†å‚æ•°è§£æè¿‘targetå’Œpathï¼Œå¹¶å¼€å¯æ—¥å¿—è®°å½•ï¼Œç„¶åç»™é“¾æ¥çš„ç›®æ ‡pathåˆ›å»ºinodeï¼ŒåŒæ—¶å‘inodeçš„æ•°æ®å—å†™å…¥é“¾æ¥çš„æ–‡ä»¶å\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 uint64 sys_symlink(void) { char path[MAXPATH]; char target[MAXPATH]; struct inode *ip; int n, r; if ((n = argstr(0, target, MAXPATH)) \u003c 0) return -1; if ((n = argstr(1, path, MAXPATH)) \u003c 0) return -1; begin_op(); ip = create(path, T_SYMLINK, 0, 0); if (ip == 0) { end_op(); return -1; } if ((r = writei(ip, 0, (uint64)target, 0, strlen(target)+1)) \u003c strlen(target)+1) { iunlockput(ip); end_op(); return -1; } iunlockput(ip); end_op(); return 0; } ä¿®æ”¹sys_openç³»ç»Ÿè°ƒç”¨ï¼Œä½¿å…¶èƒ½å¤Ÿå¤„ç†ç±»å‹ä¸ºT_Symlinkçš„æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 int depth = 0; while (ip-\u003etype == T_SYMLINK \u0026\u0026 !(omode \u0026 O_NOFOLLOW)) { int r = 0; char addr[MAXPATH]; if ((r = readi(ip, 0, (uint64)addr, 0, MAXPATH)) \u003c= 0) { iunlockput(ip); end_op(); return -1; } iunlockput(ip); if ((ip = namei(addr)) == 0) { end_op(); return -1; } ilock(ip); if (++depth \u003e 9) { iunlockput(ip); end_op(); return -1; } } Lab9. mmap åˆæ˜¯ä¸€ä¸ªå•ç‹¬çš„hard labï¼Œè¿™äº›å•åˆ—çš„hard labéƒ½é¢‡å…·æŒ‘æˆ˜\nè¿™ä¸ªlabéœ€è¦å®ç°mmapç³»ç»Ÿè°ƒç”¨å’Œmunmapç³»ç»Ÿè°ƒç”¨ï¼Œmmapç³»ç»Ÿè°ƒç”¨ç”¨äºå°†æ–‡ä»¶çš„æ•°æ®å—è™šæ‹ŸåŒ–ä¸ºå†…å­˜ï¼Œè®©ç”¨æˆ·å¯ä»¥ç›´æ¥è¯»å†™å†…å­˜æ¥æ¨¡æ‹Ÿå®ç°è¯»å–æ–‡ä»¶ï¼Œå®ç°çš„ç»†èŠ‚å¾ˆå¤šï¼Œåé¢ç›´æ¥å˜æˆé¢å‘test debugäº†\nå…·ä½“å®ç°å’Œç›¸å…³è¯­å¥çš„ä½œç”¨ç›´æ¥å†™åœ¨æ³¨é‡Šé‡Œï¼š\nå¼€å§‹çš„æ—¶å€™æˆ‘æŠŠvmaç›¸å…³çš„ç”¨æˆ·å†…å­˜ä»ä½åœ°å€å¼€å§‹å¯»æ‰¾ï¼Œä½†æ˜¯ç”±äºä½åœ°å€ä¸ä»…å­˜æ”¾forkåçˆ¶è¿›ç¨‹çš„é¡µè¡¨æ•°æ®ï¼Œè€Œä¸”å†å¾€ä¸Šæ˜¯å‘ä¸‹ç”Ÿé•¿çš„æ ˆï¼Œä¼šå‘ç”Ÿä¸å¯é¢„çŸ¥çš„é”™è¯¯ã€‚æ‰€ä»¥vmaçš„åœ°å€è®¾ç½®åœ¨ç”¨æˆ·å†…å­˜çš„æœ€é«˜å¤„ï¼ˆtrapframeä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 uint64 sys_mmap(void) { int index; int fd; uint64 va; struct VMA vma; struct proc *p = myproc(); // get args argaddr(0, \u0026vma.addr); argint(1, \u0026vma.len); vma.len = PGROUNDUP(vma.len); argint(2, \u0026vma.prot); argint(3, \u0026vma.flags); if (argfd(4, \u0026fd, \u0026vma.f) \u003c 0) return -1; argint(5, \u0026vma.offset); // check prot and flags // å¦‚æœè®¾ç½®ä¸ºMAP_SHAREDéœ€è¦æ£€æŸ¥è¯¥æ–‡ä»¶æ˜¯å¦èƒ½å¤Ÿè¯»å…¥ if (!(vma.flags \u0026 MAP_PRIVATE) \u0026\u0026 ((!vma.f-\u003ereadable \u0026\u0026 (vma.prot \u0026 PROT_READ)) || (!vma.f-\u003ewritable \u0026\u0026 (vma.prot \u0026 PROT_WRITE)))) return -1; // find a vma to store for (index = 0; index \u003c NVMA; index++) if (!p-\u003evmas[index].len) break; if (index == NVMA) panic(\"sys_mmap: no VMA to free\"); p-\u003evmas[index] = vma; // å¢åŠ æ–‡ä»¶çš„refè®¡æ•° filedup(p-\u003evmas[index].f); // find a va space to map for (va = VMABASE; va \u003e 0; va -= PGSIZE) { if ((walkaddr(p-\u003epagetable, va)) != 0) continue; // æ£€æŸ¥å†å¾€ä¸‹çš„å†…å­˜æ˜¯å¦è¢«map uint64 vaend = va; for (; va \u003e vaend - vma.len; va -= PGSIZE) if ((walkaddr(p-\u003epagetable, va)) != 0) break; // æ£€æŸ¥è¿™é‡Œçš„å†…å­˜æ˜¯å¦æ˜¯æœªè¢«åŠ è½½çš„vma if (va == vaend - vma.len \u0026\u0026 conflictdet(p-\u003evmas, va + PGSIZE, vma.len)) { p-\u003evmas[index].addr = va + PGSIZE; p-\u003evmas[index].base = va + PGSIZE; // baseéœ€è¦ç”¨äºä¹‹åå†™å…¥æ–‡ä»¶ break; } } if (p-\u003evmas[index].addr) return p-\u003evmas[index].addr; else return -1; } æ£€æŸ¥vaæ˜¯å¦ä¸å­˜åœ¨çš„vmaäº§ç”Ÿå†²çª\n1 2 3 4 5 6 7 8 9 10 11 12 13 int conflictdet(struct VMA *vmas, uint64 va, int len) { for (int i = 0; i \u003c NVMA; i++) { if (vmas[i].len) { uint64 left = vmas[i].addr; uint64 right = vmas[i].addr + vmas[i].len; if (va \u003c right \u0026\u0026 va+len \u003e= left) return i; } } return -1; } å†è¯»å…¥scauseä¸º13å’Œ15æ—¶å¤„ç†page fault\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 int pagefaulthandler(uint64 fault_addr) { int n; uint64 va; uint64 pa; char *mem; struct VMA *vma; struct proc *p = myproc(); // æ£€æŸ¥fault_addræ˜¯å¦ä½äºvmaå†…å­˜åŒºåŸŸ int index; if ((index = conflictdet(p-\u003evmas, fault_addr, 0)) == -1) { printf(\"page fault: addr not assigned\\n\"); return -1; } vma = \u0026p-\u003evmas[index]; va = PGROUNDDOWN(fault_addr); // å¦‚æœå·²è¢«æ˜ å°„ä½†ä»è§¦å‘page faultå¯èƒ½æ˜¯å°è¯•å†™å…¥ä¸å¯å†™é¡µé¢ if ((pa = walkaddr(p-\u003epagetable, fault_addr)) != 0) if (!(PA2PTE(pa) \u0026 PTE_W)) return -1; if ((mem = kalloc()) == 0) { printf(\"page fault: Page Fault: no free memory\\n\"); return -1; } memset(mem, 0, PGSIZE); // è¿›è¡Œfileçš„æ“ä½œéœ€è¦æŒæœ‰é” // å°†fileçš„å†…å­˜è¯»å…¥ç‰©ç†å†…å­˜ ilock(vma-\u003ef-\u003eip); if ((n = readi(vma-\u003ef-\u003eip, 0, (uint64)mem, vma-\u003eoffset + va - vma-\u003eaddr, PGSIZE)) \u003c 0) { printf(\"page fault: read file fail\\n\"); iunlock(vma-\u003ef-\u003eip); return -1; } iunlock(vma-\u003ef-\u003eip); // å°†vaæ˜ å°„åˆ°pa // protä¸PTEçš„æƒé™å­˜åœ¨`\u003c\u003c1`çš„å…³ç³» if (mappages(p-\u003epagetable, va, PGSIZE, (uint64)mem, PTE_U | (vma-\u003eprot \u003c\u003c 1)) != 0) { kfree(mem); printf(\"Page Fault: mmap map fault\\n\"); return -1; } return 0; } å®ç°munmapç³»ç»Ÿè°ƒç”¨ï¼Œå…³äºoffsetæœ‰ä¸€äº›idealçš„å‡è®¾ï¼Œæ¯”å¦‚ä¸ä¼šé‡Šæ”¾ä¸€æ®µvmaä¸­é—´çš„å†…å­˜\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 uint64 sys_munmap(void) { int length; int writelen; int index; uint64 addr; uint64 writeaddr; struct VMA *vma; struct inode *ip; struct proc *p = myproc(); argaddr(0, \u0026addr); argint(1, \u0026length); if ((index = conflictdet(p-\u003evmas, addr, 0)) == -1) panic(\"munmap: not assigned addr\"); vma = \u0026p-\u003evmas[index]; ip = vma-\u003ef-\u003eip; // æ£€æŸ¥å†™å…¥çš„é•¿åº¦å’Œåœ°å€æ˜¯å¦ä¼šå¯¼è‡´å†™å…¥å¤šä½™å†…å­˜(åˆ†é…æ—¶å‘ä¸ŠPGROUNDUPï¼Œå­˜åœ¨éƒ¨åˆ†å†…å­˜ä¸åº”è¢«ä½¿ç”¨) writelen = addr - vma-\u003ebase + vma-\u003eoffset + length \u003e ip-\u003esize ? (ip-\u003esize - (addr - vma-\u003ebase + vma-\u003eoffset)) : length; if (writelen \u003c 0) writelen = 0; writeaddr = vma-\u003eoffset + addr - vma-\u003ebase \u003e ip-\u003esize ? (vma-\u003eoffset) : vma-\u003eoffset + addr - vma-\u003ebase; if (vma-\u003eflags \u0026 MAP_SHARED) { // åœ¨fs_system call å‰è°ƒç”¨begin_op begin_op(); ilock(ip); if ((writei(ip, 1, addr, writeaddr, writelen)) \u003c 0) { iunlock(ip); end_op(); printf(\"writelen:%d\\n\", writelen); panic(\"mumap: write back error\"); } iunlock(ip); end_op(); } vmaunmap(p-\u003epagetable, addr, PGROUNDUP(length) / PGSIZE, 1); vma-\u003elen -= PGROUNDUP(length); if (vma-\u003elen) { if (addr == vma-\u003eaddr) vma-\u003eaddr += PGROUNDUP(length); } else fileclose(vma-\u003ef); return 0; } åœ¨forkæ—¶å°†çˆ¶è¿›ç¨‹çš„vmaä¿¡æ¯å¤åˆ¶åˆ°å­è¿›ç¨‹ï¼Œç®€å•è€ƒè™‘ï¼Œä»–ä»¬æ²¡æœ‰å…±äº«é¡µé¢ï¼Œä¸”ç”±äºæ˜ å°„åœ¨é«˜åœ°å€å¤„ï¼Œä¸ä¼šå—uvmcopyå½±å“\n1 2 3 4 5 6 7 for (i = 0; i \u003c NVMA; i++) { vma = \u0026p-\u003evmas[i]; if (vma-\u003elen) { np-\u003evmas[i] = *vma; filedup(vma-\u003ef); } } exitæ—¶é‡Šæ”¾vmaçš„èµ„æº\n1 2 3 4 5 6 7 for (; vma \u003c= \u0026p-\u003evmas[NVMA-1]; vma++) { if (vma-\u003elen) { vmaunmap(p-\u003epagetable, vma-\u003eaddr, PGROUNDUP(vma-\u003elen) / PGSIZE, 1); fileclose(vma-\u003ef); vma-\u003elen = 0; } } è¿˜ä¼šæœ‰æ›´å¤šçš„ç»†èŠ‚ï¼Œnotesé‡Œä¹Ÿåšä¸åˆ°é¢é¢ä¿±åˆ°ï¼Œä¸Šæ‰‹è°ƒè¯•æ‰èƒ½æ„Ÿå—åˆ°â€¦\n",
  "wordCount" : "13899",
  "inLanguage": "en",
  "datePublished": "2025-08-27T11:00:00+08:00",
  "dateModified": "2025-08-27T11:00:00+08:00",
  "author":{
    "@type": "Person",
    "name": "Anekoique"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/mit6.1810/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Anekoique's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/img/head.jpg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Anekoique&#39;s Blog (Alt + H)">Anekoique&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about/" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;Â»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      MIT6.1810 Labç®€è®°
    </h1>
    <div class="post-meta"><span title='2025-08-27 11:00:00 +0800 CST'>2025-08-27</span>&nbsp;Â·&nbsp;28 min&nbsp;Â·&nbsp;Anekoique

</div>
  </header> 
<div class="toc-sidebar" id="toc-sidebar">
    <div class="toc-container">
        <div class="toc-header">
            <span class="toc-title">Table of Contents</span>
        </div>
        <nav class="toc-nav"><ul>
                <li>
                    <a href="#lab1-util" aria-label="Lab1. Util">Lab1. Util</a></li>
                <li>
                    <a href="#lab2-syscall" aria-label="Lab2. Syscall">Lab2. Syscall</a><ul>
                    
                <li>
                    <a href="#1-debug--gdb" aria-label="1. debug &amp; gdb">1. debug &amp; gdb</a></li>
                <li>
                    <a href="#2-strace" aria-label="2. strace">2. strace</a></li>
                <li>
                    <a href="#3-attack" aria-label="3. attack">3. attack</a><ul>
                    
                <li>
                    <a href="#attacktestc" aria-label="attacktest.c">attacktest.c</a></li>
                <li>
                    <a href="#secretc" aria-label="secret.c">secret.c</a></li>
                <li>
                    <a href="#attackc" aria-label="attack.c">attack.c</a></li>
                <li>
                    <a href="#xv6%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86" aria-label="xv6å†…å­˜ç®¡ç†">xv6å†…å­˜ç®¡ç†</a><ul>
                    
                <li>
                    <a href="#fork" aria-label="fork">fork</a></li>
                <li>
                    <a href="#exec" aria-label="exec">exec</a></li>
                <li>
                    <a href="#sbrk" aria-label="sbrk">sbrk</a></li>
                <li>
                    <a href="#wait" aria-label="wait">wait</a></li></ul>
                </li>
                <li>
                    <a href="#answer" aria-label="Answer">Answer</a></li></ul>
                </li>
                <li>
                    <a href="#some-concepts" aria-label="Some concepts">Some concepts</a></li></ul>
                </li>
                <li>
                    <a href="#lab3-pgtbl" aria-label="Lab3. Pgtbl">Lab3. Pgtbl</a><ul>
                    
                <li>
                    <a href="#1-inspect-pgtbl" aria-label="1. Inspect pgtbl">1. Inspect pgtbl</a></li>
                <li>
                    <a href="#2-speed-syscall" aria-label="2. speed syscall">2. speed syscall</a></li>
                <li>
                    <a href="#3-print-pgtbl" aria-label="3. print pgtbl">3. print pgtbl</a></li>
                <li>
                    <a href="#4-superpages" aria-label="4. superpages">4. superpages</a></li></ul>
                </li>
                <li>
                    <a href="#lab4-traps" aria-label="Lab4. Traps">Lab4. Traps</a><ul>
                    
                <li>
                    <a href="#1-risc-v-asmma" aria-label="1. RISC-V asmma">1. RISC-V asmma</a></li>
                <li>
                    <a href="#2-backtrace" aria-label="2. backtrace">2. backtrace</a></li>
                <li>
                    <a href="#3-alarm" aria-label="3. alarm">3. alarm</a></li>
                <li>
                    <a href="#some-concepts-1" aria-label="Some concepts">Some concepts</a></li></ul>
                </li>
                <li>
                    <a href="#lab5-cow" aria-label="Lab5. Cow">Lab5. Cow</a><ul>
                    
                <li>
                    <a href="#cow%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86" aria-label="cowå·¥ä½œåŸç†">cowå·¥ä½œåŸç†</a></li>
                <li>
                    <a href="#answer-1" aria-label="Answer">Answer</a></li>
                <li>
                    <a href="#%e5%85%b3%e4%ba%8e%e8%b0%83%e8%af%95" aria-label="å…³äºè°ƒè¯•">å…³äºè°ƒè¯•</a></li>
                <li>
                    <a href="#some-concepts-2" aria-label="Some concepts">Some concepts</a></li></ul>
                </li>
                <li>
                    <a href="#lab6-net" aria-label="Lab6. Net">Lab6. Net</a></li>
                <li>
                    <a href="#lab7-lock" aria-label="Lab7. Lock">Lab7. Lock</a><ul>
                    
                <li>
                    <a href="#1--memory-allocator" aria-label="1.  memory allocator">1.  memory allocator</a></li>
                <li>
                    <a href="#2--buffer-cache" aria-label="2.  buffer cache">2.  buffer cache</a><ul>
                    
                <li>
                    <a href="#deepseek" aria-label="deepseek:">deepseek:</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#lab8-fs" aria-label="Lab8. Fs">Lab8. Fs</a><ul>
                    
                <li>
                    <a href="#1-large-files" aria-label="1. large files">1. large files</a></li>
                <li>
                    <a href="#2-symbolic-links" aria-label="2. symbolic links">2. symbolic links</a></li></ul>
                </li>
                <li>
                    <a href="#lab9-mmap" aria-label="Lab9. mmap">Lab9. mmap</a>
                </li>
            </ul>
        </nav>
        
        
        <div class="reading-progress">
            <div class="progress-bar" id="reading-progress-bar"></div>
        </div>
    </div>
</div>


<div class="toc-toggle" id="toc-toggle" title="åˆ‡æ¢ç›®å½•">
    <span>â€¹</span>
</div>
  <div class="post-content"><p>the course is the new version of 6.828 and 6.s081ï¼ˆ24 fallï¼‰</p>
<div class="callout callout-important">
  <div class="callout-header">
    <span class="callout-icon"><svg width="16" height="16" viewBox="0 0 16 16"><path fill="currentColor" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/></svg></span>
    <span class="callout-title">IMPORTANT</span>
  </div>
  <div class="callout-content">
    <p>æˆ‘ä»¬å·²ç»åœ¨ä½ å­¦é•¿å­¦å§çš„å®éªŒæŠ¥å‘Šä¸­å¤šæ¬¡çœ‹åˆ°ç±»ä¼¼çš„æ‚”æ¨: å› ä¸ºæ²¡æœ‰åŠæ—¶è®°å½•å®éªŒå¿ƒå¾—è€Œåœ¨ç¼–å†™å®éªŒæŠ¥å‘Šçš„æ—¶å€™å¿˜è®°äº†è‡ªå·±ç»å†è¶£äº‹çš„ç»†èŠ‚. ä¸ºäº†å’ŒåŠ©æ•™ä»¬åˆ†äº«ä½ çš„å„ç§å®éªŒç»å†, æˆ‘ä»¬å»ºè®®ä½ åœ¨å®éªŒè¿‡ç¨‹ä¸­éšæ—¶è®°å½•å®éªŒå¿ƒå¾—, æ¯”å¦‚è‡ªå·±è¸©è¿‡çš„å¤§å‘, æˆ–è€…æ˜¯è°ƒäº†ä¸€å‘¨ä¹‹åæ‰å‘ç°çš„ä¸€ä¸ªå¼±æ™ºbug, ç­‰ç­‰.</p>
<p>æˆ‘ä»¬ç›¸ä¿¡, å½“ä½ åšå®ŒPAå›è¿‡å¤´æ¥é˜…è¯»è¿™äº›å¿ƒå¾—çš„æ—¶å€™, å°±ä¼šå‘ç°è¿™å¯¹ä½ æ¥è¯´æ˜¯ä¸€ç¬”å®è´µçš„è´¢å¯Œ.</p>

  </div>
</div>
<p>åœ¨åšPAçš„æ—¶å€™å¿½ç•¥äº†è¿™ä¸€æé†’ï¼Œ<strong>å› ä¸ºæ²¡æœ‰åŠæ—¶è®°å½•å®éªŒå¿ƒå¾—è€Œå¿˜è®°äº†è‡ªå·±ç»å†è¶£äº‹çš„ç»†èŠ‚</strong> &#x1f62d;æ‰€ä»¥ç‰¢è®°æ•™è®­ç®€å•è®°å½•Labçš„å®Œæˆè¿‡ç¨‹</p>
<h2 id="lab1-util">Lab1. Util<a hidden class="anchor" aria-hidden="true" href="#lab1-util">#</a></h2>
<h2 id="lab2-syscall">Lab2. Syscall<a hidden class="anchor" aria-hidden="true" href="#lab2-syscall">#</a></h2>
<h3 id="1-debug--gdb">1. debug &amp; gdb<a hidden class="anchor" aria-hidden="true" href="#1-debug--gdb">#</a></h3>
<p>some useful debugging tips and tools</p>
<ul>
<li>
<p>backtrace(bt)</p>
<ul>
<li>frame [num/up/down]</li>
<li>info locals/args</li>
</ul>
</li>
<li>
<p>kernel/kernel.asm</p>
</li>
<li>
<p>addr2line</p>
</li>
<li>
<p>script</p>
</li>
<li>
<p>qemu monitor [ctrl-a-c]</p>
</li>
</ul>
<h3 id="2-strace">2. strace<a hidden class="anchor" aria-hidden="true" href="#2-strace">#</a></h3>
<p>The entire system call process</p>
<h3 id="3-attack">3. attack<a hidden class="anchor" aria-hidden="true" href="#3-attack">#</a></h3>
<p>ç›®å‰æœ€éš¾çš„éƒ¨åˆ†ï¼Œä¸åˆç†çš„æ˜¯å®ƒæŠŠè¿™ä¸ªlabæ”¾åœ¨é¡µè¡¨ä¹‹å‰ï¼Œå¦‚æœæ²¡çœ‹è¿‡é¡µè¡¨è¿™é‡Œè‚¯å®šåšä¸å‡ºæ¥ï¼›ä½†åˆç†çš„æ˜¯é¡µè¡¨åªæ¶‰åŠæœ€åŸºæœ¬çš„ï¼Œæ›´ä¸»è¦çš„éƒ¨åˆ†æ˜¯system callå’Œé¡µè¡¨çš„ç»“åˆã€‚</p>
<p>è¿™ä¸ªlabçš„ç²¾å·§ä¹‹å¤„åœ¨äºå°†attack xv6ä½œä¸ºå¼•å­ï¼Œé€šè¿‡ä¸è™šæ‹Ÿå†…å­˜ç›¸å…³çŸ¥è¯†ä¸²èµ·äº†fork exec sbrkç­‰sysctem callï¼Œå¯ä»¥åŸºæœ¬äº†è§£xv6çš„è™šæ‹Ÿå†…å­˜ç®¡ç†ã€ç”¨æˆ·è¿›ç¨‹å†…å­˜çš„æ’å¸ƒä»¥åŠå’Œkernelçš„äº¤äº’ã€‚</p>
<p>ç”¨æˆ·è¿›ç¨‹å¤„æ¶‰åŠåˆ°äº†ä¸»è¦ä¸‰ä¸ªæ–‡ä»¶attacktest.c,attack.c,secret.c</p>
<h4 id="attacktestc">attacktest.c<a hidden class="anchor" aria-hidden="true" href="#attacktestc">#</a></h4>
<p>å…ˆä½¿ç”¨forkåˆ›å»ºæ–°è¿›ç¨‹ï¼Œå¹¶é€šè¿‡execç³»ç»Ÿè°ƒç”¨æ‰§è¡Œsecret.cå†™å…¥ç§˜å¯†</p>
<div class="image-container"><div class="tech-diagram"><img src="/images/image-20250211211758086.png" 
       alt="attacktest.c forkåˆ›å»ºæ–°è¿›ç¨‹æ‰§è¡Œsecret.c" 
       class="img-large tech-diagram"
       loading="lazy" /></div><div class="image-caption">å…ˆä½¿ç”¨forkåˆ›å»ºæ–°è¿›ç¨‹ï¼Œå¹¶é€šè¿‡execç³»ç»Ÿè°ƒç”¨æ‰§è¡Œsecret.cå†™å…¥ç§˜å¯†</div></div>
<p>å†ä½¿ç”¨forkåˆ›å»ºæ–°è¿›ç¨‹ï¼Œå¹¶é€šè¿‡execç³»ç»Ÿè°ƒç”¨æ‰§è¡Œattack.cæ‰¾åˆ°å…ˆå‰åœ¨å†…å­˜å†™å…¥çš„ç§˜å¯†</p>
<div class="image-container"><div class="tech-diagram"><img src="/images/image-20250211212211195.png" 
       alt="attacktest.c forkåˆ›å»ºæ–°è¿›ç¨‹æ‰§è¡Œattack.c" 
       class="img-large tech-diagram"
       loading="lazy" /></div><div class="image-caption">å†ä½¿ç”¨forkåˆ›å»ºæ–°è¿›ç¨‹ï¼Œå¹¶é€šè¿‡execç³»ç»Ÿè°ƒç”¨æ‰§è¡Œattack.cæ‰¾åˆ°å…ˆå‰åœ¨å†…å­˜å†™å…¥çš„ç§˜å¯†</div></div>
<h4 id="secretc">secret.c<a hidden class="anchor" aria-hidden="true" href="#secretc">#</a></h4>
<p>ä½¿ç”¨sbrkç³»ç»Ÿè°ƒç”¨ç”³è¯·å†…å­˜ç©ºé—´åï¼Œé€šè¿‡endåœ¨å†…å­˜å†™å…¥ç§˜å¯†ï¼Œå†™å…¥çš„ä½ç½®åœ¨ç”³è¯·çš„ä½ç½®ä¹‹å PGSIZE*9+32 å¤„</p>
<div class="image-container"><div class="tech-diagram"><img src="/images/image-20250211212440584.png" 
       alt="secret.cä½¿ç”¨sbrkç”³è¯·å†…å­˜" 
       class="img-large tech-diagram"
       loading="lazy" /></div><div class="image-caption">ä½¿ç”¨sbrkç³»ç»Ÿè°ƒç”¨ç”³è¯·å†…å­˜ç©ºé—´åï¼Œé€šè¿‡endåœ¨å†…å­˜å†™å…¥ç§˜å¯†</div></div>
<h4 id="attackc">attack.c<a hidden class="anchor" aria-hidden="true" href="#attackc">#</a></h4>
<p>éœ€è¦åœ¨attack.cæ‰¾åˆ°ä¹‹å‰å†™å…¥çš„ç§˜å¯†è¿›è¡Œattackï¼Œå…³é”®åœ¨ç†æ¸…xv6å¯¹è™šæ‹Ÿå†…å­˜çš„ç®¡ç†åˆ†é…å¹¶åœ¨è¿™ä¸ªæ–°è¿›ç¨‹æ‰¾åˆ°ä¹‹å‰å†™å…¥çš„ç‰©ç†å†…å­˜é¡µ</p>
<div class="image-container"><div class="tech-diagram"><img src="/images/image-20250211213253997.png" 
       alt="attack.céœ€è¦æ‰¾åˆ°å†™å…¥çš„ç§˜å¯†" 
       class="img-large tech-diagram"
       loading="lazy" /></div><div class="image-caption">éœ€è¦åœ¨attack.cæ‰¾åˆ°ä¹‹å‰å†™å…¥çš„ç§˜å¯†è¿›è¡Œattack</div></div>
<h4 id="xv6å†…å­˜ç®¡ç†">xv6å†…å­˜ç®¡ç†<a hidden class="anchor" aria-hidden="true" href="#xv6å†…å­˜ç®¡ç†">#</a></h4>
<p>attacktest.cè¿è¡Œsecret.cå’Œsh.cè¿è¡Œattacktest.cä¸€æ ·éƒ½æ˜¯é€šè¿‡<code>fork</code>å’Œ<code>exec</code>æ¥æ‰§è¡Œä¸€ä¸ªæ–°çš„ç¨‹åº</p>
<p>è¿™é‡Œä»¥å»ºç«‹secret.cä¸ºä¾‹ï¼Œä»ç³»ç»Ÿè°ƒç”¨æ¥çœ‹xv6çš„å†…å­˜ç®¡ç†</p>
<h5 id="fork">fork<a hidden class="anchor" aria-hidden="true" href="#fork">#</a></h5>
<p><code>fork</code>æ¶‰åŠåˆ°çš„å†…å­˜åˆ†é…ä¸»è¦æ˜¯<code>allocproc</code>å’Œ<code>uvmcopy</code></p>
<div class="image-container"><div class="tech-diagram"><img src="/images/image-20250211214706503.png" 
       alt="allocprocå†…å­˜åˆ†é…" 
       class="img-large tech-diagram"
       loading="lazy" /></div><div class="image-caption">allocprocä¸ºè¿›ç¨‹åˆ†é…ç‰©ç†å†…å­˜å¹¶å»ºç«‹é¡µè¡¨æ˜ å°„</div></div>
<p><code>allocproc</code>ä¸ºå…ˆä¸ºè¿›ç¨‹åˆ†é…ç‰©ç†å†…å­˜å¹¶å»ºç«‹é¡µè¡¨æ˜ å°„ï¼Œä¸€å…±åˆ†é…äº†å››é¡µï¼Œ<code>allocproc</code>åå®ç°äº†æ“ä½œç³»ç»Ÿç®¡ç†è¿›ç¨‹çš„ä¸€ä¸ªé¡µè¡¨ï¼Œé¡µè¡¨ç®¡ç†äº†è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜æ˜ å°„</p>
<p>ï¼ˆç›®å‰æ˜ å°„äº†<code>trapoline</code>ï¼ˆè™šæ‹Ÿå†…å­˜åœ°å€æœ€å¤§å¤„ï¼‰å’Œ<code>trapframe</code>ï¼ˆ<code>traponine</code>ä¹‹ä¸‹ï¼‰ï¼‰</p>
<ul>
<li><code>trapframe</code>ä¸€é¡µ</li>
<li><code>pagetable</code>ä¸€é¡µ ï¼ˆ<code>proc_pagetable</code>ä¸­<code>uvmcreate</code>å‡½æ•°åˆ†é…ï¼‰</li>
<li>å®¹æ˜“é—å¿˜çš„æ˜¯xv6è¿è¡Œåœ¨Sv39 RISC-Vä¸Š,ä½¿ç”¨ä¸‰çº§é¡µè¡¨ï¼Œåœ¨å»ºç«‹<code>trapoline</code>å’Œ<code>trapframe</code>çš„è™šæ‹Ÿå†…å­˜æ˜ å°„æ—¶éœ€è¦åˆ†é…ä¸¤ä¸ªç‰©ç†å†…å­˜é¡µç”¨ä½œé¡µç›®å½•</li>
</ul>
<div class="image-container"><div class="tech-diagram"><img src="/images/image-20250211220357855.png" 
       alt="xv6ä¸‰çº§é¡µè¡¨ç»“æ„" 
       class="img-large tech-diagram"
       loading="lazy" /></div><div class="image-caption">xv6è¿è¡Œåœ¨Sv39 RISC-Vä¸Šï¼Œä½¿ç”¨ä¸‰çº§é¡µè¡¨</div></div>
<p><code>uvmcopy</code>ç»™å®šçˆ¶è¿›ç¨‹çš„é¡µè¡¨ï¼Œå°†å…¶å†…å­˜å¤åˆ¶åˆ°å­è¿›ç¨‹çš„é¡µè¡¨ä¸­ã€‚ï¼ˆçˆ¶è¿›ç¨‹åˆ†é…äº†å¤šå°‘ç‰©ç†é¡µï¼Œå­è¿›ç¨‹ä¹Ÿåˆ†é…åŒæ ·å¤§å°å¹¶å¤åˆ¶ï¼Œå¹¶åœ¨è™šæ‹Ÿå†…å­˜æœ€ä½å¤„å»ºç«‹æ˜ å°„ï¼‰è¿™é‡Œåˆ†é…äº†6é¡µï¼ˆå››é¡µç‰©ç†å†…å­˜å¤åˆ¶ï¼Œä¸¤é¡µç”¨ä½œé¡µç›®å½•ï¼‰</p>
<div class="image-container"><div class="tech-diagram"><img src="/images/image-20250211222138305.png" 
       alt="uvmcopyå¤åˆ¶çˆ¶è¿›ç¨‹å†…å­˜" 
       class="img-large tech-diagram"
       loading="lazy" /></div><div class="image-caption">uvmcopyç»™å®šçˆ¶è¿›ç¨‹çš„é¡µè¡¨ï¼Œå°†å…¶å†…å­˜å¤åˆ¶åˆ°å­è¿›ç¨‹</div></div>
<h5 id="exec">exec<a hidden class="anchor" aria-hidden="true" href="#exec">#</a></h5>
<p><code>exec</code>è¦åšçš„å°±æ˜¯è½½å…¥elfæ–‡ä»¶å¹¶æ‰§è¡Œ</p>
<p>åœ¨<code>exec</code>çš„å®ç°ä¸­ï¼Œä¼šä½¿ç”¨<code>proc_pagetable</code>åˆ›å»ºæ–°çš„é¡µè¡¨æ¥æ›¿æ¢æ—§é¡µè¡¨ï¼ˆ<code>exec</code>ä½œç”¨å°±æ˜¯æ›¿æ¢æ•´ä¸ªç¨‹åºé•œåƒï¼Œç›¸å½“äºä»å¤´å¼€å§‹æ‰§è¡Œä¸€ä¸ªæ–°çš„ç¨‹åºï¼Œä¹‹å‰ç¨‹åºçš„ç›¸å…³å†…å®¹å…¨éƒ¨ä¸¢å¼ƒï¼‰<code>proc_pagetable</code>ä¼šåˆ†é…3é¡µ</p>
<p>æ¥ç€ï¼Œ<code>exec</code>éå†elfæ–‡ä»¶çš„program headerï¼Œå°†LOADæ®µåŠ è½½è¿›å†…å­˜ä¸­ã€‚å…·ä½“æ˜¯é€šè¿‡<code>uvmalloc</code>åˆ†é…ç‰©ç†å†…å­˜ï¼Œ<code>loadseg</code>å°†æ®µåŠ è½½è¿›å†…å­˜ã€‚xv6ç¨‹åºçš„elfæ–‡ä»¶åŒ…å«ä¸¤ä¸ªLOADæ®µï¼Œdataæ®µå’Œtextæ®µï¼Œå¯ä»¥é€šè¿‡readelfçœ‹ä¸€ä¸‹.è¿™ä¸¤ä¸ªæ®µåˆ†åˆ«åŠ è½½åˆ°è™šæ‹Ÿå†…å­˜çš„ç¬¬0é¡µå’Œç¬¬1é¡µä¸­ã€‚åŒç†ï¼Œè¿™ä¸¤é¡µå±äºä½åœ°å€çš„ç”¨æˆ·å†…å­˜ï¼Œéœ€è¦4é¡µï¼ˆ2é¡µç›®å½•+2é¡µç‰©ç†é¡µï¼‰æ¥åˆ†åˆ«å­˜æ”¾è¿™ä¸¤ä¸ªæ®µ</p>
<div class="image-container"><div class="tech-diagram"><img src="/images/image-20250211234042570.png" 
       alt="execåŠ è½½ç¨‹åºæ®µ" 
       class="img-large tech-diagram"
       loading="lazy" /></div><div class="image-caption">execéå†elfæ–‡ä»¶çš„program headerï¼Œå°†LOADæ®µåŠ è½½è¿›å†…å­˜</div></div>
<p>å¦å¤–è¿˜ç”¨ä¸ºç”¨æˆ·å †æ ˆåˆ†é…å†…å­˜ï¼Œç¬¬ä¸€ä¸ªé¡µé¢ä½œä¸ºå †æ ˆä¿æŠ¤è€Œä¸å¯è®¿é—®ï¼Œå…¶ä½™é¡µé¢ç”¨ä½œç”¨æˆ·å †æ ˆ.è¿™é‡Œåˆ†é…2é¡µ</p>
<div class="image-container"><div class="tech-diagram"><img src="/images/image-20250211234437004.png" 
       alt="ç”¨æˆ·å †æ ˆåˆ†é…" 
       class="img-large tech-diagram"
       loading="lazy" /></div><div class="image-caption">ä¸ºç”¨æˆ·å †æ ˆåˆ†é…å†…å­˜ï¼Œç¬¬ä¸€ä¸ªé¡µé¢ä½œä¸ºå †æ ˆä¿æŠ¤</div></div>
<p><code>exec</code>ç»“æŸåéœ€è¦é‡Šæ”¾æ—§é¡µè¡¨å’Œæ—§ç”¨æˆ·å†…å­˜ï¼Œå…¶ä¸­çš„ä¸¤ä¸ª<code>uvmunmap</code>é‡Šæ”¾pteæ˜ å°„ï¼ˆé¿å…åç»­<code>uvmfree</code>çš„æ—¶å€™æ„å¤–é‡Šæ”¾trampolineå’Œtrapframeçš„ç‰©ç†å†…å­˜ï¼‰ï¼Œå¹¶ä¸é‡Šæ”¾ç‰©ç†é¡µï¼Œå› ä¸ºtrampolineæ˜¯æ•´ä¸ªæ“ä½œç³»ç»Ÿå…±äº«çš„ä¸éœ€è¦é‡Šæ”¾ï¼Œè€Œtrapframeæ˜¯ç”¨æˆ·æ€å’Œå†…æ ¸æ€è½¬æ¢æ—¶çš„ç”¨åˆ°çš„å­˜å‚¨åŒºåŸŸï¼Œååˆ†é‡è¦ï¼ŒåŒæ ·ä¸ä¼šé‡Šæ”¾ï¼ˆå…³äºtrapframeå’Œtrampolineçš„è¯¦ç»†è¯´æ˜å¯ä»¥æŸ¥é˜…book-riscvï¼‰ã€‚æœ€åçš„<code>uvmfree</code>åˆ™æ˜¯é‡Šæ”¾æ—§é¡µè¡¨å ç”¨çš„å†…å­˜ï¼ˆ5é¡µï¼‰ä»¥åŠç”¨æˆ·å†…å­˜ï¼ˆ4é¡µï¼‰ï¼Œå…±9é¡µã€‚</p>
<div class="image-container"><div class="tech-diagram"><img src="/images/image-20250211234609672.png" 
       alt="execé‡Šæ”¾å†…å­˜" 
       class="img-large tech-diagram"
       loading="lazy" /></div><div class="image-caption">execç»“æŸåé‡Šæ”¾æ—§é¡µè¡¨å’Œæ—§ç”¨æˆ·å†…å­˜</div></div>
<p>ç»¼ä¸Šï¼Œ<code>exec</code>ä¸€å…±åˆ†é…äº†3+4+2=9é¡µï¼Œç„¶ååˆé‡Šæ”¾äº†9é¡µã€‚</p>
<h5 id="sbrk">sbrk<a hidden class="anchor" aria-hidden="true" href="#sbrk">#</a></h5>
<p><code>sbrk</code>é€šè¿‡<code>growproc</code>åˆ†é…ç‰©ç†é¡µå¹¶å»ºç«‹æ˜ å°„ï¼Œåˆ†é…çš„æ˜¯å †ï¼Œä»ä½åœ°å€å‘ä¸Šå¢é•¿</p>
<div class="image-container"><div class="tech-diagram"><img src="/images/image-20250212000812725.png" 
       alt="sbrké€šè¿‡growprocåˆ†é…å†…å­˜" 
       class="img-large tech-diagram"
       loading="lazy" /></div><div class="image-caption">sbrké€šè¿‡growprocåˆ†é…ç‰©ç†é¡µå¹¶å»ºç«‹æ˜ å°„</div></div>
<h5 id="wait">wait<a hidden class="anchor" aria-hidden="true" href="#wait">#</a></h5>
<p>è¿›ç¨‹å†…å­˜çš„é‡Šæ”¾ä¸åœ¨exitä¸­è€Œåœ¨waitï¼Œç”±çˆ¶è¿›ç¨‹å‘èµ·ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„freeçš„é¡ºåºï¼Œå› ä¸ºxv6çš„ç©ºé—²å†…å­˜ç”±freelistç®¡ç†ï¼Œé€šè¿‡kallocåˆ†é…ç‰©ç†é¡µï¼Œkfreeé‡Šæ”¾ç‰©ç†é¡µï¼Œå¹¶å°†é‡Šæ”¾çš„ç‰©ç†é¡µæŒ‡å‘å½“å‰çš„freelistï¼Œå®ç°ç±»ä¼¼æ ˆçš„åè¿›å…ˆå‡ºæ¥åˆ†é…ç‰©ç†é¡µ</p>
<div class="image-container"><div class="tech-diagram"><img src="/images/image-20250211235229481.png" 
       alt="è¿›ç¨‹å†…å­˜çš„é‡Šæ”¾" 
       class="img-large tech-diagram"
       loading="lazy" /></div><div class="image-caption">è¿›ç¨‹å†…å­˜çš„é‡Šæ”¾ä¸åœ¨exitä¸­è€Œåœ¨waitï¼Œç”±çˆ¶è¿›ç¨‹å‘èµ·</div></div>
<p>å…ˆè°ƒç”¨<code>uvmunmap</code>ä»ä½åˆ°é«˜åœ°å€é‡Šæ”¾ç”¨æˆ·å†…å­˜ï¼Œæ ¹æ®ä¹‹å‰å†…å­˜åˆ†é…çš„åˆ†æï¼Œé‡Šæ”¾é¡ºåºä¸ºdataæ®µ+textæ®µã€ç”¨æˆ·æ ˆ+page guardã€32é¡µå †å†…å­˜ï¼ˆæ¯é¡µä»ä½åœ°å€é¡µåˆ°é«˜åœ°å€é¡µä¾æ¬¡é‡Šæ”¾/å…¥æ ˆï¼‰ï¼Œå…±36é¡µ</p>
<p>æœ€åé‡Šæ”¾é¡µè¡¨ï¼Œå…±5é¡µï¼ˆ5ä¸ªé¡µç›®å½•ï¼‰</p>
<p>æ­¤æ—¶æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œ<code>kmem</code>ç»´æŠ¤çš„ç©ºé—²é“¾è¡¨æ ˆï¼Œä»æ ˆé¡¶å¼€å§‹çš„é¡µä¾æ¬¡ä¸ºï¼š5é¡µé¡µè¡¨ã€ç¬¬32é¡µå †å†…å­˜ã€ç¬¬31é¡µå †å†…å­˜ã€&hellip;ã€ç¬¬10é¡µå †å†…å­˜ï¼ˆå¯†ç æ‰€åœ¨çš„é¡µï¼‰ã€&hellip;ã€ç¬¬1é¡µå †å†…å­˜ã€page guard&hellip;..trapframe</p>
<div class="image-container"><div class="tech-diagram"><img src="/images/image-20250211235834682.png" 
       alt="ç©ºé—²å†…å­˜ç®¡ç†" 
       class="img-large tech-diagram"
       loading="lazy" /></div><div class="image-caption">kmemç»´æŠ¤çš„ç©ºé—²é“¾è¡¨æ ˆï¼Œä»æ ˆé¡¶å¼€å§‹çš„é¡µä¾æ¬¡</div></div>
<h4 id="answer">Answer<a hidden class="anchor" aria-hidden="true" href="#answer">#</a></h4>
<p>attacktestè¿è¡Œattackçš„æ–¹å¼å’Œè¿è¡Œsecretçš„ä¸€æ ·ï¼Œéƒ½æ˜¯é€šè¿‡<code>fork</code>+<code>exec</code>ï¼Œç›´æ¥æ‹¿å‰é¢çš„åˆ†æç»“æœï¼Œæˆ‘ä»¬çŸ¥é“åœ¨å¼€å§‹æ‰§è¡Œattackç¨‹åºä¹‹å‰ï¼Œforkåˆ†é…äº†10é¡µï¼Œexecåˆ†é…9é¡µåˆé‡Šæ”¾äº†9é¡µï¼Œå…¶ä¸­forkåˆ†é…çš„10é¡µæ¥è‡ªäº5é¡µé¡µè¡¨ã€ç¬¬32 ~ 28é¡µå †å†…å­˜ï¼Œexecåˆ†é…çš„9é¡µæ¥è‡ªç¬¬27 ~ 18é¡µå †å†…å­˜ï¼Œåé¢åˆé‡Šæ”¾äº†9é¡µå›æ ˆé¡¶ï¼Œæ­¤æ—¶æ ˆé¡¶å¼€å§‹çš„é¡µä¾æ¬¡ä¸ºï¼š9é¡µã€ç¬¬17é¡µå †å†…å­˜ã€&hellip;ã€ç¬¬10é¡µå †å†…å­˜,ç§˜å¯†å°±åœ¨ç¬¬17é¡µä¸­ï¼ˆç§˜å¯†åœ¨ç¬¬10é¡µå †å†…å­˜å¤„ï¼‰ã€‚</p>
<ul>
<li>
<p>å¦å¤–ä¸€ä¸ª Questionï¼š<code>user/secret.c</code> copies the secret bytes to memory whose address is 32 bytes after the start of a page. Change the 32 to 0 and you should see that your attack doesn&rsquo;t work anymore; why not?</p>
</li>
<li>
<p>ä¸ºä»€ä¹ˆå°†ç§˜å¯†çš„é¡µå†…offsetæ”¹æˆ0å°±ä¸è¡Œäº†åªæœ‰&gt;=32çš„å€¼æ‰è¡Œï¼Œæ˜¯å› ä¸ºç³»ç»ŸæŠŠç©ºé—²é¡µå‰4ä¸ªå­—èŠ‚ä½œä¸ºé“¾å¼æ ˆçš„æŒ‡é’ˆäº†ï¼Œæ‰€ä»¥è¦†ç›–æ‰äº†ç§˜å¯†çš„å€¼</p>
</li>
</ul>
<h3 id="some-concepts">Some concepts<a hidden class="anchor" aria-hidden="true" href="#some-concepts">#</a></h3>
<ol>
<li>stack frame</li>
</ol>
<p>æ ˆå¸§ï¼ˆStack Frameï¼‰æ˜¯ç¨‹åºè¿è¡Œæ—¶åœ¨è°ƒç”¨æ ˆï¼ˆCall Stackï¼‰ä¸Šåˆ†é…çš„ä¸€æ®µå†…å­˜åŒºåŸŸï¼Œç”¨äºç®¡ç†<strong>å‡½æ•°è°ƒç”¨</strong>çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚å®ƒæ˜¯å‡½æ•°æ‰§è¡ŒæœŸé—´ä¸´æ—¶æ•°æ®çš„å­˜å‚¨ç©ºé—´ï¼Œä¹Ÿæ˜¯å®ç°å‡½æ•°åµŒå¥—è°ƒç”¨ã€è¿”å›å’Œå±€éƒ¨å˜é‡ç®¡ç†çš„æ ¸å¿ƒæœºåˆ¶ã€‚</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>é«˜åœ°å€ -&gt; | è°ƒç”¨è€…æ ˆå¸§ | 
</span></span><span style="display:flex;"><span>          | å½“å‰æ ˆå¸§   | &lt;- æ ˆé¡¶ï¼ˆesp/spï¼‰
</span></span><span style="display:flex;"><span>ä½åœ°å€
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>ecall</li>
</ol>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>User Program           Kernel/Handler
</span></span><span style="display:flex;"><span>â†“
</span></span><span style="display:flex;"><span>1. å‡†å¤‡å‚æ•°ï¼š
</span></span><span style="display:flex;"><span>   - ç³»ç»Ÿè°ƒç”¨å·å†™å…¥ a7
</span></span><span style="display:flex;"><span>   - å‚æ•°å†™å…¥ a0, a1, ...
</span></span><span style="display:flex;"><span>2. æ‰§è¡Œ ecall
</span></span><span style="display:flex;"><span>   â†“
</span></span><span style="display:flex;"><span>â†’ 3. CPU åˆ‡æ¢åˆ°æ›´é«˜ç‰¹æƒçº§
</span></span><span style="display:flex;"><span>   â†“
</span></span><span style="display:flex;"><span>â†’ 4. ä¿å­˜ä¸Šä¸‹æ–‡ï¼š
</span></span><span style="display:flex;"><span>     - PCï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰å­˜å…¥ sepc
</span></span><span style="display:flex;"><span>     - å¼‚å¸¸åŸå› å­˜å…¥ scause
</span></span><span style="display:flex;"><span>     - å½“å‰çŠ¶æ€å­˜å…¥ sstatus
</span></span><span style="display:flex;"><span>   â†“
</span></span><span style="display:flex;"><span>â†’ 5. è·³è½¬åˆ° stvec å¯„å­˜å™¨æŒ‡å‘çš„é™·é˜±å¤„ç†ç¨‹åº
</span></span><span style="display:flex;"><span>   â†“
</span></span><span style="display:flex;"><span>6. å†…æ ¸å¤„ç†ç³»ç»Ÿè°ƒç”¨
</span></span><span style="display:flex;"><span>   â†“
</span></span><span style="display:flex;"><span>7. æ‰§è¡Œ sret è¿”å›ç”¨æˆ·ç¨‹åº
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>register a7</li>
</ol>
<p>ç›´æ¥é€šè¿‡æ±‡ç¼–æŒ‡ä»¤å†™å…¥</p>
<p>é€šè¿‡é«˜çº§è¯­è¨€å°è£…å‡½æ•°å†™å…¥</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> msg[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Hello</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ç­‰ä»·äºæ±‡ç¼–ä¸­çš„ li a7, 64
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">syscall</span>(SYS_write, <span style="color:#ae81ff">1</span>, msg, <span style="color:#ae81ff">6</span>);  <span style="color:#75715e">// SYS_write=64
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">long</span> <span style="color:#a6e22e">syscall</span>(<span style="color:#66d9ef">long</span> num, ...) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">register</span> <span style="color:#66d9ef">long</span> a7 <span style="color:#66d9ef">asm</span>(<span style="color:#e6db74">&#34;a7&#34;</span>) <span style="color:#f92672">=</span> num;  <span style="color:#75715e">// å¼ºåˆ¶å°† num å­˜å…¥ a7
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">register</span> <span style="color:#66d9ef">long</span> a0 <span style="color:#66d9ef">asm</span>(<span style="color:#e6db74">&#34;a0&#34;</span>);        <span style="color:#75715e">// è¿”å›å€¼é€šè¿‡ a0 æ¥æ”¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">asm</span> <span style="color:#66d9ef">volatile</span> (
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ecall&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;=r&#34;</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;r&#34;</span>(a7), <span style="color:#e6db74">&#34;r&#34;</span>(a0), <span style="color:#e6db74">&#34;r&#34;</span>(a1), <span style="color:#e6db74">&#34;r&#34;</span>(a2)  <span style="color:#75715e">// å‚æ•°ä¾æ¬¡å­˜å…¥ a0-a2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;memory&#34;</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> a0;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>addrline</li>
</ol>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ addr2line -e my_program 0x401152
</span></span><span style="display:flex;"><span>&gt; /path/to/my_program.c:123
</span></span></code></pre></td></tr></table>
</div>
</div><table>
  <thead>
      <tr>
          <th style="text-align: left">é€‰é¡¹</th>
          <th style="text-align: left">ä½œç”¨</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><code>-f</code></td>
          <td style="text-align: left">æ˜¾ç¤ºå‡½æ•°åï¼ˆä¸ä»…æ˜¾ç¤ºæ–‡ä»¶åå’Œè¡Œå·ï¼‰ã€‚</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>-C</code></td>
          <td style="text-align: left">è§£ç  C++ ç¬¦å·ï¼ˆdemangleï¼Œå°†ç¼–è¯‘å™¨ç”Ÿæˆçš„ç¬¦å·è½¬ä¸ºå¯è¯»åç§°ï¼‰ã€‚</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>-p</code></td>
          <td style="text-align: left">ä»¥å¯è¯»æ ¼å¼è¾“å‡ºï¼ˆåŒ…å«æ–‡ä»¶åã€è¡Œå·å’Œå‡½æ•°åï¼‰ã€‚</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>-a</code></td>
          <td style="text-align: left">æ˜¾ç¤ºåŸå§‹åœ°å€ï¼ˆåœ¨è¾“å‡ºä¸­æ·»åŠ åœ°å€ä¿¡æ¯ï¼‰ã€‚</td>
      </tr>
      <tr>
          <td style="text-align: left"><code>-i</code></td>
          <td style="text-align: left">æ˜¾ç¤ºå†…è”å‡½æ•°ï¼ˆå¦‚æœå­˜åœ¨å†…è”å±•å¼€ï¼‰ã€‚</td>
      </tr>
  </tbody>
</table>
<ol start="5">
<li>script</li>
</ol>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ script qemu_output.log  <span style="color:#75715e"># æŒ‡å®šæ—¥å¿—æ–‡ä»¶åï¼ˆé»˜è®¤æ˜¯ typescriptï¼‰</span>
</span></span><span style="display:flex;"><span>$ make qemu æ‰€æœ‰è¾“å‡ºï¼ˆåŒ…æ‹¬å†…æ ¸æ—¥å¿—ã€è°ƒè¯•ä¿¡æ¯ï¼‰å°†è¢«å®æ—¶è®°å½•åˆ° qemu_output.log
</span></span><span style="display:flex;"><span>$ exit
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>trapframe</li>
</ol>
<p><code>trapframe</code> æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œç”¨æ¥ä¿å­˜å¤„ç†å™¨çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯åœ¨å‘ç”Ÿä¸­æ–­æˆ–é™·é˜±ï¼ˆtrapï¼‰æ—¶ã€‚å½“CPUè¢«ä¸­æ–­æˆ–é™·å…¥æŸä¸ªå¼‚å¸¸ï¼ˆä¾‹å¦‚ç³»ç»Ÿè°ƒç”¨ã€é¡µé”™è¯¯ç­‰ï¼‰æ—¶ï¼Œæ“ä½œç³»ç»Ÿéœ€è¦ä¿å­˜å½“å‰æ‰§è¡Œçš„çŠ¶æ€ï¼Œä»¥ä¾¿åç»­æ¢å¤ç¨‹åºçš„æ‰§è¡Œã€‚</p>
<p>åœ¨xv6ä¸­ï¼Œ<code>trapframe</code> ä¸»è¦ç”¨äºä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š</p>
<ol>
<li><strong>ä¸­æ–­å¤„ç†</strong>ï¼šå½“å‘ç”Ÿç¡¬ä»¶ä¸­æ–­ï¼ˆä¾‹å¦‚æ—¶é’Ÿä¸­æ–­æˆ–å¤–éƒ¨è®¾å¤‡ä¸­æ–­ï¼‰æ—¶ï¼Œå½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡éœ€è¦è¢«ä¿å­˜åˆ° <code>trapframe</code> ä¸­ï¼Œä»¥ä¾¿åœ¨ä¸­æ–­å¤„ç†å®Œæ¯•åèƒ½å¤Ÿæ¢å¤åˆ°ä¸­æ–­å‘ç”Ÿå‰çš„çŠ¶æ€ã€‚</li>
<li><strong>ç³»ç»Ÿè°ƒç”¨å¤„ç†</strong>ï¼šåœ¨ç³»ç»Ÿè°ƒç”¨è¿‡ç¨‹ä¸­ï¼ŒCPUä¼šäº§ç”Ÿä¸€ä¸ªé™·é˜±ï¼ˆtrapï¼‰ï¼Œè¿™æ—¶ä¹Ÿéœ€è¦ä¿å­˜å½“å‰ç”¨æˆ·ç¨‹åºçš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œç­‰ç³»ç»Ÿè°ƒç”¨å¤„ç†å®Œæ¯•åï¼Œå†æ¢å¤åˆ°ç”¨æˆ·ç¨‹åºç»§ç»­æ‰§è¡Œã€‚</li>
</ol>
<p><code>trapframe</code> çš„ç»“æ„é€šå¸¸åŒ…å«äº†ä»¥ä¸‹å‡ ä¸ªå…³é”®éƒ¨åˆ†ï¼š</p>
<ul>
<li><strong>å¯„å­˜å™¨çŠ¶æ€</strong>ï¼šåŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰ã€æ ˆæŒ‡é’ˆï¼ˆSPï¼‰ä»¥åŠå…¶ä»–é€šç”¨å¯„å­˜å™¨çš„å€¼ã€‚</li>
<li><strong>ä¸­æ–­ç›¸å…³æ ‡å¿—</strong>ï¼šå¦‚ä¸­æ–­å·ã€å¼‚å¸¸å·ç­‰ã€‚</li>
<li><strong>ç”¨æˆ·æ ˆä¿¡æ¯</strong>ï¼šåœ¨å‘ç”Ÿç³»ç»Ÿè°ƒç”¨æˆ–ä¸­æ–­æ—¶ï¼Œæ ˆçš„çŠ¶æ€ä¿¡æ¯ä¹Ÿä¼šè¢«ä¿å­˜ã€‚</li>
</ul>
<h2 id="lab3-pgtbl">Lab3. Pgtbl<a hidden class="anchor" aria-hidden="true" href="#lab3-pgtbl">#</a></h2>
<h3 id="1-inspect-pgtbl">1. Inspect pgtbl<a hidden class="anchor" aria-hidden="true" href="#1-inspect-pgtbl">#</a></h3>
<p>å¯ä»¥ç”¨Lab2ä¸­<code>exec</code>ç³»ç»Ÿè°ƒç”¨åšäº†ä»€ä¹ˆæ¥è§£é‡Šé¡µè¡¨</p>
<h3 id="2-speed-syscall">2. speed syscall<a hidden class="anchor" aria-hidden="true" href="#2-speed-syscall">#</a></h3>
<p>åƒ<code>trapoline</code>å’Œ<code>trapframe</code>ä¸€æ ·åˆ†é…ç‰©ç†é¡µå¹¶åœ¨é¡µè¡¨è¿›è¡Œæ˜ å°„ï¼Œæ³¨æ„éœ€è¦åœ¨<code>exec</code>å’Œ<code>fork</code>å®ç°ä¸­ç»™pidèµ‹å€¼å¹¶ä¸”åœ¨<code>proc_freepagetable</code>å¤„è°ƒç”¨<code>uvmunmap</code></p>
<p>æˆ‘è¿˜ä¿®æ”¹äº†<code>struc proc</code>çš„å®šä¹‰ï¼Œå¢åŠ <code>usyscall</code>ä¸<code>trapframe</code>çš„é£æ ¼ä¸€è‡´</p>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250212015234604.png" 
       alt="usyscallç»“æ„ä½“å®šä¹‰" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">ä¿®æ”¹struct procçš„å®šä¹‰ï¼Œå¢åŠ usyscall</div></div>
<p>å°±ä¸è¯¥è®©æˆ‘ç®¡ç†å†…å­˜&#x1f62d;æœ€åçš„<code>usertest</code>ä¸€ç›´è¿‡ä¸å»ç»“æœå‘ç°æ˜¯ç¬¬äºŒéƒ¨åˆ†çš„<code>usyscall</code>çš„pageæ²¡æœ‰é‡Šæ”¾</p>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250214172703887.png" 
       alt="å†…å­˜ç®¡ç†é”™è¯¯1" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">usyscallçš„pageæ²¡æœ‰é‡Šæ”¾å¯¼è‡´usertestä¸è¿‡</div></div>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250215192718846.png" 
       alt="å†…å­˜ç®¡ç†é”™è¯¯2" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">ä¿®æ­£åä»ç„¶å°‘ä¸¤ä¸ªpageï¼Œéœ€è¦åœ¨allocprocä¸­åˆ†é…</div></div>
<p>è¿™æ ·ä¹‹å<code>usertest</code>ä¹Ÿæ²¡è¿‡ï¼Œè¿˜å°‘ä¸¤ä¸ªpageï¼Œ<code>usyscall</code>çš„å†…å­˜ä¸èƒ½åœ¨<code>proc_pagetable</code>åˆ†é…ï¼Œåªèƒ½åœ¨<code>alloc_proc</code>åˆ†é…ï¼Œå¯èƒ½ä¸é”æœ‰å…³ï¼Œç›®å‰æˆ‘è¿˜ä¸çŸ¥é“åŸå› </p>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250215193021861.png" 
       alt="å†…å­˜ç®¡ç†é”™è¯¯3" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">ä¿®æ­£åçš„å†…å­˜ç®¡ç†é—®é¢˜</div></div>
<h3 id="3-print-pgtbl">3. print pgtbl<a hidden class="anchor" aria-hidden="true" href="#3-print-pgtbl">#</a></h3>
<p>è¿™ä¸ªé¢˜ç›®MITå°†å…¶è®¾ä¸ºeasyï¼Œä½†æ˜¯è¯¾ç¨‹å®˜ç½‘ä¸Šç»™å‡ºçš„ç­”æ¡ˆä¸­çš„<code>va</code>å´æ˜¯é”™è¯¯çš„ï¼Œå¹¶ä¸”æˆ‘ä¹Ÿæ¨¡æ‹Ÿå‡ºäº†é”™è¯¯çš„åŸå› (å¾€å¹´çš„labæ²¡æœ‰è¦æ±‚æ‰“å°va)</p>
<p>è¿™æ˜¯å¾—åˆ°å®˜ç½‘ç­”æ¡ˆçš„ä»£ç ï¼š(ä½ èƒ½ä¸èƒ½å‘ç°é—®é¢˜æ‰€åœ¨..</p>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250213004541640.png" 
       alt="é”™è¯¯çš„é¡µè¡¨æ‰“å°ä»£ç " 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">MITå®˜æ–¹ç­”æ¡ˆä¸­çš„é”™è¯¯ä»£ç ï¼ˆiæº¢å‡ºé—®é¢˜ï¼‰</div></div>
<p>è¿™æ˜¯å¾—åˆ°æ­£ç¡®ç­”æ¡ˆçš„ä»£ç ï¼šï¼ˆæ²¡é”™ï¼Œiæº¢å‡ºäº†ï¼Œoffsetä¼šåœ¨å‡ ä¸ªæ•°ä¹‹é—´å¾ªç¯</p>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250213004456598.png" 
       alt="æ­£ç¡®çš„é¡µè¡¨æ‰“å°ä»£ç " 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">ä¿®æ­£åçš„æ­£ç¡®ä»£ç ï¼Œè§£å†³äº†iæº¢å‡ºé—®é¢˜</div></div>
<p>è¿™æ˜¯æˆ‘å¾—åˆ°çš„ç­”æ¡ˆï¼Œæˆ‘ç”¨MAXVAéªŒè¯äº†å®ƒçš„æ­£ç¡®æ€§</p>
<div class="image-container"><div class="tech-diagram"><img src="/images/image-20250213003319971.png" 
       alt="æ­£ç¡®çš„é¡µè¡¨è¾“å‡º" 
       class="img-large tech-diagram"
       loading="lazy" /></div><div class="image-caption">æ­£ç¡®çš„é¡µè¡¨è¾“å‡ºç»“æœï¼Œç”¨MAXVAéªŒè¯æ­£ç¡®æ€§</div></div>
<h3 id="4-superpages">4. superpages<a hidden class="anchor" aria-hidden="true" href="#4-superpages">#</a></h3>
<p>è¿™ä¸ªéƒ¨åˆ†éœ€è¦è®©xv6æ”¯æŒè¶…é¡µé¢ï¼Œæ”¹åŠ¨çš„åœ°æ–¹è¾ƒå¤šï¼Œå®¹æ˜“å‡ºç°å°é”™è¯¯ï¼Œç»“æœè¾“å‡ºå¯¹äº†<code>usertest</code>ä¹Ÿä¸ä¸€å®šèƒ½è¿‡</p>
<p>é¦–å…ˆéœ€è¦è®©xv6èƒ½å¤Ÿåˆ†é…è¶…é¡µé¢ç‰©ç†å†…å­˜ï¼Œä¸ºäº†ä¾¿äºç®¡ç†ï¼Œæˆ‘åœ¨<code>kmem</code>ä¸­å¢åŠ äº†<code>superfreelist</code>,å¹¶åœ¨initæ—¶åˆå§‹åŒ–ï¼ˆéœ€è¦æ³¨æ„å­—èŠ‚å¯¹é½</p>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250215193214359.png" 
       alt="è¶…é¡µé¢åˆå§‹åŒ–" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">ä½¿ç”¨referencesç»Ÿè®¡cpuidçš„freelistå¤§å°</div></div>
<p>ç„¶åéœ€è¦è®©sbrkæ”¯æŒè¶…é¡µé¢çš„åˆ†é…ï¼Œè¿™éƒ¨åˆ†å¾ˆå®¹æ˜“å‡ºé—®é¢˜</p>
<ol>
<li>å› ä¸ºéœ€è¦å­—èŠ‚å¯¹é½ï¼Œå¯èƒ½å¯¼è‡´åˆ†é…è¶…é¡µé¢çš„èµ·å§‹åœ°å€è¾ƒå¤§ï¼Œä¸ä¹‹å‰çš„szä¸­é—´éœ€è¦åˆ†é…è™šæ‹Ÿåœ°å€</li>
<li>åªè®¾å®šäº†å°‘é‡çš„è¶…é¡µé¢ï¼Œå¦‚æœç”³è¯·ç‰©ç†å†…å­˜è¾ƒå¤§ï¼Œåªèƒ½ä½¿ç”¨æ™®é€šé¡µé¢</li>
<li>å¦‚æœç”³è¯·çš„ç‰©ç†å†…å­˜è¿‡å¤§ï¼Œéœ€è¦<code>dealloc</code>ä¹‹å‰allocè¿‡çš„å†…å­˜å¹¶<code>unmap</code></li>
</ol>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250215193658781.png" 
       alt="è¶…é¡µé¢sbrkå®ç°" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">sbrkæ”¯æŒè¶…é¡µé¢çš„åˆ†é…å®ç°</div></div>
<p>ä¹‹åå’Œ<code>uvmalloc</code>ä¸€æ ·åˆ†é…è¶…é¡µé¢ï¼Œå¼€å§‹æˆ‘æƒ³æŠŠä¸¤è€…å°è£…åœ¨ä¸€èµ·ï¼Œå‘ç°è¿˜æ˜¯ç‹¬ç«‹å‡½æ•°æ›´ä¸ºæ¸…æ™°</p>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250215194748728.png" 
       alt="è¶…é¡µé¢uvmalloc" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">uvmallocçš„è¶…é¡µé¢åˆ†é…å®ç°</div></div>
<p>ä¹‹åæ¯”è¾ƒå…³é”®çš„æ˜¯é¡µè¡¨æ˜ å°„ï¼Œéœ€è¦è®©level1çš„pteç›´æ¥æ˜ å°„åˆ°ç‰©ç†å†…å­˜è€Œä¸æ˜¯ä¸‹ä¸€çº§çš„pteï¼Œç›¸å½“äºæ²¡æœ‰äº†L0ä½†å¤šäº†9ä½çš„offsetï¼Œè¿™é‡Œä¸»è¦æ”¹åŠ¨çš„æ˜¯<code>walk</code></p>
<div class="image-container"><div class="tech-diagram"><img src="/images/image-20250215194926739.png" 
       alt="è¶…é¡µé¢é¡µè¡¨æ˜ å°„" 
       class="img-large tech-diagram"
       loading="lazy" /></div><div class="image-caption">é¡µè¡¨æ˜ å°„ï¼Œéœ€è¦è®©level1çš„pteç›´æ¥æ˜ å°„åˆ°ç‰©ç†å†…å­˜</div></div>
<div class="image-container"><div class="tech-diagram"><img src="/images/image-20250215195518106.png" 
       alt="walkå‡½æ•°ä¿®æ”¹" 
       class="img-large tech-diagram"
       loading="lazy" /></div><div class="image-caption">ä¿®æ”¹walkå‡½æ•°æ”¯æŒè¶…é¡µé¢æ˜ å°„</div></div>
<p>å¦å¤–è¿˜è¦è®©è¶…é¡µé¢æ”¯æŒ<code>fork</code>å­è¿›ç¨‹æ—¶çš„é¡µè¡¨å¤åˆ¶å’Œé‡Šæ”¾ï¼Œè¿™é‡Œç›´æ¥å°è£…åˆ°ä¸€ä¸ªå‡½æ•°äº†</p>
<div class="image-container"><div class="tech-diagram"><img src="/images/image-20250215195737751.png" 
       alt="è¶…é¡µé¢forkæ”¯æŒ" 
       class="img-large tech-diagram"
       loading="lazy" /></div><div class="image-caption">è®©è¶…é¡µé¢æ”¯æŒforkå­è¿›ç¨‹æ—¶çš„é¡µè¡¨å¤åˆ¶</div></div>
<div class="image-container"><div class="tech-diagram"><img src="/images/image-20250215195817441.png" 
       alt="è¶…é¡µé¢é‡Šæ”¾å‡½æ•°" 
       class="img-large tech-diagram"
       loading="lazy" /></div><div class="image-caption">è¶…é¡µé¢çš„é‡Šæ”¾å‡½æ•°å°è£…</div></div>
<h2 id="lab4-traps">Lab4. Traps<a hidden class="anchor" aria-hidden="true" href="#lab4-traps">#</a></h2>
<h3 id="1-risc-v-asmma">1. RISC-V asmma<a hidden class="anchor" aria-hidden="true" href="#1-risc-v-asmma">#</a></h3>
<ul>
<li>
<p>Which registers contain arguments to functions? For example, which register holds 13 in main&rsquo;s call to <code>printf</code>?</p>
<ul>
<li>a0-a7</li>
</ul>
</li>
<li>
<p>Where is the call to function <code>f</code> in the assembly code for main? Where is the call to <code>g</code>? (Hint: the compiler may inline functions.)</p>
<ul>
<li>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>2e:	45b1                	li	a1,12
</span></span><span style="display:flex;"><span>1a:	250d                	addiw	a0,a0,3
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
<li>
<p>Run the following code.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00646c72</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;H%x Wo%s&#34;</span>, <span style="color:#ae81ff">57616</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>) <span style="color:#f92672">&amp;</span>i);
</span></span></code></pre></td></tr></table>
</div>
</div><p>What is the output?</p>
<ul>
<li><code>He110 World</code>ï¼ŒRISC-V å’Œ x86 éƒ½æ˜¯å°ç«¯å­—èŠ‚åº</li>
</ul>
</li>
<li>
<p>In the following code, what is going to be printed after <code>'y='</code>? (note: the answer is not a specific value.) Why does this happen?</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;x=%d y=%d&#34;</span>, <span style="color:#ae81ff">3</span>)<span style="color:#960050;background-color:#1e0010">ï¼›</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ub</li>
</ul>
</li>
</ul>
<h3 id="2-backtrace">2. backtrace<a hidden class="anchor" aria-hidden="true" href="#2-backtrace">#</a></h3>
<p>æ¨¡æ‹Ÿå®ç°backtraceï¼Œç†è§£æ ˆå¸§å°±å¾ˆå®¹æ˜“å®ç°</p>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250216021940958.png" 
       alt="backtraceå®ç°" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">backtraceçš„å®ç°ï¼Œé€šè¿‡æ ˆå¸§æŒ‡é’ˆéå†è°ƒç”¨æ ˆ</div></div>
<h3 id="3-alarm">3. alarm<a hidden class="anchor" aria-hidden="true" href="#3-alarm">#</a></h3>
<p>è¿™é¢˜éš¾åº¦ä¸ºhardï¼Œä½†å®ç°èµ·æ¥æ²¡æœ‰å¾ˆéš¾ï¼Œè€Œä¸”å®˜æ–¹ç»™äº†å¾ˆå¤šæç¤ºï¼Œå°±å·®ç›´æ¥è¯´ç­”æ¡ˆäº†</p>
<p>é¦–å…ˆè¦æ”¯æŒæ–°åŠ å…¥çš„<code>syscall</code>ï¼Œè¿™éƒ¨åˆ†Lab1å°±æ¶‰åŠäº†</p>
<p>ç„¶åå°±æ˜¯å®ç°ä¸¤ä¸ª<code>syscall</code>æ¥å®ç°alarmï¼Œalarmçš„åŠŸèƒ½ç±»ä¼¼ä¸è®¾å®šä¸€ä¸ªå›ºå®šæ—¶é•¿çš„æ—¶é’Ÿä¸­æ–­ï¼Œå¹¶ä¸”å®ƒçš„å®ç°ticksè®¡æ•°ä¹Ÿä»¥ç‰©ç†æ—¶é’Ÿä¸­æ–­ä¸ºåŸºæœ¬å•ä½</p>
<p>é¦–å…ˆéœ€è¦ä¸º<code>proc</code>å¢åŠ ä¸€ä¸ªalarmç›¸å…³çš„ç»“æ„ä½“ï¼ˆ<code>enabled</code> ä»£è¡¨æ˜¯å¦å¯ç”¨alarmï¼Œ<code>ticks</code> ä¸ºè®¡æ•°å€¼ï¼Œ <code>using</code>ä»£è¡¨æ˜¯å¦æ­£åœ¨å¤„ç†alarmä¸­æ–­ä¸èƒ½é‡å¤ä¸­æ–­ï¼Œ<code>copy</code>ä¸ºä¸­æ–­å‰çš„å¯„å­˜å™¨ï¼Œ<code>handler</code>ä¸ºä¸­æ–­å¤„ç†å‡½æ•°ï¼Œ<code>isreturn</code> éœ€è¦ä¸ºæ¢å¤a0æä¾›æ”¯æŒï¼‰</p>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250216213044540.png" 
       alt="alarmç»“æ„ä½“" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">ä¸ºprocå¢åŠ alarmç›¸å…³çš„ç»“æ„ä½“</div></div>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250216212700961.png" 
       alt="alarmç³»ç»Ÿè°ƒç”¨å®ç°" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">sys_sigalarmç³»ç»Ÿè°ƒç”¨çš„å®ç°</div></div>
<p><code>sys_sigalarm</code>ç”¨äºå¯ç”¨alarmï¼Œä¸”åœ¨èµ‹å€¼ä¸º<code>(0ï¼Œ0)</code>æ—¶å…³é—­alarm</p>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250216213230150.png" 
       alt="sigalarmå¯ç”¨alarm" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">sys_sigalarmç”¨äºå¯ç”¨alarmçš„å®ç°</div></div>
<p>ç„¶åéœ€è¦åœ¨<code>usertrap</code>ä¸­æä¾›alarmçš„æ”¯æŒï¼Œæ¯æ¬¡æ—¶é’Ÿä¸­æ–­å°†tickså€¼åŠ ä¸€ï¼Œåœ¨è¾¾åˆ°è®¡æ•°å€¼åè®¾ç½®<code>epc</code>å¯„å­˜å™¨è°ƒç”¨handlerï¼Œå¹¶ä¸”éœ€è¦ä¿å­˜å¯„å­˜å™¨ï¼Œåœ¨ç”¨æˆ·å¤„ç†å®Œalarmä¸­æ–­åæ¢å¤(åœ¨<code>sigreturn</code>ä¸­å®ç°</p>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250216213520696.png" 
       alt="usertrapä¸­alarmæ”¯æŒ" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">åœ¨usertrapä¸­æä¾›alarmçš„æ”¯æŒ</div></div>
<p>åœ¨<code>sigreturn</code>ä¸­æ¢å¤å¯„å­˜å™¨ï¼Œ<code>sigreturn</code>çš„è¿”å›å€¼ä¼šè¢«ä¿å­˜åœ¨a0ä¸­ï¼Œéœ€è¦é‡æ–°èµ‹å€¼</p>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250216213836520.png" 
       alt="sigreturnæ¢å¤å¯„å­˜å™¨" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">åœ¨sigreturnä¸­æ¢å¤å¯„å­˜å™¨</div></div>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250216213950355.png" 
       alt="sigreturnè¿”å›å€¼" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">sigreturnçš„è¿”å›å€¼å¤„ç†</div></div>
<h3 id="some-concepts-1">Some concepts<a hidden class="anchor" aria-hidden="true" href="#some-concepts-1">#</a></h3>
<ol>
<li>æ ˆå¸§</li>
</ol>
<p>These <a href="https://pdos.csail.mit.edu/6.1810/2023/lec/l-riscv.txt">lecture notes</a> have a picture of the layout of stack frames. Note that the return address lives at a fixed offset (-8) from the frame pointer of a stackframe, and that the saved frame pointer lives at fixed offset (-16) from the frame pointer.</p>
<p><a href="https://decaf-lang.github.io/minidecaf-tutorial-deploy/docs/lab5/stackframe.html">https://decaf-lang.github.io/minidecaf-tutorial-deploy/docs/lab5/stackframe.html</a></p>
<hr>
<h2 id="lab5-cow">Lab5. Cow<a hidden class="anchor" aria-hidden="true" href="#lab5-cow">#</a></h2>
<p>è¿™ä¸ªlabéœ€è¦å®ç°copy-on-write forkï¼Œå…ˆé˜…è¯»Chapter4.6 çš„page-fault exceptions äº†è§£cowæœºåˆ¶ï¼Œç„¶åæ ¹æ®æç¤ºå®ç°åŠŸèƒ½çš„å„ä¸ªéƒ¨åˆ†ã€‚ä¸è¿‡å’Œ<code>superpage</code>ä¸€æ ·å¦‚æœå‘ç”Ÿäº†å°é”™è¯¯debugå¾ˆéº»çƒ¦ï¼Œå®¹æ˜“å‘ç”Ÿä»¤äººè´¹è§£çš„é”™è¯¯</p>
<h3 id="cowå·¥ä½œåŸç†">cowå·¥ä½œåŸç†<a hidden class="anchor" aria-hidden="true" href="#cowå·¥ä½œåŸç†">#</a></h3>
<p>è®¸å¤šå†…æ ¸ä½¿ç”¨é¡µé¢æ•…éšœæ¥å®ç°<strong>å†™æ—¶å¤åˆ¶ï¼ˆcopy-on-writeï¼Œcowï¼‰fork</strong>ã€‚è¦è§£é‡Šå†™æ—¶å¤åˆ¶forkï¼Œå¯ä»¥æƒ³ä¸€æƒ³xv6çš„<code>fork</code>ï¼Œåœ¨ç¬¬3ç« ä¸­ä»‹ç»è¿‡ã€‚<code>fork</code>é€šè¿‡è°ƒç”¨<code>uvmcopy</code>ï¼ˆkernel/vm.c:309ï¼‰ä¸ºå­è¿›ç¨‹åˆ†é…ç‰©ç†å†…å­˜ï¼Œå¹¶å°†çˆ¶è¿›ç¨‹çš„å†…å­˜å¤åˆ¶åˆ°å­ç¨‹åºä¸­ï¼Œä½¿å­è¿›ç¨‹æ‹¥æœ‰ä¸çˆ¶è¿›ç¨‹ç›¸åŒçš„å†…å­˜å†…å®¹ã€‚å¦‚æœå­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹èƒ½å¤Ÿå…±äº«çˆ¶è¿›ç¨‹çš„ç‰©ç†å†…å­˜ï¼Œæ•ˆç‡ä¼šæ›´é«˜ã€‚ç„¶è€Œï¼Œç›´æ¥å®ç°è¿™ç§æ–¹æ³•æ˜¯è¡Œä¸é€šçš„ï¼Œå› ä¸ºçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹å¯¹å…±äº«æ ˆå’Œå †çš„å†™å…¥ä¼šä¸­æ–­å½¼æ­¤çš„æ‰§è¡Œã€‚</p>
<p>é€šè¿‡ä½¿ç”¨å†™æ—¶å¤åˆ¶forkï¼Œå¯ä»¥è®©çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹å®‰å…¨åœ°å…±äº«ç‰©ç†å†…å­˜ï¼Œé€šè¿‡é¡µé¢æ•…éšœæ¥å®ç°ã€‚å½“CPUä¸èƒ½å°†è™šæ‹Ÿåœ°å€ç¿»è¯‘æˆç‰©ç†åœ°å€æ—¶ï¼ŒCPUä¼šäº§ç”Ÿä¸€ä¸ªé¡µé¢æ•…éšœå¼‚å¸¸ï¼ˆpage-fault exceptionï¼‰ã€‚ RISC-Væœ‰ä¸‰ç§ä¸åŒçš„é¡µæ•…éšœï¼šloadé¡µæ•…éšœï¼ˆå½“åŠ è½½æŒ‡ä»¤ä¸èƒ½ç¿»è¯‘å…¶è™šæ‹Ÿåœ°å€æ—¶ï¼‰ã€stoteé¡µæ•…éšœï¼ˆå½“å­˜å‚¨æŒ‡ä»¤ä¸èƒ½ç¿»è¯‘å…¶è™šæ‹Ÿåœ°å€æ—¶ï¼‰å’ŒæŒ‡ä»¤é¡µæ•…éšœï¼ˆå½“æŒ‡ä»¤çš„åœ°å€ä¸èƒ½ç¿»è¯‘æ—¶ï¼‰ã€‚<code>scause</code>å¯„å­˜å™¨ä¸­çš„å€¼è¡¨ç¤ºé¡µé¢æ•…éšœçš„ç±»å‹ï¼Œ<code>stval</code>å¯„å­˜å™¨ä¸­åŒ…å«æ— æ³•ç¿»è¯‘çš„åœ°å€ã€‚</p>
<p><em><strong>COW</strong></em> forkä¸­çš„åŸºæœ¬è®¾è®¡æ˜¯çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹æœ€åˆå…±äº«æ‰€æœ‰çš„ç‰©ç†é¡µé¢ï¼Œä½†å°†å®ƒä»¬æ˜ å°„è®¾ç½®ä¸ºåªè¯»ã€‚å› æ­¤ï¼Œå½“å­è¿›ç¨‹æˆ–çˆ¶è¿›ç¨‹æ‰§è¡ŒstoreæŒ‡ä»¤æ—¶ï¼ŒRISC-V CPUä¼šå¼•å‘ä¸€ä¸ªé¡µé¢æ•…éšœå¼‚å¸¸ã€‚ä½œä¸ºå¯¹è¿™ä¸ªå¼‚å¸¸çš„å“åº”ï¼Œå†…æ ¸ä¼šæ‹·è´ä¸€ä»½åŒ…å«æ•…éšœåœ°å€çš„é¡µã€‚ç„¶åå°†ä¸€ä¸ªå‰¯æœ¬çš„è¯»/å†™æ˜ å°„åœ¨å­è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œå¦ä¸€ä¸ªå‰¯æœ¬çš„è¯»/å†™æ˜ å°„åœ¨çˆ¶è¿›ç¨‹åœ°å€ç©ºé—´ã€‚æ›´æ–°é¡µè¡¨åï¼Œå†…æ ¸åœ¨å¼•èµ·æ•…éšœçš„æŒ‡ä»¤å¤„æ¢å¤æ•…éšœå¤„ç†ã€‚å› ä¸ºå†…æ ¸å·²ç»æ›´æ–°äº†ç›¸å…³çš„PTEï¼Œå…è®¸å†™å…¥ï¼Œæ‰€ä»¥ç°åœ¨æ•…éšœæŒ‡ä»¤å°†æ­£å¸¸æ‰§è¡Œã€‚</p>
<p>è¿™ä¸ªCOWè®¾è®¡å¯¹<code>fork</code>å¾ˆæœ‰æ•ˆï¼Œå› ä¸ºå¾€å¾€å­ç¨‹åºåœ¨forkåç«‹å³è°ƒç”¨execï¼Œç”¨æ–°çš„åœ°å€ç©ºé—´æ›¿æ¢å…¶åœ°å€ç©ºé—´ã€‚åœ¨è¿™ç§å¸¸è§çš„æƒ…å†µä¸‹ï¼Œå­ç¨‹åºåªä¼šé‡åˆ°ä¸€äº›é¡µé¢æ•…éšœï¼Œè€Œå†…æ ¸å¯ä»¥é¿å…è¿›è¡Œå®Œæ•´çš„å¤åˆ¶ã€‚æ­¤å¤–ï¼ŒCOW forkæ˜¯é€æ˜çš„ï¼šä¸éœ€è¦å¯¹åº”ç”¨ç¨‹åºè¿›è¡Œä¿®æ”¹ï¼Œåº”ç”¨ç¨‹åºå°±èƒ½å—ç›Šã€‚</p>
<p>è¿™æ®µæ¥è‡ªxv6 boot 4.6çš„ç¿»è¯‘ï¼ˆfrom <a href="https://github.com/zhenyu-zang/xv6-riscv-book-Chinese/blob/main/Chapter-4.md">xv6 book-cn</a>ï¼‰ï¼Œå¯¹äºcowå·²ç»å†™çš„å¾ˆæ¸…æ¥šäº†,å¦å¤–ï¼šRISC-Væœ‰ä¸‰ç§ä¸åŒçš„é¡µæ•…éšœå¯¹åº”scauseï¼Œå¯¹äºCowåªéœ€è¦å¤„ç†scause=15çš„page-fault</p>
<ul>
<li><strong>æŒ‡ä»¤Page Fault</strong>ï¼ˆå–æŒ‡ï¼‰ï¼š<code>scause = 12</code></li>
<li><strong>åŠ è½½Page Fault</strong>ï¼ˆè¯»æ•°æ®ï¼‰ï¼š<code>scause = 13</code></li>
<li><strong>å­˜å‚¨Page Fault</strong>ï¼ˆå†™æ•°æ®ï¼‰ï¼š<code>scause = 15</code></li>
</ul>
<h3 id="answer-1">Answer<a hidden class="anchor" aria-hidden="true" href="#answer-1">#</a></h3>
<p>é¦–å…ˆéœ€è¦å¢åŠ æ”¯æŒCowçš„ç‰©ç†å†…å­˜å¼•ç”¨è®¡æ•°ï¼Œä½¿å¾—ä¸ä¼šfreeå…±äº«çš„é¡µé¢ï¼Œå¢åŠ å‡å°‘éœ€è¦ä¸Šé”é˜²æ­¢å¤šä¸ªè¿›ç¨‹å…±åŒå†™å…¥ï¼ŒåŒæ—¶æˆ‘æŠŠ<code>subreference</code>å°è£…è¿›<code>kfree</code>ï¼Œå‡å°‘éœ€è¦ä¿®æ”¹çš„æ¡†æ¶ä»£ç </p>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250218165550454.png" 
       alt="COWå¼•ç”¨è®¡æ•°åˆå§‹åŒ–" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">COWæ”¯æŒçš„ç‰©ç†å†…å­˜å¼•ç”¨è®¡æ•°åˆå§‹åŒ–</div></div>
<div class="image-container"><div class="tech-diagram"><img src="/images/image-20250218170150882.png" 
       alt="COWç‰©ç†å†…å­˜å¼•ç”¨è®¡æ•°" 
       class="img-large tech-diagram"
       loading="lazy" /></div><div class="image-caption">COWç‰©ç†å†…å­˜å¼•ç”¨è®¡æ•°å®ç°</div></div>
<div class="image-container"><div class="tech-diagram"><img src="/images/image-20250218170246755.png" 
       alt="kallocå’Œkfreeä¿®æ”¹" 
       class="img-large tech-diagram"
       loading="lazy" /></div><div class="image-caption">kallocå’Œkfreeçš„å¼•ç”¨è®¡æ•°ç®¡ç†</div></div>
<p>ç„¶åå®ç°Cow-forkä¿®æ”¹<code>uvmcopy</code>ï¼Œä¸»è¦æœ‰å‡ ä¸ªå…³é”®ç‚¹ï¼š</p>
<ul>
<li>
<p>ä¸åˆ†é…ç‰©ç†é¡µ</p>
</li>
<li>
<p>ä½¿ç”¨pteçš„RSWä¿ç•™ä½ï¼Œå¢åŠ <code>PTE_COW</code>ç”¨äºæ ‡ç¤ºpage-faultæ—¶éœ€è¦å¤„ç†çš„é¡µè¡¨é¡¹</p>
</li>
<li>
<p>å°†çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹çš„é¡µè¡¨éƒ½æ ‡è®°ä¸ºä¸å¯å†™</p>
</li>
<li>
<p>éœ€è¦åŠ å…¥<code>*pte &amp; PTE_COW</code>é˜²æ­¢è¿˜æ²¡æœ‰å¤åˆ¶å¯å†™å­è¿›ç¨‹é¡µå°±è°ƒç”¨fork</p>
</li>
</ul>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250218164447454.png" 
       alt="COW forkçš„uvmcopyå®ç°" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">COW forkçš„uvmcopyå®ç°ï¼Œä¸åˆ†é…ç‰©ç†é¡µ</div></div>
<p>ç„¶åéœ€è¦<code>usertrap</code>å¤„ç†<code>scause</code>ä¸º15çš„pagefaultï¼ˆpsï¼šä¸è¦éšä¾¿åŠ çœ‹ä¸æ‡‚çš„å†…å®¹ï¼Œæˆ‘å¼€å§‹åœ¨è¿™é‡Œæ‰‹æ¬ åŠ å…¥äº†ä¸Šé¢å¤„ç†<code>syscall</code>çš„<code>intr_on</code>ï¼Œåˆå¯¼è‡´äº†æ— æ³•ç†è§£çš„é”™è¯¯ï¼‰</p>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250218160639266.png" 
       alt="é¡µé”™è¯¯å¤„ç†å™¨" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">é¡µé”™è¯¯å¤„ç†å™¨çš„å®ç°</div></div>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250218170804366.png" 
       alt="usertrapå¤„ç†page fault" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">åœ¨usertrapä¸­å¤„ç†scauseä¸º15çš„page fault</div></div>
<p>å¦å¤–éœ€è¦åœ¨<code>copyout</code>ä¸­åŠ å…¥åŒæ ·çš„æœºåˆ¶ï¼Œé˜²æ­¢è¯¯åˆ¤é¡µä¸å¯å†™å…¥</p>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250218171530232.png" 
       alt="copyoutä¸­COWæ”¯æŒ" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">åœ¨copyoutä¸­åŠ å…¥COWæœºåˆ¶æ”¯æŒ</div></div>
<h3 id="å…³äºè°ƒè¯•">å…³äºè°ƒè¯•<a hidden class="anchor" aria-hidden="true" href="#å…³äºè°ƒè¯•">#</a></h3>
<div class="callout callout-important">
  <div class="callout-header">
    <span class="callout-icon"><svg width="16" height="16" viewBox="0 0 16 16"><path fill="currentColor" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/></svg></span>
    <span class="callout-title">IMPORTANT</span>
  </div>
  <div class="callout-content">
    <ul>
<li>The machine is always right. (æœºå™¨æ°¸è¿œæ˜¯å¯¹çš„)
<ul>
<li>Corollary: If the program does not produce the desired output, it is the programmer&rsquo;s fault.</li>
</ul>
</li>
<li>Every line of untested code is always wrong. (æœªæµ‹è¯•ä»£ç æ°¸è¿œæ˜¯é”™çš„)
<ul>
<li>Corollary: Mistakes are likely to appear in the &ldquo;must-be-correct&rdquo; code.</li>
</ul>
</li>
</ul>
<p>è¿™ä¸¤æ¡å…¬ç†çš„æ„æ€æ˜¯: æŠ±æ€¨æ˜¯æ²¡æœ‰ç”¨çš„, æ¥å—ä»£ç æœ‰bugçš„ç°å®, è€å¿ƒè°ƒè¯•.</p>
  </div>
</div>
<p>è¿™ä¸ªbugå¡äº†æˆ‘å‡ ä¸ªå°æ—¶..</p>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250218152936964.png" 
       alt="è°ƒè¯•é”™è¯¯ç¤ºä¾‹2" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">è°ƒè¯•è¿‡ç¨‹ä¸­é‡åˆ°çš„é”™è¯¯</div></div>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250218173755178.png" 
       alt="è°ƒè¯•é”™è¯¯ç¤ºä¾‹" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">è°ƒè¯•è¿‡ç¨‹ä¸­çš„é”™è¯¯ç¤ºä¾‹</div></div>
<p>é¦–å…ˆéœ€è¦å®šä½å‘ç”Ÿ<code>usertrap</code>çš„ä½ç½®ï¼Œè¿™é‡Œæˆ‘çŠ¯äº†ç¬¬ä¸€ä¸ªé”™è¯¯ï¼Œæƒ³å½“ç„¶è®¤ä¸º<code>copyout</code>åªåœ¨pipeä¸­ä½¿ç”¨ï¼Œèµ·æ‰‹gdb<code>b sys_pipe</code>ï¼Œå…¶å®é”™è¯¯å‘ç”Ÿåœ¨forkå‰çš„read</p>
<p>ç´§æ¥ç€æˆ‘çŠ¯äº†ç¬¬äºŒä¸ªé”™è¯¯ï¼Œæˆ‘ç»§ç»­èµ·æ‰‹gdb <code>b sys_read</code>,å…¶å®æˆ‘è¿˜æ²¡æœ‰çœ‹readç³»ç»Ÿè°ƒç”¨å…·ä½“åšäº†ä»€ä¹ˆï¼Œç„¶åè°ƒè¯•è¿‡ç¨‹ä¸­ç”šè‡³æ²¡å‘ç°readä¸­è°ƒç”¨çš„å‡½æ•°æœ‰ç”¨åˆ°copyout</p>
<p>ç´§æ¥ç€æˆ‘çŠ¯äº†ç¬¬ä¸‰ä¸ªé”™è¯¯ï¼Œå°è¯•ä»usertestsæ‰¾åˆ°é”™è¯¯åŸå› ï¼Œä¿®æ”¹<code>addrs</code>æ¥ç†è§£é”™è¯¯è€Œä¸æ˜¯ç†è§£readï¼Œäºæ˜¯å¯¼è‡´é—®é¢˜æ›´åŠ å¥‡æ€ªï¼ˆæˆ‘å°†aiä»1å¼€å§‹testsè¿‡äº†ï¼‰äºæ˜¯æˆ‘å‘ç°é”™è¯¯å‘ç”Ÿåœ¨å°è¯•å†™å…¥ç¬¬ä¸€ä¸ªé¡µè¡¨ï¼Œä¸”ç¬¬ä¸€ä¸ªé¡µè¡¨çš„å†…å®¹è¢«ä¿®æ”¹äº†ï¼Œå†…å­˜ä¿®æ”¹å¯¼è‡´äº†ä¸å¯ç†è§£çš„é”™è¯¯ï¼Œå¯¼è‡´æˆ‘åœ¨ä¿®æ”¹<code>addrs</code>çš„ç¬¬ä¸€ä¸ªå€¼æ—¶å‘ç”Ÿusertrapçš„scauseå€¼éƒ½ä¸åŒ</p>
<p>æœ€åæˆ‘æ‰å»é˜…è¯»äº†sys_readçš„æºç ï¼Œå‘ç°è°ƒç”¨äº†copyoutï¼Œé”™è¯¯åœ¨äºæˆ‘æ²¡æœ‰åœ¨<code>if (*pte &amp; PTE_COW)</code>ä¸æˆç«‹åreturn -1 å¯¼è‡´ä¸å¯å†™å…¥çš„å†…å­˜è¢«ä¿®æ”¹ï¼Œæ‰€ä»¥ä¿®æ”¹æ¡†æ¶ä»£ç æ˜¯å±é™©çš„ï¼Œbugæ˜¯æ— æ³•é¿å…çš„ï¼Œæµ‹è¯•æ˜¯é‡è¦çš„ã€‚</p>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250218171530232.png" 
       alt="copyoutä¸­COWæ”¯æŒ" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">åœ¨copyoutä¸­åŠ å…¥COWæœºåˆ¶æ”¯æŒ</div></div>
<p>å¯¹äºè°ƒè¯•ï¼Œå†æ¬¡å¼•ç”¨PA</p>
<div class="callout callout-caution">
  <div class="callout-header">
    <span class="callout-icon"><svg width="16" height="16" viewBox="0 0 16 16"><path fill="currentColor" d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg></span>
    <span class="callout-title">CAUTION</span>
  </div>
  <div class="callout-content">
    <ul>
<li>
<p>ä¸è¦ä½¿ç”¨&quot;ç›®å…‰è°ƒè¯•æ³•&quot;, è¦æ€è€ƒå¦‚ä½•ç”¨æ­£ç¡®çš„å·¥å…·å’Œæ–¹æ³•å¸®åŠ©è°ƒè¯•</p>
<ul>
<li>ç¨‹åºè®¾è®¡è¯¾ä¸Šç›¯ç€å‡ åè¡Œçš„ç¨‹åº, ä½ æˆ–è®¸è¿˜èƒ½åœ¨å¤§è„‘ä¸­åƒNEMUé‚£æ ·æ¨¡æ‹Ÿç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹; ä½†ç¨‹åºè§„æ¨¡å¤§äº†ä¹‹å, å¾ˆå¿«ä½ å°±ä¼šæ”¾å¼ƒçš„: ä½ çš„å¤§è„‘ä¸å¯èƒ½æ¨¡æ‹Ÿå¾—äº†ä¸€ä¸ªå·¨å¤§çš„çŠ¶æ€æœº</li>
<li>æˆ‘ä»¬å­¦ä¹ è®¡ç®—æœºæ˜¯ä¸ºäº†å­¦ä¹ è®¡ç®—æœºçš„å·¥ä½œåŸç†, è€Œä¸æ˜¯å­¦ä¹ å¦‚ä½•åƒè®¡ç®—æœºé‚£æ ·æœºæ¢°åœ°å·¥ä½œ</li>
</ul>
</li>
<li>
<p>ä½¿ç”¨</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>assert()
</span></span></code></pre></td></tr></table>
</div>
</div><p>è®¾ç½®æ£€æŸ¥ç‚¹, æ‹¦æˆªéé¢„æœŸæƒ…å†µ</p>
<ul>
<li>ä¾‹å¦‚<code>assert(p != NULL)</code>å°±å¯ä»¥æ‹¦æˆªç”±ç©ºæŒ‡é’ˆè§£å¼•ç”¨å¼•èµ·çš„æ®µé”™è¯¯</li>
</ul>
</li>
<li>
<p>ç»“åˆå¯¹ç¨‹åºæ‰§è¡Œè¡Œä¸ºçš„ç†è§£, ä½¿ç”¨</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>printf()
</span></span></code></pre></td></tr></table>
</div>
</div><p>æŸ¥çœ‹ç¨‹åºæ‰§è¡Œçš„æƒ…å†µ(æ³¨æ„å­—ç¬¦ä¸²è¦æ¢è¡Œ)</p>
<ul>
<li><code>printf()</code>è¾“å‡ºä»»æ„ä¿¡æ¯å¯ä»¥æ£€æŸ¥ä»£ç å¯è¾¾æ€§: è¾“å‡ºäº†ç›¸åº”ä¿¡æ¯, å½“ä¸”ä»…å½“ç›¸åº”çš„ä»£ç å—è¢«æ‰§è¡Œ</li>
<li><code>printf()</code>è¾“å‡ºå˜é‡çš„å€¼, å¯ä»¥æ£€æŸ¥å…¶å˜åŒ–è¿‡ç¨‹ä¸åŸå› </li>
</ul>
</li>
<li>
<p>ä½¿ç”¨GDBè§‚å¯Ÿç¨‹åºçš„ä»»æ„çŠ¶æ€å’Œè¡Œä¸º</p>
<ul>
<li>æ‰“å°å˜é‡, æ–­ç‚¹, ç›‘è§†ç‚¹, å‡½æ•°è°ƒç”¨æ ˆ&hellip;</li>
</ul>
</li>
</ul>
<p>å¦‚æœä½ çªç„¶è§‰å¾—ä¸Šè¿°æ–¹æ³•å¾ˆæœ‰é“ç†, è¯´æ˜ä½ åœ¨ç¨‹åºè®¾è®¡è¯¾ä¸Šæ²¡æœ‰å—åˆ°è¯¥æœ‰çš„è®­ç»ƒ.</p>

  </div>
</div>
<h3 id="some-concepts-2">Some concepts<a hidden class="anchor" aria-hidden="true" href="#some-concepts-2">#</a></h3>
<ol>
<li>Intr_on</li>
</ol>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// enable device interrupts
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">intr_on</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">w_sstatus</span>(<span style="color:#a6e22e">r_sstatus</span>() <span style="color:#f92672">|</span> SSTATUS_SIE);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨å¤„ç†æŸäº›å…³é”®çš„ä¸­æ–­ç›¸å…³æ“ä½œï¼ˆæ¯”å¦‚ä¿å­˜ä¸Šä¸‹æ–‡åˆ°æ ˆä¸­ï¼‰æ—¶ï¼Œä¸­æ–­æ˜¯è¢«ç¦æ­¢çš„ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿åœ¨å¤„ç†è¿™äº›å…³é”®æ•°æ®æ—¶ä¸ä¼šè¢«å…¶ä»–ä¸­æ–­æ‰“æ–­ã€‚ç­‰åˆ°è¿™äº›æ“ä½œå®Œæˆï¼Œå³æ³¨é‡Šä¸­è¯´çš„â€œdone with those registersâ€ä¹‹åï¼Œå†é€šè¿‡intr_on()å¼€å¯ä¸­æ–­ï¼Œå…è®¸åç»­çš„ä¸­æ–­å‘ç”Ÿã€‚è¿™æ ·æ—¢ä¿è¯äº†å…³é”®æ“ä½œçš„åŸå­æ€§ï¼Œåˆä¸ä¼šé•¿æ—¶é—´å…³é—­ä¸­æ–­ï¼Œå½±å“ç³»ç»Ÿçš„å“åº”èƒ½åŠ›ã€‚</p>
<p>è¿™æ®µä»£ç çš„ä½œç”¨æ˜¯åœ¨ç¡®ä¿å…³é”®å¯„å­˜å™¨ï¼ˆå¦‚sepcã€scauseã€sstatusï¼‰å·²ç»è¢«å¤„ç†ä¹‹åï¼Œé€šè¿‡è®¾ç½®sstatuså¯„å­˜å™¨çš„SIEä½æ¥é‡æ–°å¼€å¯ç›‘ç®¡è€…æ¨¡å¼ä¸‹çš„ä¸­æ–­ï¼Œä»è€Œå…è®¸è®¾å¤‡ä¸­æ–­çš„å“åº”ï¼Œé¿å…åœ¨å¤„ç†è¿™äº›å¯„å­˜å™¨æ—¶è¢«ä¸­æ–­æ‰“æ–­å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚</p>
<p>é¡µæ•…éšœå¼‚å¸¸çš„å¤„ç†éœ€è¦ç²¾ç¡®åœ°ç®¡ç†å†…å­˜çš„æ˜ å°„å…³ç³»ï¼Œé€šå¸¸åŒ…æ‹¬é¡µé¢åˆ†é…ã€é¡µè¡¨æ›´æ–°ã€è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„ç­‰ã€‚æ­¤æ—¶å¦‚æœå¯ç”¨äº†ä¸­æ–­ï¼ˆé€šè¿‡ <code>intr_on()</code>ï¼‰ï¼Œå¯èƒ½ä¼šå¯¼è‡´å…¶ä»–ä¸­æ–­ï¼ˆå¦‚å®šæ—¶å™¨ä¸­æ–­ã€I/O ä¸­æ–­ç­‰ï¼‰å¹²æ‰°å½“å‰å†…å­˜ç®¡ç†çš„æ“ä½œï¼Œä»è€Œç ´åå†…å­˜çŠ¶æ€çš„ä¸€è‡´æ€§ã€‚ é¡µæ•…éšœé€šå¸¸æ˜¯ç”±ç”¨æˆ·ç¨‹åºè®¿é—®äº†ä¸åœ¨ç‰©ç†å†…å­˜ä¸­çš„è™šæ‹Ÿåœ°å€æ‰€å¼•èµ·çš„ï¼Œå› æ­¤æ“ä½œç³»ç»Ÿéœ€è¦åœ¨å†…æ ¸ä¸­ç›´æ¥å¤„ç†è¿™äº›å¼‚å¸¸ã€‚æ­¤æ—¶éœ€è¦ä¿è¯å½“å‰å¼‚å¸¸å¤„ç†æµç¨‹çš„å®Œæ•´æ€§ä¸åŸå­æ€§ï¼Œè€Œä¸è¢«å…¶ä»–ä¸­æ–­æ‰“æ–­ã€‚</p>
<h2 id="lab6-net">Lab6. Net<a hidden class="anchor" aria-hidden="true" href="#lab6-net">#</a></h2>
<p>åœ¨MIT finalçš„ç»Ÿè®¡ä¸­è·å¾—äº†æœ€å¤šçš„unhelpfulï¼Œå®ç°ç½‘å¡é©±åŠ¨å’Œudp serverï¼Œæ–‡æ¡£å¥½å¤šä¸æƒ³çœ‹ï¼ˆ</p>
<h2 id="lab7-lock">Lab7. Lock<a hidden class="anchor" aria-hidden="true" href="#lab7-lock">#</a></h2>
<h3 id="1--memory-allocator">1.  memory allocator<a hidden class="anchor" aria-hidden="true" href="#1--memory-allocator">#</a></h3>
<p>è¿™ä¸€éƒ¨åˆ†éœ€è¦è§£å†³å†…å­˜åˆ†é…å‘ç”Ÿçš„é”äº‰ç”¨é—®é¢˜ï¼Œé”äº‰ç”¨çš„æ ¹æœ¬åŸå› æ˜¯ <code>kalloc</code>åªæœ‰ä¸€ä¸ªç©ºé—²åˆ—è¡¨ï¼Œç”±ä¸€ä¸ªé”ä¿æŠ¤ã€‚è¦æ¶ˆé™¤é”äº‰ç”¨ï¼Œå¿…é¡»é‡æ–°è®¾è®¡å†…å­˜åˆ†é…å™¨ã€‚åŸºæœ¬æ€æƒ³æ˜¯ä¸ºæ¯ä¸ª CPU ç»´æŠ¤ä¸€ä¸ªç©ºé—²åˆ—è¡¨ï¼Œæ¯ä¸ªåˆ—è¡¨éƒ½æœ‰è‡ªå·±çš„é”ã€‚ä¸åŒ CPU ä¸Šçš„åˆ†é…å’Œé‡Šæ”¾å¯ä»¥å¹¶è¡Œè¿è¡Œï¼Œå› ä¸ºæ¯ä¸ª CPU å°†åœ¨ä¸åŒçš„<code>freelist</code>ä¸Šæ“ä½œã€‚ä¸»è¦æŒ‘æˆ˜æ˜¯å¤„ç†ä¸€ä¸ª CPU çš„<code>freelist</code>ä¸ºç©ºï¼Œä½†å¦ä¸€ä¸ª CPU çš„åˆ—è¡¨æœ‰<code>freelist</code>çš„æƒ…å†µï¼›åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸€ä¸ª CPU å¿…é¡»â€œçªƒå–â€å¦ä¸€ä¸ª CPU ç©ºé—²åˆ—è¡¨çš„ä¸€éƒ¨åˆ†ã€‚</p>
<p>ä½¿ç”¨referencesæ¥ç»Ÿè®¡<code>cpuid</code>çš„<code>freelist</code>å¤§å°ï¼Œå½“æŸä¸ªç©ºé—²åˆ—è¡¨å†…å­˜ä¸å¤Ÿæ—¶çªƒå–referencesæœ€å¤§çš„CPU<code>freelist</code></p>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250223002933896.png" 
       alt="å†…å­˜åˆ†é…å™¨ä¼˜åŒ–" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">ä¸ºæ¯ä¸ªCPUç»´æŠ¤ä¸€ä¸ªç©ºé—²åˆ—è¡¨ï¼Œè§£å†³é”äº‰ç”¨é—®é¢˜</div></div>
<p>åˆå§‹åŒ–<code>freelist</code>å’Œ<code>references</code></p>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250223003301185.png" 
       alt="kallocåˆå§‹åŒ–" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">åˆå§‹åŒ–freelistå’Œreferences</div></div>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250223003224496.png" 
       alt="kfreeå®ç°" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">kfreeçš„æ–°å®ç°</div></div>
<p>è®¾è®¡æ–°çš„<code>kalloc</code>å’Œ<code>kfree</code></p>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250223003354170.png" 
       alt="æ–°kallocå®ç°" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">æ–°çš„kallocå®ç°</div></div>
<div class="image-container"><div class="code-screenshot"><img src="/images/image-20250223003408551.png" 
       alt="æ–°kfreeå®ç°" 
       class="img-large code-screenshot"
       loading="lazy" /></div><div class="image-caption">æ–°çš„kfreeå®ç°ä»£ç </div></div>
<h3 id="2--buffer-cache">2.  buffer cache<a hidden class="anchor" aria-hidden="true" href="#2--buffer-cache">#</a></h3>
<p>è¿™ä¸€éƒ¨åˆ†éœ€è¦è§£å†³bufferç¼“å­˜è®¿é—®çš„é”äº‰ç”¨é—®é¢˜ï¼Œè¿™ä¸ªlabå®˜ç½‘å†™çš„æ¯”è¾ƒæ¨¡ç³Šï¼Œç†è§£èµ·æ¥æ¯”è¾ƒå›°éš¾ï¼Œè€Œä¸”<code>bcachetest</code>ä¸å¤Ÿå¥å£®ï¼Œå¾ˆå¤šéšè—é—®é¢˜æ˜¯æµ‹è¯•ä¸å‡ºæ¥çš„ï¼Œç”šè‡³ä»£ç å®ç°å®Œå…¨æœ‰é—®é¢˜å’Œbugéƒ½å¯èƒ½è¿‡æµ‹è¯•ï¼Œå»ºè®®å®Œæˆåå‚è€ƒä¸€ä¸‹<a href="https://blog.miigon.net/posts/s081-lab8-locks/#%E5%AE%8C%E6%95%B4%E4%BC%AA%E4%BB%A3%E7%A0%81">å¤§ä½¬çš„Blog</a>ï¼Œä¸‹é¢æœ‰å¾ˆå¤šå…³äºè¿™ä¸ªlabçš„è®¨è®ºï¼Œæ£€æŸ¥æœ‰æ²¡æœ‰æ²¡è€ƒè™‘çš„é”äº‰ç”¨/æ­»é”æƒ…å†µ</p>
<p>åˆšçœ‹è¿™ä¸ªlabå’Œå®˜ç½‘çš„ä»‹ç»å®Œå…¨ä¸ç†è§£å¦‚ä½•åˆ©ç”¨å­˜å‚¨bucketã€å“ˆå¸Œè¡¨æ¥ä¼˜åŒ–é”äº‰ç”¨é—®é¢˜ï¼Œæˆ‘ç”¨aiå¸®åŠ©ç†è§£äº†ä¸€ä¸‹ï¼š</p>
<blockquote>
<h4 id="deepseek">deepseek:<a hidden class="anchor" aria-hidden="true" href="#deepseek">#</a></h4>
<p>å‰å®ç°å¯èƒ½ä½¿ç”¨äº†ä¸€ä¸ªå…¨å±€é”ï¼ˆæ¯”å¦‚bcache.lockï¼‰æ¥ä¿æŠ¤æ•´ä¸ªç¼“å­˜é“¾è¡¨ã€‚å½“å¤šä¸ªè¿›ç¨‹åŒæ—¶è®¿é—®ä¸åŒçš„å—æ—¶ï¼Œè¿™ä¸ªå…¨å±€é”ä¼šæˆä¸ºç“¶é¢ˆï¼Œå¯¼è‡´é”ç«äº‰ï¼Œä»è€Œå¢åŠ acquireçš„è¿­ä»£æ¬¡æ•°ã€‚</p>
<p>ç”¨æˆ·å»ºè®®ä½¿ç”¨å“ˆå¸Œæ¡¶å’Œæ¯ä¸ªæ¡¶çš„é”æ¥æ›¿ä»£åŸæ¥çš„å…¨å±€é”ã€‚è¿™æ ·ï¼Œä¸åŒçš„å—å¯èƒ½åˆ†å¸ƒåˆ°ä¸åŒçš„æ¡¶ä¸­ï¼Œæ¯ä¸ªæ¡¶æœ‰è‡ªå·±çš„é”ã€‚è¿™æ ·ï¼Œå½“è®¿é—®ä¸åŒæ¡¶ä¸­çš„å—æ—¶ï¼Œå°±ä¸ä¼šç«äº‰åŒä¸€æŠŠé”ï¼Œä»è€Œå‡å°‘å†²çªã€‚è¿™åº”è¯¥èƒ½æœ‰æ•ˆé™ä½é”çš„äº‰ç”¨ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘éœ€è¦ä¿®æ”¹bgetå’Œbrelseå‡½æ•°ã€‚åŸæ¥çš„å®ç°å¯èƒ½æ˜¯åœ¨å…¨å±€é”çš„ä¿æŠ¤ä¸‹éå†æ•´ä¸ªé“¾è¡¨æŸ¥æ‰¾å—ã€‚ç°åœ¨åº”è¯¥æ›¿æ¢ä¸ºå“ˆå¸Œè¡¨æŸ¥æ‰¾ï¼Œæ¯ä¸ªæ¡¶æœ‰è‡ªå·±çš„é”ã€‚è¿™æ ·ï¼Œå½“æŸ¥æ‰¾ä¸€ä¸ªå—æ—¶ï¼Œåªéœ€è¦é”ä½å¯¹åº”çš„æ¡¶ï¼Œè€Œä¸æ˜¯æ•´ä¸ªç¼“å­˜ã€‚</p>
<p>éœ€è¦åšçš„ä¸»è¦æ­¥éª¤å¯èƒ½æœ‰ï¼š</p>
<ol>
<li>å®šä¹‰å“ˆå¸Œæ¡¶çš„æ•°é‡ï¼Œä¾‹å¦‚ä½¿ç”¨è´¨æ•°ï¼ˆå¦‚13ï¼‰ä½œä¸ºæ¡¶çš„æ•°é‡ï¼Œä»¥å‡å°‘å“ˆå¸Œå†²çªã€‚</li>
<li>ä¸ºæ¯ä¸ªå“ˆå¸Œæ¡¶åˆ†é…ä¸€ä¸ªé”ï¼Œåç§°ä»¥â€œbcacheâ€å¼€å¤´ï¼Œæ¯”å¦‚â€œbcache.bucket0â€ã€‚</li>
<li>åœ¨bgetå‡½æ•°ä¸­ï¼Œå…ˆæ ¹æ®å—å·è®¡ç®—å“ˆå¸Œå€¼ï¼Œæ‰¾åˆ°å¯¹åº”çš„æ¡¶ï¼Œå¹¶è·å–è¯¥æ¡¶çš„é”ã€‚</li>
<li>åœ¨è¯¥æ¡¶çš„é“¾è¡¨ä¸­æŸ¥æ‰¾å—æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™è·å–è¯¥bufçš„é”ï¼Œå¯èƒ½å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå¹¶é‡Šæ”¾æ¡¶é”ã€‚</li>
<li>å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™éœ€è¦æ‰¾åˆ°ä¸€ä¸ªæœªè¢«ä½¿ç”¨çš„ç¼“å†²åŒºï¼ˆrefcnt == 0ï¼‰ã€‚æ­¤æ—¶å¯èƒ½éœ€è¦éå†æ‰€æœ‰ç¼“å†²åŒºæˆ–è€…æœ‰å¦ä¸€ç§æ–¹å¼æŸ¥æ‰¾ã€‚ä½†è¿™é‡Œå¯èƒ½éœ€è¦å¤„ç†å¤šä¸ªæ¡¶çš„æƒ…å†µï¼Œæ¯”å¦‚éå†å…¶ä»–æ¡¶æ¥å¯»æ‰¾å¯æ›¿æ¢çš„å—ã€‚è¿™æ—¶å€™å¯èƒ½éœ€è¦è·å–å…¶ä»–æ¡¶çš„é”ï¼Œéœ€è¦æ³¨æ„æ­»é”é—®é¢˜ã€‚</li>
<li>å½“æ›¿æ¢å—æ—¶ï¼Œå¯èƒ½éœ€è¦å°†åŸæ¥çš„bufä»ä¸€ä¸ªæ¡¶ç§»åŠ¨åˆ°å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ¶‰åŠåˆ°ä¸¤ä¸ªæ¡¶çš„é”ï¼Œå¿…é¡»æŒ‰é¡ºåºè·å–ï¼Œé¿å…æ­»é”ã€‚ä¾‹å¦‚ï¼Œæ€»æ˜¯å…ˆè·å–æ—§æ¡¶çš„é”ï¼Œå†è·å–æ–°æ¡¶çš„é”ï¼Œæˆ–è€…æŒ‰ç…§ä¸€å®šçš„é¡ºåºè·å–ã€‚</li>
</ol>
<p>åŸæ¥çš„LRUæœºåˆ¶éœ€è¦è¢«ç§»é™¤ï¼Œæ‰€ä»¥brelseä¸éœ€è¦å°†å—ç§»åŠ¨åˆ°LRUé“¾è¡¨ã€‚å› æ­¤ï¼Œbrelseå¯èƒ½åªéœ€è¦ä¿®æ”¹å¼•ç”¨è®¡æ•°ï¼Œå¹¶åœ¨é‡Šæ”¾æ—¶ä¸éœ€è¦è·å–å…¨å±€é”ï¼Œè€Œæ˜¯å¯èƒ½è·å–å¯¹åº”æ¡¶çš„é”æˆ–è€…bufçš„é”ã€‚</p></blockquote>
<p>æ€»ç»“æ¥è¯´ï¼ŒåŸæ¥çš„ç¼“å­˜ä½¿ç”¨ä¸€ä¸ªåŒç«¯å¾ªç¯é“¾è¡¨æ¥ç»´æŠ¤ï¼Œå¯¼è‡´<code>buffer cache</code>å¿…é¡»ä½¿ç”¨ä¸€ä¸ªå…¨å±€é”ï¼Œå¯¼è‡´å¤šè¿›ç¨‹è®¿é—®ç¼“å­˜å¾ˆå®¹æ˜“äº§ç”Ÿé”äº‰ç”¨ï¼Œç°åœ¨è¿›è¡Œä¼˜åŒ–ï¼Œå°†å¤§å°ä¸ºNBUFçš„ç¼“å­˜åˆ†å­˜å‚¨åˆ°Nä¸ªæ¡¶ï¼Œæ¯æ¬¡æŸ¥æ‰¾ç¼“å­˜åªä¼šæ‰¾å¯¹åº”çš„æ¡¶ï¼Œå¦‚ä½•æ‰¾å¯¹åº”çš„æ¡¶ï¼Ÿä½¿ç”¨å“ˆå¸Œè¡¨(æ•£åˆ—æ¡¶)å»ºç«‹æ˜ å°„ï¼Œæ¯ä¸ªå“ˆå¸Œè¡¨é¡¹å¯¹åº”ä¸€ä¸ªæ¡¶ï¼Œæ¡¶ä¸­å­˜å‚¨ä¸€ä¸ªé“¾è¡¨ï¼ˆå­˜å‚¨ç¼“å­˜ï¼‰ï¼Œæˆ‘ç®€å•åœ°å°†<code>blockno</code>è½¬åŒ–ä¸ºå“ˆå¸Œå€¼è¿›è¡Œæ˜ å°„ã€‚å¦‚æœåœ¨è¯¥æ¡¶ä¸­æ²¡æœ‰æ‰¾åˆ°ç¼“å­˜ï¼Œè¯´æ˜åœ¨æ‰€æœ‰çš„æ¡¶ä¸­éƒ½ä¸åº”è¯¥å­˜åœ¨è¯¥ç¼“å­˜ï¼Œéœ€è¦åœ¨è¯¥æ¡¶ä¸­æ·»åŠ æ–°çš„ç¼“å­˜ï¼ˆå¦‚ä½•æ²¡æœ‰èƒ½å­˜å‚¨<code>ï¼ˆrefcnt=0ï¼‰</code>çš„bufï¼Œéœ€è¦ä»åˆ«çš„æ¡¶ä¸­<code>move buf</code>ï¼‰ã€‚å¦å¤–éœ€è¦ä¸ºæ¯ä¸ªæ¡¶æ·»åŠ é”ï¼Œé˜²æ­¢åŒæ—¶å¯¹æ¡¶çš„å†™å…¥é€ æˆå¹¶å‘å†²çªï¼Œå¦å¤–éœ€è¦ä¸€ä¸ªå…¨å±€é”ç»´æŠ¤æ‰€æœ‰æ¡¶çš„é“¾è¡¨ç»“æ„ï¼Œé¿å…ä¸¤ä¸ªè¿›ç¨‹åŒæ—¶å‘èµ·<code>move buf</code>é€ æˆç¯è·¯æ­»é”</p>
<p>å»ºç«‹å“ˆå¸Œå‡½æ•°</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#define BUCKETS_NUM 13
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define HASH_SEATCH(blockno) (blockno % BUCKETS_NUM)  </span><span style="color:#75715e">// find the bucket
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æ–°å»ºç«‹çš„ç¼“å­˜ç»“æ„ä½“</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// new buffer cache
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> spinlock lock;                     <span style="color:#75715e">// global lock for move buf
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> buf buf[NBUF];                     <span style="color:#75715e">// buffer cache less than NBUF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> buf buckets[BUCKETS_NUM];          <span style="color:#75715e">// use buckets to store and get cache
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> spinlock bucketlock[BUCKETS_NUM];  <span style="color:#75715e">// bucket lock instead of the global lock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>} bcache;
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆå§‹åŒ–buffer cache</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">binit</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> buf <span style="color:#f92672">*</span>b;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// init global lock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">initlock</span>(<span style="color:#f92672">&amp;</span>bcache.lock, <span style="color:#e6db74">&#34;bcache&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Each bucket starts with a double-ended circular linked list
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// Set head&#39;refcnt to 1 to indicate that it cannot be moved.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> BUCKETS_NUM; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">initlock</span>(<span style="color:#f92672">&amp;</span>bcache.bucketlock[i], <span style="color:#e6db74">&#34;bcachelock&#34;</span>);
</span></span><span style="display:flex;"><span>    bcache.buckets[i].next <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>bcache.buckets[i];
</span></span><span style="display:flex;"><span>    bcache.buckets[i].prev <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>bcache.buckets[i];
</span></span><span style="display:flex;"><span>    bcache.buckets[i].refcnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Initialize each buffer cache and store in buckets
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (b <span style="color:#f92672">=</span> bcache.buf; b <span style="color:#f92672">&lt;</span> bcache.buf <span style="color:#f92672">+</span> NBUF; b<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">initsleeplock</span>(<span style="color:#f92672">&amp;</span>b<span style="color:#f92672">-&gt;</span>lock, <span style="color:#e6db74">&#34;buffer&#34;</span>);
</span></span><span style="display:flex;"><span>    b<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> bcache.buckets[<span style="color:#ae81ff">0</span>].next;
</span></span><span style="display:flex;"><span>    b<span style="color:#f92672">-&gt;</span>prev <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>bcache.buckets[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>    bcache.buckets[<span style="color:#ae81ff">0</span>].next<span style="color:#f92672">-&gt;</span>prev <span style="color:#f92672">=</span> b;
</span></span><span style="display:flex;"><span>    bcache.buckets[<span style="color:#ae81ff">0</span>].next <span style="color:#f92672">=</span> b;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ–°çš„bget</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> buf<span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bget</span>(uint dev, uint blockno)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> buf <span style="color:#f92672">*</span>b;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// search the bucket without global lock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> ((b <span style="color:#f92672">=</span> <span style="color:#a6e22e">bucketsearch</span>(dev, blockno)) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> b;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">acquire</span>(<span style="color:#f92672">&amp;</span>bcache.lock);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// search the bucket with global lock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> ((b <span style="color:#f92672">=</span> <span style="color:#a6e22e">bucketsearch</span>(dev, blockno)) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>bcache.lock);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> b;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// find a buffer to move
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> new <span style="color:#f92672">=</span> <span style="color:#a6e22e">HASH_SEATCH</span>(blockno);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> BUCKETS_NUM; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// start from the key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> old <span style="color:#f92672">=</span> (new <span style="color:#f92672">+</span> i) <span style="color:#f92672">%</span> BUCKETS_NUM;
</span></span><span style="display:flex;"><span>    b <span style="color:#f92672">=</span> bcache.buckets[old].prev;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// search current bucket for buf
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> (b <span style="color:#f92672">!=</span> <span style="color:#f92672">&amp;</span>bcache.buckets[old]) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (b<span style="color:#f92672">-&gt;</span>refcnt <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// get both the old and the new bucket lock to move
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">acquire</span>(<span style="color:#f92672">&amp;</span>bcache.bucketlock[old]);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (old <span style="color:#f92672">!=</span> new) <span style="color:#a6e22e">acquire</span>(<span style="color:#f92672">&amp;</span>bcache.bucketlock[new]);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ((b <span style="color:#f92672">=</span> <span style="color:#a6e22e">bufmove</span>(b, old, new)) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>          b<span style="color:#f92672">-&gt;</span>dev <span style="color:#f92672">=</span> dev;
</span></span><span style="display:flex;"><span>          b<span style="color:#f92672">-&gt;</span>blockno <span style="color:#f92672">=</span> blockno;
</span></span><span style="display:flex;"><span>          b<span style="color:#f92672">-&gt;</span>valid <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>          b<span style="color:#f92672">-&gt;</span>refcnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (old <span style="color:#f92672">!=</span> new) <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>bcache.bucketlock[new]); 
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">acquiresleep</span>(<span style="color:#f92672">&amp;</span>b<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>bcache.bucketlock[old]);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>bcache.lock);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> b;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// can&#39;t reach here
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (old <span style="color:#f92672">!=</span> new) <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>bcache.bucketlock[new]); 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>bcache.bucketlock[old]);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>bcache.lock);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;bget error&#34;</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      b <span style="color:#f92672">=</span> b<span style="color:#f92672">-&gt;</span>prev;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// can&#39;t reach here
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>bcache.lock);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;bget: no buffers&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨å¯¹åº”æ¡¶ä¸­å¯»æ‰¾buffer cache</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Find the cache in the bucket corresponding to blockno
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> buf<span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bucketsearch</span>(uint dev, uint blockno)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> buf <span style="color:#f92672">*</span>b;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> key <span style="color:#f92672">=</span> <span style="color:#a6e22e">HASH_SEATCH</span>(blockno);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Accessing the bucket requires the corresponding lock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">acquire</span>(<span style="color:#f92672">&amp;</span>bcache.bucketlock[key]);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (b <span style="color:#f92672">=</span> bcache.buckets[key].next; b <span style="color:#f92672">!=</span> <span style="color:#f92672">&amp;</span>bcache.buckets[key]; b <span style="color:#f92672">=</span> b<span style="color:#f92672">-&gt;</span>next) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (b<span style="color:#f92672">-&gt;</span>dev <span style="color:#f92672">==</span> dev <span style="color:#f92672">&amp;&amp;</span> b<span style="color:#f92672">-&gt;</span>blockno <span style="color:#f92672">==</span> blockno) {
</span></span><span style="display:flex;"><span>      b<span style="color:#f92672">-&gt;</span>refcnt<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>bcache.bucketlock[key]);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">acquiresleep</span>(<span style="color:#f92672">&amp;</span>b<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> b;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>bcache.bucketlock[key]);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ç°buffer move</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// move the buf from the old bucket to the new bucket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> buf<span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bufmove</span>(<span style="color:#66d9ef">struct</span> buf <span style="color:#f92672">*</span>b, <span style="color:#66d9ef">int</span> old, <span style="color:#66d9ef">int</span> new) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (old <span style="color:#f92672">==</span> new) <span style="color:#66d9ef">return</span> b;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Put the buffer in the prev of new bucket head
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  b<span style="color:#f92672">-&gt;</span>prev<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> b<span style="color:#f92672">-&gt;</span>next;
</span></span><span style="display:flex;"><span>  b<span style="color:#f92672">-&gt;</span>next<span style="color:#f92672">-&gt;</span>prev <span style="color:#f92672">=</span> b<span style="color:#f92672">-&gt;</span>prev;
</span></span><span style="display:flex;"><span>  b<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>bcache.buckets[new];
</span></span><span style="display:flex;"><span>  b<span style="color:#f92672">-&gt;</span>prev <span style="color:#f92672">=</span> bcache.buckets[new].prev;
</span></span><span style="display:flex;"><span>  bcache.buckets[new].prev<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> b;
</span></span><span style="display:flex;"><span>  bcache.buckets[new].prev <span style="color:#f92672">=</span> b;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> b;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ–°çš„brelseï¼Œå°†æ–°çš„buffer cacheæ”¾åœ¨bucket head</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">brelse</span>(<span style="color:#66d9ef">struct</span> buf <span style="color:#f92672">*</span>b)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">holdingsleep</span>(<span style="color:#f92672">&amp;</span>b<span style="color:#f92672">-&gt;</span>lock))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;brelse&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">releasesleep</span>(<span style="color:#f92672">&amp;</span>b<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> key <span style="color:#f92672">=</span> <span style="color:#a6e22e">HASH_SEATCH</span>(b<span style="color:#f92672">-&gt;</span>blockno);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">acquire</span>(<span style="color:#f92672">&amp;</span>bcache.bucketlock[key]);
</span></span><span style="display:flex;"><span>  b<span style="color:#f92672">-&gt;</span>refcnt<span style="color:#f92672">--</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (b<span style="color:#f92672">-&gt;</span>refcnt <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Put the buffer in the next of new bucket head for quicker search
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> buf <span style="color:#f92672">*</span>head <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>bcache.buckets[key];
</span></span><span style="display:flex;"><span>    b<span style="color:#f92672">-&gt;</span>prev<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> b<span style="color:#f92672">-&gt;</span>next;
</span></span><span style="display:flex;"><span>    b<span style="color:#f92672">-&gt;</span>next<span style="color:#f92672">-&gt;</span>prev <span style="color:#f92672">=</span> b<span style="color:#f92672">-&gt;</span>prev;
</span></span><span style="display:flex;"><span>    b<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> head<span style="color:#f92672">-&gt;</span>next;
</span></span><span style="display:flex;"><span>    head<span style="color:#f92672">-&gt;</span>next<span style="color:#f92672">-&gt;</span>prev <span style="color:#f92672">=</span> b;
</span></span><span style="display:flex;"><span>    head<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> b;
</span></span><span style="display:flex;"><span>    b<span style="color:#f92672">-&gt;</span>prev <span style="color:#f92672">=</span> head;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>bcache.bucketlock[key]);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¿®æ”¹<code>bpin</code>å’Œ<code>bupin</code>çš„lock</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bpin</span>(<span style="color:#66d9ef">struct</span> buf <span style="color:#f92672">*</span>b) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> key <span style="color:#f92672">=</span> <span style="color:#a6e22e">HASH_SEATCH</span>(b<span style="color:#f92672">-&gt;</span>blockno);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">acquire</span>(<span style="color:#f92672">&amp;</span>bcache.bucketlock[key]);
</span></span><span style="display:flex;"><span>  b<span style="color:#f92672">-&gt;</span>refcnt<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>bcache.bucketlock[key]);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bunpin</span>(<span style="color:#66d9ef">struct</span> buf <span style="color:#f92672">*</span>b) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> key <span style="color:#f92672">=</span> <span style="color:#a6e22e">HASH_SEATCH</span>(b<span style="color:#f92672">-&gt;</span>blockno);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">acquire</span>(<span style="color:#f92672">&amp;</span>bcache.bucketlock[key]);
</span></span><span style="display:flex;"><span>  b<span style="color:#f92672">-&gt;</span>refcnt<span style="color:#f92672">--</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>bcache.bucketlock[key]);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="lab8-fs">Lab8. Fs<a hidden class="anchor" aria-hidden="true" href="#lab8-fs">#</a></h2>
<h3 id="1-large-files">1. large files<a hidden class="anchor" aria-hidden="true" href="#1-large-files">#</a></h3>
<p>è¿™ä¸ªéƒ¨åˆ†éœ€è¦ä¿®æ”¹<code>bmap</code>æ¥æ”¯æŒå¤§æ–‡ä»¶ï¼Œ<code>bmap</code>åœ¨<code>readi</code>å’Œ<code>writei</code>ä¸­è°ƒç”¨ï¼Œè¿”å›è¯»å–æˆ–å†™å…¥çš„æ•°æ®å—ï¼Œå¦‚æœæ²¡æœ‰åˆ†é…åˆ™éœ€è¦åœ¨<code>inode</code>çš„<code>addr</code>ä¸­åŠ å…¥æŒ‡é’ˆæŒ‡å‘æ•°æ®å—ã€‚</p>
<p>åŸæ¥<code>inode</code>æœ‰13ä¸ªåœ°å€æŒ‡é’ˆï¼Œå…¶ä¸­12ä¸ªç›´æ¥æŒ‡å‘æ•°æ®å—ï¼Œç¬¬13ä¸ªä¸ªæŒ‡å‘blockï¼Œå¹¶è¿›è¡Œä¸€æ¬¡æ˜ å°„BSIZE / sizeof(uint)ä¸ªæŒ‡é’ˆã€‚ç°åœ¨éœ€è¦æ”¯æŒlarge fileï¼Œå°†åŸæ¥çš„ä¸€ä¸ªç›´æ¥æ˜ å°„æŒ‡é’ˆè½¬å˜ä¸ºäºŒæ¬¡æ˜ å°„æŒ‡é’ˆã€‚</p>
<p>ä¿®æ”¹NDIRECTçš„å®šä¹‰ï¼Œå¢åŠ NDBDIRECTçš„å®šä¹‰ï¼Œå¯¹åº”ä¿®æ”¹inodeçš„ç»“æ„ä½“</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#define NDIRECT 11
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define NINDIRECT (BSIZE / sizeof(uint))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define NDBINDIRECT ((BSIZE / sizeof(uint)) * (BSIZE / sizeof(uint)))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MAXFILE (NDIRECT + NINDIRECT + NDBINDIRECT)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">// On-disk inode structure
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> dinode {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">short</span> type;           <span style="color:#75715e">// File type
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">short</span> major;          <span style="color:#75715e">// Major device number (T_DEVICE only)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">short</span> minor;          <span style="color:#75715e">// Minor device number (T_DEVICE only)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">short</span> nlink;          <span style="color:#75715e">// Number of links to inode in file system
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  uint size;            <span style="color:#75715e">// Size of file (bytes)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  uint addrs[NDIRECT<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>];   <span style="color:#75715e">// Data block addresses
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¿®æ”¹bmapçš„å®ç°ï¼Œå¢åŠ äºŒæ¬¡æ˜ å°„çš„éƒ¨åˆ†</p>
<p><code>addrs[NDIRECT+1]</code>æŒ‡å‘ç¬¬ä¸€ä¸ªblockï¼Œä¸åŒäº<code>addrs[NDIRECT]</code>blockçš„æŒ‡é’ˆç›´æ¥æŒ‡å‘æ•°æ®å—ï¼Œè¿™é‡Œçš„blockéœ€è¦ç»§ç»­åˆ†é…æŒ‡é’ˆæŒ‡å‘æ–°çš„blockï¼Œä¸€å…±åˆ†é…<code>256 x 256</code>çš„æ•°æ®å—</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>bn <span style="color:#f92672">-=</span> NINDIRECT;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (bn <span style="color:#f92672">&lt;</span> NDBINDIRECT) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((addr <span style="color:#f92672">=</span> ip<span style="color:#f92672">-&gt;</span>addrs[NDIRECT<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">balloc</span>(ip<span style="color:#f92672">-&gt;</span>dev);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (addr <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      ip<span style="color:#f92672">-&gt;</span>addrs[NDIRECT<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> addr;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> level <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>; level <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>; level<span style="color:#f92672">--</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> n <span style="color:#f92672">=</span> (level <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">?</span> bn <span style="color:#f92672">/</span> NINDIRECT : bn <span style="color:#f92672">%</span> NINDIRECT);
</span></span><span style="display:flex;"><span>      bp <span style="color:#f92672">=</span> <span style="color:#a6e22e">bread</span>(ip<span style="color:#f92672">-&gt;</span>dev, addr);
</span></span><span style="display:flex;"><span>      a <span style="color:#f92672">=</span> (uint <span style="color:#f92672">*</span>)bp<span style="color:#f92672">-&gt;</span>data;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ((addr <span style="color:#f92672">=</span> a[n]) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">balloc</span>(ip<span style="color:#f92672">-&gt;</span>dev);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (addr) {
</span></span><span style="display:flex;"><span>          a[n] <span style="color:#f92672">=</span> addr;
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">log_write</span>(bp);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">brelse</span>(bp);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> addr;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;bmap: out of range&#34;</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2-symbolic-links">2. symbolic links<a hidden class="anchor" aria-hidden="true" href="#2-symbolic-links">#</a></h3>
<p>è¿™ä¸€éƒ¨åˆ†éœ€è¦å®ç°sys_symlinkç³»ç»Ÿè°ƒç”¨å®ç°è½¯é“¾æ¥ï¼Œç±»ä¼¼äº<code>ln -s</code></p>
<p>é¦–å…ˆå°†å‚æ•°è§£æè¿‘targetå’Œpathï¼Œå¹¶å¼€å¯æ—¥å¿—è®°å½•ï¼Œç„¶åç»™é“¾æ¥çš„ç›®æ ‡<code>path</code>åˆ›å»ºinodeï¼ŒåŒæ—¶å‘inodeçš„æ•°æ®å—å†™å…¥é“¾æ¥çš„æ–‡ä»¶å</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>uint64
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sys_symlink</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> path[MAXPATH];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> target[MAXPATH];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> inode <span style="color:#f92672">*</span>ip;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> n, r;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((n <span style="color:#f92672">=</span> <span style="color:#a6e22e">argstr</span>(<span style="color:#ae81ff">0</span>, target, MAXPATH)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((n <span style="color:#f92672">=</span> <span style="color:#a6e22e">argstr</span>(<span style="color:#ae81ff">1</span>, path, MAXPATH)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">begin_op</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  ip <span style="color:#f92672">=</span> <span style="color:#a6e22e">create</span>(path, T_SYMLINK, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (ip <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">end_op</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((r <span style="color:#f92672">=</span> <span style="color:#a6e22e">writei</span>(ip, <span style="color:#ae81ff">0</span>, (uint64)target, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">strlen</span>(target)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)) <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">strlen</span>(target)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">iunlockput</span>(ip);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">end_op</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">iunlockput</span>(ip);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">end_op</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¿®æ”¹sys_openç³»ç»Ÿè°ƒç”¨ï¼Œä½¿å…¶èƒ½å¤Ÿå¤„ç†ç±»å‹ä¸º<code>T_Symlink</code>çš„æ–‡ä»¶</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> depth <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> (ip<span style="color:#f92672">-&gt;</span>type <span style="color:#f92672">==</span> T_SYMLINK <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>(omode <span style="color:#f92672">&amp;</span> O_NOFOLLOW)) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> r <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> addr[MAXPATH];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((r <span style="color:#f92672">=</span> <span style="color:#a6e22e">readi</span>(ip, <span style="color:#ae81ff">0</span>, (uint64)addr, <span style="color:#ae81ff">0</span>, MAXPATH)) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">iunlockput</span>(ip);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">end_op</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">iunlockput</span>(ip);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((ip <span style="color:#f92672">=</span> <span style="color:#a6e22e">namei</span>(addr)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">end_op</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ilock</span>(ip);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">++</span>depth <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">9</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">iunlockput</span>(ip);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">end_op</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="lab9-mmap">Lab9. mmap<a hidden class="anchor" aria-hidden="true" href="#lab9-mmap">#</a></h2>
<p>åˆæ˜¯ä¸€ä¸ªå•ç‹¬çš„hard labï¼Œè¿™äº›å•åˆ—çš„hard labéƒ½é¢‡å…·æŒ‘æˆ˜</p>
<p>è¿™ä¸ªlabéœ€è¦å®ç°<code>mmap</code>ç³»ç»Ÿè°ƒç”¨å’Œ<code>munmap</code>ç³»ç»Ÿè°ƒç”¨ï¼Œ<code>mmap</code>ç³»ç»Ÿè°ƒç”¨ç”¨äºå°†æ–‡ä»¶çš„æ•°æ®å—è™šæ‹ŸåŒ–ä¸ºå†…å­˜ï¼Œè®©ç”¨æˆ·å¯ä»¥ç›´æ¥è¯»å†™å†…å­˜æ¥æ¨¡æ‹Ÿå®ç°è¯»å–æ–‡ä»¶ï¼Œå®ç°çš„ç»†èŠ‚å¾ˆå¤šï¼Œåé¢ç›´æ¥å˜æˆé¢å‘test debugäº†</p>
<p>å…·ä½“å®ç°å’Œç›¸å…³è¯­å¥çš„ä½œç”¨ç›´æ¥å†™åœ¨æ³¨é‡Šé‡Œï¼š</p>
<p>å¼€å§‹çš„æ—¶å€™æˆ‘æŠŠvmaç›¸å…³çš„ç”¨æˆ·å†…å­˜ä»ä½åœ°å€å¼€å§‹å¯»æ‰¾ï¼Œä½†æ˜¯ç”±äºä½åœ°å€ä¸ä»…å­˜æ”¾forkåçˆ¶è¿›ç¨‹çš„é¡µè¡¨æ•°æ®ï¼Œè€Œä¸”å†å¾€ä¸Šæ˜¯å‘ä¸‹ç”Ÿé•¿çš„æ ˆï¼Œä¼šå‘ç”Ÿä¸å¯é¢„çŸ¥çš„é”™è¯¯ã€‚æ‰€ä»¥vmaçš„åœ°å€è®¾ç½®åœ¨ç”¨æˆ·å†…å­˜çš„æœ€é«˜å¤„ï¼ˆtrapframeä¸‹</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>uint64
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sys_mmap</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> index;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> fd;
</span></span><span style="display:flex;"><span>  uint64 va;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> VMA vma;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#a6e22e">myproc</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// get args
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">argaddr</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>vma.addr);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">argint</span>(<span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>vma.len);
</span></span><span style="display:flex;"><span>  vma.len <span style="color:#f92672">=</span> <span style="color:#a6e22e">PGROUNDUP</span>(vma.len);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">argint</span>(<span style="color:#ae81ff">2</span>, <span style="color:#f92672">&amp;</span>vma.prot);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">argint</span>(<span style="color:#ae81ff">3</span>, <span style="color:#f92672">&amp;</span>vma.flags);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">argfd</span>(<span style="color:#ae81ff">4</span>, <span style="color:#f92672">&amp;</span>fd, <span style="color:#f92672">&amp;</span>vma.f) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">argint</span>(<span style="color:#ae81ff">5</span>, <span style="color:#f92672">&amp;</span>vma.offset);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// check prot and flags
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// å¦‚æœè®¾ç½®ä¸ºMAP_SHAREDéœ€è¦æ£€æŸ¥è¯¥æ–‡ä»¶æ˜¯å¦èƒ½å¤Ÿè¯»å…¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(vma.flags <span style="color:#f92672">&amp;</span> MAP_PRIVATE) <span style="color:#f92672">&amp;&amp;</span> ((<span style="color:#f92672">!</span>vma.f<span style="color:#f92672">-&gt;</span>readable <span style="color:#f92672">&amp;&amp;</span> (vma.prot <span style="color:#f92672">&amp;</span> PROT_READ)) 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">||</span> (<span style="color:#f92672">!</span>vma.f<span style="color:#f92672">-&gt;</span>writable <span style="color:#f92672">&amp;&amp;</span> (vma.prot <span style="color:#f92672">&amp;</span> PROT_WRITE))))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// find a vma to store
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (index <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; index <span style="color:#f92672">&lt;</span> NVMA; index<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>p<span style="color:#f92672">-&gt;</span>vmas[index].len) <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (index <span style="color:#f92672">==</span> NVMA) <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;sys_mmap: no VMA to free&#34;</span>);
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>vmas[index] <span style="color:#f92672">=</span> vma;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// å¢åŠ æ–‡ä»¶çš„refè®¡æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">filedup</span>(p<span style="color:#f92672">-&gt;</span>vmas[index].f);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// find a va space to map
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (va <span style="color:#f92672">=</span> VMABASE; va <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>; va <span style="color:#f92672">-=</span> PGSIZE) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((<span style="color:#a6e22e">walkaddr</span>(p<span style="color:#f92672">-&gt;</span>pagetable, va)) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ£€æŸ¥å†å¾€ä¸‹çš„å†…å­˜æ˜¯å¦è¢«map
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    uint64 vaend <span style="color:#f92672">=</span> va;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (; va <span style="color:#f92672">&gt;</span> vaend <span style="color:#f92672">-</span> vma.len; va <span style="color:#f92672">-=</span> PGSIZE)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ((<span style="color:#a6e22e">walkaddr</span>(p<span style="color:#f92672">-&gt;</span>pagetable, va)) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ£€æŸ¥è¿™é‡Œçš„å†…å­˜æ˜¯å¦æ˜¯æœªè¢«åŠ è½½çš„vma
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (va <span style="color:#f92672">==</span> vaend <span style="color:#f92672">-</span> vma.len <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">conflictdet</span>(p<span style="color:#f92672">-&gt;</span>vmas, va <span style="color:#f92672">+</span> PGSIZE, vma.len)) {
</span></span><span style="display:flex;"><span>      p<span style="color:#f92672">-&gt;</span>vmas[index].addr <span style="color:#f92672">=</span> va <span style="color:#f92672">+</span> PGSIZE;
</span></span><span style="display:flex;"><span>      p<span style="color:#f92672">-&gt;</span>vmas[index].base <span style="color:#f92672">=</span> va <span style="color:#f92672">+</span> PGSIZE;    <span style="color:#75715e">// baseéœ€è¦ç”¨äºä¹‹åå†™å…¥æ–‡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>vmas[index].addr) <span style="color:#66d9ef">return</span> p<span style="color:#f92672">-&gt;</span>vmas[index].addr;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ£€æŸ¥vaæ˜¯å¦ä¸å­˜åœ¨çš„vmaäº§ç”Ÿå†²çª</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">conflictdet</span>(<span style="color:#66d9ef">struct</span> VMA <span style="color:#f92672">*</span>vmas, uint64 va, <span style="color:#66d9ef">int</span> len)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> NVMA; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (vmas[i].len) {
</span></span><span style="display:flex;"><span>      uint64 left <span style="color:#f92672">=</span> vmas[i].addr;
</span></span><span style="display:flex;"><span>      uint64 right <span style="color:#f92672">=</span> vmas[i].addr <span style="color:#f92672">+</span> vmas[i].len;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (va <span style="color:#f92672">&lt;</span> right <span style="color:#f92672">&amp;&amp;</span> va<span style="color:#f92672">+</span>len <span style="color:#f92672">&gt;=</span> left)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> i;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å†è¯»å…¥scauseä¸º13å’Œ15æ—¶å¤„ç†page fault</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pagefaulthandler</span>(uint64 fault_addr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> n;
</span></span><span style="display:flex;"><span>  uint64 va;
</span></span><span style="display:flex;"><span>  uint64 pa;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>mem;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> VMA <span style="color:#f92672">*</span>vma;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#a6e22e">myproc</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// æ£€æŸ¥fault_addræ˜¯å¦ä½äºvmaå†…å­˜åŒºåŸŸ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> index;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((index <span style="color:#f92672">=</span> <span style="color:#a6e22e">conflictdet</span>(p<span style="color:#f92672">-&gt;</span>vmas, fault_addr, <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;page fault: addr not assigned</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  vma <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>vmas[index];
</span></span><span style="display:flex;"><span>  va <span style="color:#f92672">=</span> <span style="color:#a6e22e">PGROUNDDOWN</span>(fault_addr);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// å¦‚æœå·²è¢«æ˜ å°„ä½†ä»è§¦å‘page faultå¯èƒ½æ˜¯å°è¯•å†™å…¥ä¸å¯å†™é¡µé¢
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> ((pa <span style="color:#f92672">=</span> <span style="color:#a6e22e">walkaddr</span>(p<span style="color:#f92672">-&gt;</span>pagetable, fault_addr)) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(<span style="color:#a6e22e">PA2PTE</span>(pa) <span style="color:#f92672">&amp;</span> PTE_W))
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((mem <span style="color:#f92672">=</span> <span style="color:#a6e22e">kalloc</span>()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;page fault: Page Fault: no free memory</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memset</span>(mem, <span style="color:#ae81ff">0</span>, PGSIZE);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// è¿›è¡Œfileçš„æ“ä½œéœ€è¦æŒæœ‰é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// å°†fileçš„å†…å­˜è¯»å…¥ç‰©ç†å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">ilock</span>(vma<span style="color:#f92672">-&gt;</span>f<span style="color:#f92672">-&gt;</span>ip);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((n <span style="color:#f92672">=</span> <span style="color:#a6e22e">readi</span>(vma<span style="color:#f92672">-&gt;</span>f<span style="color:#f92672">-&gt;</span>ip, <span style="color:#ae81ff">0</span>, (uint64)mem, vma<span style="color:#f92672">-&gt;</span>offset <span style="color:#f92672">+</span> va <span style="color:#f92672">-</span> vma<span style="color:#f92672">-&gt;</span>addr, PGSIZE)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;page fault: read file fail</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">iunlock</span>(vma<span style="color:#f92672">-&gt;</span>f<span style="color:#f92672">-&gt;</span>ip);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">iunlock</span>(vma<span style="color:#f92672">-&gt;</span>f<span style="color:#f92672">-&gt;</span>ip);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// å°†vaæ˜ å°„åˆ°pa
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// protä¸PTEçš„æƒé™å­˜åœ¨`&lt;&lt;1`çš„å…³ç³»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">mappages</span>(p<span style="color:#f92672">-&gt;</span>pagetable, va, PGSIZE, (uint64)mem, PTE_U <span style="color:#f92672">|</span> (vma<span style="color:#f92672">-&gt;</span>prot <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>)) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">kfree</span>(mem);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Page Fault: mmap map fault</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ç°munmapç³»ç»Ÿè°ƒç”¨ï¼Œå…³äºoffsetæœ‰ä¸€äº›idealçš„å‡è®¾ï¼Œæ¯”å¦‚ä¸ä¼šé‡Šæ”¾ä¸€æ®µvmaä¸­é—´çš„å†…å­˜</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>uint64 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sys_munmap</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> length;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> writelen;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> index;
</span></span><span style="display:flex;"><span>  uint64 addr;
</span></span><span style="display:flex;"><span>  uint64 writeaddr;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> VMA <span style="color:#f92672">*</span>vma;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> inode <span style="color:#f92672">*</span>ip;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#a6e22e">myproc</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">argaddr</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>addr);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">argint</span>(<span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>length);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((index <span style="color:#f92672">=</span> <span style="color:#a6e22e">conflictdet</span>(p<span style="color:#f92672">-&gt;</span>vmas, addr, <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;munmap: not assigned addr&#34;</span>);
</span></span><span style="display:flex;"><span>  vma <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>vmas[index];
</span></span><span style="display:flex;"><span>  ip <span style="color:#f92672">=</span> vma<span style="color:#f92672">-&gt;</span>f<span style="color:#f92672">-&gt;</span>ip;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// æ£€æŸ¥å†™å…¥çš„é•¿åº¦å’Œåœ°å€æ˜¯å¦ä¼šå¯¼è‡´å†™å…¥å¤šä½™å†…å­˜(åˆ†é…æ—¶å‘ä¸ŠPGROUNDUPï¼Œå­˜åœ¨éƒ¨åˆ†å†…å­˜ä¸åº”è¢«ä½¿ç”¨)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  writelen <span style="color:#f92672">=</span> addr <span style="color:#f92672">-</span> vma<span style="color:#f92672">-&gt;</span>base <span style="color:#f92672">+</span> vma<span style="color:#f92672">-&gt;</span>offset <span style="color:#f92672">+</span> length <span style="color:#f92672">&gt;</span> ip<span style="color:#f92672">-&gt;</span>size <span style="color:#f92672">?</span>
</span></span><span style="display:flex;"><span>  (ip<span style="color:#f92672">-&gt;</span>size <span style="color:#f92672">-</span> (addr <span style="color:#f92672">-</span> vma<span style="color:#f92672">-&gt;</span>base <span style="color:#f92672">+</span> vma<span style="color:#f92672">-&gt;</span>offset)) <span style="color:#f92672">:</span> length;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (writelen <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) writelen <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  writeaddr <span style="color:#f92672">=</span> vma<span style="color:#f92672">-&gt;</span>offset <span style="color:#f92672">+</span> addr <span style="color:#f92672">-</span> vma<span style="color:#f92672">-&gt;</span>base <span style="color:#f92672">&gt;</span> ip<span style="color:#f92672">-&gt;</span>size <span style="color:#f92672">?</span> 
</span></span><span style="display:flex;"><span>  (vma<span style="color:#f92672">-&gt;</span>offset) <span style="color:#f92672">:</span> vma<span style="color:#f92672">-&gt;</span>offset <span style="color:#f92672">+</span> addr <span style="color:#f92672">-</span> vma<span style="color:#f92672">-&gt;</span>base;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (vma<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&amp;</span> MAP_SHARED) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// åœ¨fs_system call å‰è°ƒç”¨begin_op
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">begin_op</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ilock</span>(ip);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((<span style="color:#a6e22e">writei</span>(ip, <span style="color:#ae81ff">1</span>, addr, writeaddr, writelen)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">iunlock</span>(ip);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">end_op</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;writelen:%d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, writelen);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;mumap: write back error&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">iunlock</span>(ip);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">end_op</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">vmaunmap</span>(p<span style="color:#f92672">-&gt;</span>pagetable, addr, <span style="color:#a6e22e">PGROUNDUP</span>(length) <span style="color:#f92672">/</span> PGSIZE, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  vma<span style="color:#f92672">-&gt;</span>len <span style="color:#f92672">-=</span> <span style="color:#a6e22e">PGROUNDUP</span>(length);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (vma<span style="color:#f92672">-&gt;</span>len) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (addr <span style="color:#f92672">==</span> vma<span style="color:#f92672">-&gt;</span>addr)
</span></span><span style="display:flex;"><span>      vma<span style="color:#f92672">-&gt;</span>addr <span style="color:#f92672">+=</span> <span style="color:#a6e22e">PGROUNDUP</span>(length);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fileclose</span>(vma<span style="color:#f92672">-&gt;</span>f);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨forkæ—¶å°†çˆ¶è¿›ç¨‹çš„vmaä¿¡æ¯å¤åˆ¶åˆ°å­è¿›ç¨‹ï¼Œç®€å•è€ƒè™‘ï¼Œä»–ä»¬æ²¡æœ‰å…±äº«é¡µé¢ï¼Œä¸”ç”±äºæ˜ å°„åœ¨é«˜åœ°å€å¤„ï¼Œä¸ä¼šå—uvmcopyå½±å“</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> NVMA; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    vma <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>vmas[i];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (vma<span style="color:#f92672">-&gt;</span>len) {
</span></span><span style="display:flex;"><span>      np<span style="color:#f92672">-&gt;</span>vmas[i] <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>vma;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">filedup</span>(vma<span style="color:#f92672">-&gt;</span>f);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>exitæ—¶é‡Šæ”¾vmaçš„èµ„æº</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (; vma <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>vmas[NVMA<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]; vma<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (vma<span style="color:#f92672">-&gt;</span>len) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">vmaunmap</span>(p<span style="color:#f92672">-&gt;</span>pagetable, vma<span style="color:#f92672">-&gt;</span>addr, <span style="color:#a6e22e">PGROUNDUP</span>(vma<span style="color:#f92672">-&gt;</span>len) <span style="color:#f92672">/</span> PGSIZE, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fileclose</span>(vma<span style="color:#f92672">-&gt;</span>f);
</span></span><span style="display:flex;"><span>      vma<span style="color:#f92672">-&gt;</span>len <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿˜ä¼šæœ‰æ›´å¤šçš„ç»†èŠ‚ï¼Œnotesé‡Œä¹Ÿåšä¸åˆ°é¢é¢ä¿±åˆ°ï¼Œä¸Šæ‰‹è°ƒè¯•æ‰èƒ½æ„Ÿå—åˆ°&hellip;</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/os/">OS</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/lkl_uintr/">
    <span class="title">Â« Prev</span>
    <br>
    <span>Basic Mechanism of LKL and UINTR</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/hello-world/">
    <span class="title">Next Â»</span>
    <br>
    <span>Hello World</span>
  </a>
</nav>

  </footer>

<div class="giscus-comments">
    <script src="https://giscus.app/client.js"
        data-repo="Anekoique/anekoique.github.io"
        data-repo-id="R_kgDOPlBaDg"
        data-category="Announcements"
        data-category-id="DIC_kwDOPlBaDs4Cup3u"
        data-mapping="pathname"
        data-strict="false"
        data-reactions-enabled="true"
        data-emit-metadata="false"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
    </script>
</div>

<script>
let updateThemeTimeout;


function updateGiscusTheme() {
    const giscusFrame = document.querySelector('iframe.giscus-frame');
    if (!giscusFrame || !giscusFrame.contentWindow) return;
    
    
    const storedTheme = localStorage.getItem("pref-theme");
    const isDark = document.body.classList.contains('dark');
    
    let theme;
    if (storedTheme === 'auto' || !storedTheme) {
        theme = isDark ? 'dark' : 'light';
    } else if (isDark || storedTheme === 'dark') {
        theme = 'dark';
    } else {
        theme = 'light';
    }
    
    
    try {
        giscusFrame.contentWindow.postMessage({
            giscus: {
                setConfig: {
                    theme: theme
                }
            }
        }, 'https://giscus.app');
    } catch (error) {
        console.debug('Giscus theme update failed:', error);
    }
}


function debouncedUpdateTheme() {
    clearTimeout(updateThemeTimeout);
    updateThemeTimeout = setTimeout(updateGiscusTheme, 50);
}


function waitForGiscusAndUpdateTheme() {
    const checkGiscus = () => {
        const giscusFrame = document.querySelector('iframe.giscus-frame');
        if (giscusFrame && giscusFrame.contentWindow) {
            updateGiscusTheme();
        } else if (document.querySelector('.giscus-comments script')) {
            
            setTimeout(checkGiscus, 100);
        }
    };
    checkGiscus();
}


document.addEventListener('DOMContentLoaded', waitForGiscusAndUpdateTheme);


document.addEventListener('click', (e) => {
    if (e.target.closest('#theme-toggle')) {
        
        requestAnimationFrame(() => {
            requestAnimationFrame(updateGiscusTheme);
        });
    }
});


window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
    const storedTheme = localStorage.getItem("pref-theme");
    if (storedTheme === 'auto' || !storedTheme) {
        debouncedUpdateTheme();
    }
});


const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            debouncedUpdateTheme();
        }
    });
});

observer.observe(document.body, {
    attributes: true,
    attributeFilter: ['class']
});
</script>

</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Anekoique&#39;s Blog</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
